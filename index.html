<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏° (RS SAVE)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f2f5;
        }
        .auth-card {
            max-width: 450px;
            margin: 50px auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: none;
        }
        .main-container {
            max-width: 1000px;
            margin: 20px auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .table thead th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
        }
        .status-status-badge { font-size: 0.9em; }
        /* ‡∏ã‡πà‡∏≠‡∏ô Password - ‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô */
        .blur-pass { filter: blur(4px); transition: 0.3s; cursor: pointer; }
        .blur-pass:hover { filter: blur(0px); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary hidden" id="mainNavbar">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="bi bi-joystick"></i> <span id="navStoreName">Game Stock System</span></a>
    <button class="btn btn-outline-light btn-sm" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</nav>

<div class="container" id="auth-section">
    <div class="card auth-card p-4">
        <h3 class="text-center mb-4 text-primary fw-bold"><i class="bi bi-shield-lock"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h3>
        
        <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button" role="tab">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="pills-signup-tab" data-bs-toggle="pill" data-bs-target="#pills-signup" type="button" role="tab">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-login" role="tabpanel">
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="loginEmail" placeholder="name@example.com">
                    <label for="loginEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Password">
                    <label for="loginPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                </div>
                <button class="btn btn-primary w-100 py-2" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            
            <div class="tab-pane fade" id="pills-signup" role="tabpanel">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="signupStoreName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">
                    <label for="signupStoreName">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ä‡πà‡∏ô RedShop)</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="signupEmail" placeholder="name@example.com">
                    <label for="signupEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="signupPassword" placeholder="Password">
                    <label for="signupPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                </div>
                <button class="btn btn-success w-100 py-2" onclick="signup()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
</div>


<div class="main-container hidden" id="dashboard-section">
    
    <div class="accordion mb-4" id="accordionAddPanel">
        <div class="accordion-item border-0 shadow-sm">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-light text-primary fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddItem">
                    <i class="bi bi-plus-circle-fill me-2"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
                </button>
            </h2>
            <div id="collapseAddItem" class="accordion-collapse collapse" data-bs-parent="#accordionAddPanel">
                <div class="accordion-body bg-white">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</label>
                            <div class="input-group">
                                <span class="input-group-text">‡∏ø</span>
                                <input type="number" id="buyPrice" class="form-control" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-success fw-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏¢</label>
                            <div class="input-group">
                                <span class="input-group-text bg-success text-white">‡∏ø</span>
                                <input type="number" id="sellPrice" class="form-control border-success" placeholder="0">
                            </div>
                        </div>
                        <div class="col-12"><hr class="my-2"></div>
                        <div class="col-md-4">
                            <input type="text" id="gamePhone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/Username">
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="gameEmail" class="form-control" placeholder="Email ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£">
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="gamePass" class="form-control" placeholder="Password ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£">
                        </div>
                        <div class="col-12 mt-3">
                            <button onclick="addItem()" class="btn btn-primary w-100"><i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs nav-fill mb-3" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock-tab-pane" type="button" role="tab"><i class="bi bi-box-seam"></i> ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold text-secondary" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-tab-pane" type="button" role="tab"><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="stock-tab-pane" role="tabpanel">
             <div class="input-group mb-3 shadow-sm">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏° (‡πÄ‡∏ä‡πà‡∏ô RD001)..." onkeyup="searchTable()">
            </div>
            
            <div class="table-responsive rounded shadow-sm">
                <table class="table table-hover align-middle mb-0" id="stockTable">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™ (ID)</th>
                            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                            <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏´‡∏±‡∏™)</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="history-tab-pane" role="tabpanel">
             <div class="table-responsive rounded shadow-sm">
                <table class="table table-hover align-middle mb-0" id="historyTable">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™</th>
                            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                            <th>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>
    
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage"> Let's go! </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // --- CONFIG ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ---
  const firebaseConfig = {
    apiKey: "AIzaSyC-rPvq9fFvhnYQCWxKtLf4Y3UK1uMnP0c",
    authDomain: "rssave-6169a.firebaseapp.com",
    projectId: "rssave-6169a",
    storageBucket: "rssave-6169a.firebasestorage.app",
    messagingSenderId: "619695253658",
    appId: "1:619695253658:web:2d1e3ccb1d5a3c08491723",
    measurementId: "G-1KHNKSTELW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ
  const showToast = (message, type = 'success') => {
      const toastEl = document.getElementById('liveToast');
      const toastBody = document.getElementById('toastMessage');
      toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
      toastBody.innerText = message;
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
  }

  let currentStorePrefix = "RD"; 

  // --- Functions Authentication ---
  window.signup = async () => {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const store = document.getElementById('signupStoreName').value;
      
      if(!store || !email || !password) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", 'danger');
      
      try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const prefix = store.substring(0, 2).toUpperCase();
          localStorage.setItem('storePrefix', prefix); 
          localStorage.setItem('storeNameFull', store);
          showToast("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...");
      } catch (error) { showToast(error.message, 'danger'); }
  }

  window.login = async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
       if(!email || !password) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", 'danger');
      try {
          await signInWithEmailAndPassword(auth, email, password);
      } catch (error) { showToast("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", 'danger'); }
  }

  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
      const authSection = document.getElementById('auth-section');
      const dashboardSection = document.getElementById('dashboard-section');
      const mainNavbar = document.getElementById('mainNavbar');

      if (user) {
          authSection.classList.add('hidden');
          dashboardSection.classList.remove('hidden');
          mainNavbar.classList.remove('hidden');
          
          const storeName = localStorage.getItem('storeNameFull') || 'Shop Admin';
          document.getElementById('navStoreName').innerText = storeName;
          currentStorePrefix = localStorage.getItem('storePrefix') || "RD";

          loadInventory();
          loadHistory();
      } else {
          authSection.classList.remove('hidden');
          dashboardSection.classList.add('hidden');
          mainNavbar.classList.add('hidden');
      }
  });

  // --- Functions ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å ---
  
  async function generateAutoID() {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const q = query(collection(db, "products"), orderBy("createdAt", "desc"), limit(1));
      const querySnapshot = await getDocs(q);
      let newIdNumber = 1;
      if (!querySnapshot.empty) {
          const lastDoc = querySnapshot.docs[0].data();
          const lastCode = lastDoc.code; 
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Prefix
          if(lastCode && lastCode.startsWith(currentStorePrefix)) {
               const lastNum = parseInt(lastCode.replace(currentStorePrefix, ""));
               if(!isNaN(lastNum)) newIdNumber = lastNum + 1;
          }
      }
      return currentStorePrefix + String(newIdNumber).padStart(3, '0');
  }

  window.addItem = async () => {
      const buyPrice = document.getElementById('buyPrice').value;
      const sellPrice = document.getElementById('sellPrice').value;
      const phone = document.getElementById('gamePhone').value;
      const email = document.getElementById('gameEmail').value;
      const pass = document.getElementById('gamePass').value;

      if(!buyPrice || !sellPrice) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤", 'warning');

      const newCode = await generateAutoID(); 

      try {
          await addDoc(collection(db, "products"), {
              code: newCode,
              buyPrice: Number(buyPrice),
              sellPrice: Number(sellPrice),
              gamePhone: phone,
              gameEmail: email,
              gamePassword: pass,
              status: "available",
              createdAt: Timestamp.now(),
              soldAt: null
          });
          
          showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™ ${newCode} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
          
          // Reset ‡∏ü‡∏≠‡∏£‡πå‡∏°
          document.getElementById('buyPrice').value = '';
          document.getElementById('sellPrice').value = '';
          document.getElementById('gamePhone').value = '';
          document.getElementById('gameEmail').value = '';
          document.getElementById('gamePass').value = '';
          new bootstrap.Collapse(document.getElementById('collapseAddItem')).hide();

          loadInventory();
      } catch (e) {
          showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message, 'danger');
          console.error(e);
      }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  async function loadInventory() {
      const q = query(collection(db, "products"), where("status", "==", "available"), orderBy("createdAt", "desc"));
      const querySnapshot = await getDocs(q);
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = "";

      if (querySnapshot.empty) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</td></tr>`;
          return;
      }

      querySnapshot.forEach((docSnap) => {
          const item = docSnap.data();
          const row = `
              <tr>
                  <td><span class="badge bg-primary" style="font-size:1em;">${item.code}</span></td>
                  <td class="fw-bold text-success">${item.sellPrice.toLocaleString()} ‡∏ø</td>
                  <td>
                    <small class="text-muted">Email:</small> ${item.gameEmail || '-'}<br>
                    <small class="text-muted">Pass:</small> <span class="blur-pass bg-light px-2 rounded">${item.gamePassword || '****'}</span>
                  </td>
                  <td><button class="btn btn-warning btn-sm text-dark fw-bold" onclick="markAsSold('${docSnap.id}')"><i class="bi bi-currency-dollar"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</button></td>
              </tr>
          `;
          tbody.innerHTML += row;
      });
  }

  // ‡∏Å‡∏î‡∏Ç‡∏≤‡∏¢
  window.markAsSold = async (docId) => {
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;
      
      try {
        const docRef = doc(db, "products", docId);
        await updateDoc(docRef, {
            status: "sold",
            soldAt: Timestamp.now()
        });
        showToast("üí∞ ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!", 'success');
        loadInventory(); 
        loadHistory();   
      } catch(e) {
         showToast("Error: " + e.message, 'danger');
      }
  }

  // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
  async function loadHistory() {
      const q = query(collection(db, "products"), where("status", "==", "sold"), orderBy("soldAt", "desc"));
      const querySnapshot = await getDocs(q);
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";

      if (querySnapshot.empty) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td></tr>`;
          return;
      }

      querySnapshot.forEach((docSnap) => {
          const item = docSnap.data();
          const profit = item.sellPrice - item.buyPrice;
          const profitClass = profit > 0 ? 'text-success' : (profit < 0 ? 'text-danger' : 'text-muted');
          const profitIcon = profit > 0 ? 'üìà' : (profit < 0 ? 'üìâ' : '');
          
          let dateStr = "-";
          if(item.soldAt) {
              dateStr = item.soldAt.toDate().toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'});
          }

          const row = `
              <tr>
                  <td><span class="text-secondary fw-bold">${item.code}</span></td>
                  <td>${item.sellPrice.toLocaleString()} ‡∏ø</td>
                  <td class="${profitClass} fw-bold">${profitIcon} ${profit.toLocaleString()} ‡∏ø</td>
                  <td><small>${dateStr}</small></td>
              </tr>
          `;
          tbody.innerHTML += row;
      });
  }
  
  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  window.searchTable = () => {
      const input = document.getElementById("searchInput");
      const filter = input.value.toUpperCase();
      const table = document.getElementById("stockTable");
      const tr = table.getElementsByTagName("tr");

      for (let i = 1; i < tr.length; i++) { 
          const td = tr[i].getElementsByTagName("td")[0]; 
          if (td) {
              const txtValue = td.textContent || td.innerText;
              if (txtValue.toUpperCase().indexOf(filter) > -1) {
                  tr[i].style.display = "";
              } else {
                  tr[i].style.display = "none";
              }
          }       
      }
  }
</script>

</body>
</html>
