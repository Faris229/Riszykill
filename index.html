<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏° (Modern UI Deluxe)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root { --primary-color: #4361ee; --secondary-color: #3f37c9; }
        body { font-family: 'Prompt', sans-serif; background-color: #f8f9fa; color: #333; }
        
        /* UI Modern Elements */
        .main-card { border: none; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); background: white; overflow: hidden; }
        .auth-box { max-width: 420px; margin: 80px auto; }
        .btn-gradient-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); border: none; color: white; }
        .btn-gradient-primary:hover { background: linear-gradient(45deg, var(--secondary-color), var(--primary-color)); color: white; box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3); }
        .form-control:focus { box-shadow: none; border-color: var(--primary-color); }
        
        /* Image & Table */
        .img-preview-box { width: 100%; height: 220px; border-radius: 12px; border: 2px dashed #dee2e6; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; background: #f8f9fa; transition: 0.3s; }
        .img-preview-box:hover { border-color: var(--primary-color); background: #eef2ff; }
        .img-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        .table-img { width: 70px; height: 70px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s; cursor: zoom-in; }
        .table-img:hover { transform: scale(1.1); }
        .blur-text { filter: blur(6px); transition: 0.4s; cursor: pointer; user-select: none; background: #eee; padding: 2px 8px; border-radius: 4px; }
        .blur-text:hover { filter: blur(0px); background: transparent; }

        /* Navbar */
        .navbar { background: white; box-shadow: 0 2px 15px rgba(0,0,0,0.05) !important; padding-top: 1rem; padding-bottom: 1rem; }
        .navbar-brand { font-weight: 800; color: var(--primary-color) !important; letter-spacing: -1px; }
        .nav-pills .nav-link.active { background-color: var(--primary-color); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top hidden" id="mainNavbar">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="bi bi-joystick me-2"></i><span id="navStoreName">RS SHOP</span></a>
    
    <div class="dropdown ms-auto">
        <button class="btn btn-light dropdown-toggle shadow-sm d-flex align-items-center gap-2 rounded-pill px-3" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle fs-5 text-primary"></i>
            <span id="userEmailDisplay" class="d-none d-md-block fw-medium small">User</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-4 mt-2">
            <li><h6 class="dropdown-header">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h6></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger rounded-3 fw-bold" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
        </ul>
    </div>
  </div>
</nav>

<div class="container" id="auth-section" style="padding-top: 60px;">
    <div class="card auth-box p-4 main-card">
        <div class="text-center mb-4">
            <h2 class="fw-bold" style="color: var(--primary-color);"><i class="bi bi-shield-lock-fill"></i> Admin Panel</h2>
            <p class="text-muted mb-0">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</p>
        </div>

        <ul class="nav nav-pills nav-fill mb-4 bg-light rounded-pill p-1" id="authTab" role="tablist">
            <li class="nav-item"><button class="nav-link active rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#login-tab">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></li>
            <li class="nav-item"><button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#signup-tab">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="login-tab">
                <div class="form-floating mb-3">
                    <input type="email" class="form-control rounded-4" id="loginEmail" placeholder="Email">
                    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                </div>
                <div class="form-floating mb-4">
                    <input type="password" class="form-control rounded-4" id="loginPassword" placeholder="Password">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                </div>
                <button class="btn btn-gradient-primary w-100 py-3 rounded-4 fw-bold fs-5" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö <i class="bi bi-arrow-right"></i></button>
            </div>
            
            <div class="tab-pane fade" id="signup-tab">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control rounded-4" id="signupStore" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô RS Store)</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control rounded-4" id="signupEmail" placeholder="Email">
                    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                </div>
                <div class="form-floating mb-4">
                    <input type="password" class="form-control rounded-4" id="signupPassword" placeholder="Password">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                </div>
                <button class="btn btn-success w-100 py-3 rounded-4 fw-bold fs-5" onclick="signup()"><i class="bi bi-check-circle-fill me-2"></i> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="container hidden" id="dashboard-section" style="padding-top: 100px; padding-bottom: 40px;">
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
             <h3 class="fw-bold m-0 text-dark"><i class="bi bi-grid-fill text-primary me-2"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
             <p class="text-muted m-0 small">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
       
        <button class="btn btn-gradient-primary px-4 py-2 rounded-pill shadow-sm fw-bold" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏î‡∏µ‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>

    <div class="card main-card p-2 mb-4 bg-white d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <ul class="nav nav-pills p-1 rounded-pill bg-light" id="dashTab">
            <li class="nav-item">
                <button class="nav-link active rounded-pill fw-bold px-4" data-bs-toggle="tab" data-bs-target="#stock-pane">
                    üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill fw-bold px-4 text-secondary" data-bs-toggle="tab" data-bs-target="#history-pane">
                    üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                </button>
            </li>
        </ul>
        <div class="input-group w-auto" style="min-width: 300px;">
            <span class="input-group-text bg-light border-0 ps-3 rounded-start-pill"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="searchInput" class="form-control border-0 bg-light rounded-end-pill" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°..." onkeyup="searchTable('stockTable')">
        </div>
    </div>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="stock-pane">
            <div class="card main-card overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="stockTable">
                        <thead style="background: #f1f5f9;">
                            <tr>
                                <th class="py-3 ps-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏£‡∏´‡∏±‡∏™ & ‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)</th>
                                <th class="text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="history-pane">
            <div class="card main-card overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="historyTable">
                        <thead style="background: #f1f5f9;">
                            <tr>
                                <th class="py-3 ps-4">‡∏£‡∏´‡∏±‡∏™</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addItemModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0 ps-4 pt-4">
                <h5 class="modal-title fw-bold fs-4"><i class="bi bi-folder-plus me-2 text-primary"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°</h5>
                <button type="button" class="btn-close bg-light rounded-circle p-2" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-lg-5">
                        <label class="form-label fw-bold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å</label>
                        <label for="inpFile" class="img-preview-box" id="dropZone">
                            <div class="text-center text-muted p-3" id="uploadPlaceholder">
                                <i class="bi bi-cloud-arrow-up-fill fs-1 text-primary opacity-50"></i>
                                <p class="mb-0 mt-2 fw-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                                <small>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</small>
                            </div>
                             <img id="previewImg" class="img-preview">
                        </label>
                        <input type="file" id="inpFile" accept="image/*" class="d-none" onchange="previewImage()">
                    </div>
                    
                    <div class="col-lg-7">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ó‡∏∏‡∏ô)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0">‡∏ø</span>
                                    <input type="number" id="inpBuy" class="form-control bg-light border-start-0 fw-medium" placeholder="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-success">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤)</label>
                                <div class="input-group">
                                     <span class="input-group-text bg-success text-white border-end-0">‡∏ø</span>
                                    <input type="number" id="inpSell" class="form-control border-success text-success fw-bold" placeholder="0">
                                </div>
                            </div>
                            
                            <div class="col-12"><hr class="my-2 text-muted opacity-25"></div>
                            
                            <div class="col-md-12">
                                <label class="form-label fw-bold small">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏Å‡∏° (Email)</label>
                                <input type="text" id="inpGameEmail" class="form-control" placeholder="example@gmail.com">
                            </div>
                             <div class="col-md-6">
                                <label class="form-label fw-bold small">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ / Username</label>
                                <input type="text" id="inpUser" class="form-control" placeholder="Optional">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-danger">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏° (Password)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-danger-subtle text-danger border-end-0"><i class="bi bi-key-fill"></i></span>
                                     <input type="text" id="inpGamePass" class="form-control border-danger-subtle" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                                </div>
                               
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 ps-4 pe-4 pb-4">
                <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-gradient-primary rounded-pill px-5 py-2 fw-bold shadow-sm" onclick="saveItem()">
                    <i class="bi bi-save2-fill me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1070;">
  <div id="msgToast" class="toast align-items-center text-white bg-success border-0 shadow-lg rounded-4" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex p-2">
      <div class="toast-body fs-6 fw-medium" id="toastBody">Let's go!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // --- ‚öôÔ∏è CONFIG ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
  const firebaseConfig = {
    apiKey: "AIzaSyC-rPvq9fFvhnYQCWxKtLf4Y3UK1uMnP0c",
    authDomain: "rssave-6169a.firebaseapp.com",
    projectId: "rssave-6169a",
    storageBucket: "rssave-6169a.firebasestorage.app",
    messagingSenderId: "619695253658",
    appId: "1:619695253658:web:2d1e3ccb1d5a3c08491723",
    measurementId: "G-1KHNKSTELW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUserData = { storePrefix: 'RS', storeName: 'My Shop' };
  let currentImageBase64 = "";

  // --- Helper Functions ---
  const showToast = (msg, type='success') => {
      const el = document.getElementById('msgToast');
      const icon = type === 'success' ? '<i class="bi bi-check-circle-fill me-2"></i>' : '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
      document.getElementById('toastBody').innerHTML = icon + msg;
      el.className = `toast align-items-center text-white bg-${type} border-0 shadow-lg rounded-4`;
      new bootstrap.Toast(el).show();
  }

  window.previewImage = () => {
      const file = document.getElementById('inpFile').files[0];
      if(file){
          const reader = new FileReader();
          reader.onloadend = () => {
              const img = new Image();
              img.src = reader.result;
              img.onload = () => {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  const maxWidth = 600; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
                  const scaleSize = maxWidth / img.width;
                  canvas.width = maxWidth;
                  canvas.height = img.height * scaleSize;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  currentImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                  
                  document.getElementById('uploadPlaceholder').style.display = 'none';
                  const preview = document.getElementById('previewImg');
                  preview.src = currentImageBase64;
                  preview.style.display = 'block';
              }
          }
          reader.readAsDataURL(file);
      }
  }
  
  // Reset Modal form when closed
  document.getElementById('addItemModal').addEventListener('hidden.bs.modal', () => {
      document.getElementById('inpBuy').value = '';
      document.getElementById('inpSell').value = '';
      document.getElementById('inpUser').value = '';
      document.getElementById('inpGameEmail').value = '';
      document.getElementById('inpGamePass').value = '';
      document.getElementById('inpFile').value = '';
      document.getElementById('uploadPlaceholder').style.display = 'block';
      document.getElementById('previewImg').style.display = 'none';
      currentImageBase64 = "";
  });


  // --- AUTH SYSTEM ---
  window.signup = async () => {
      const email = document.getElementById('signupEmail').value;
      const pass = document.getElementById('signupPassword').value;
      const store = document.getElementById('signupStore').value;
      if(!email || !pass || !store) return showToast("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "danger");
      
      try {
          await createUserWithEmailAndPassword(auth, email, pass);
          localStorage.setItem('storePrefix', store.substring(0, 2).toUpperCase());
          localStorage.setItem('storeName', store);
          showToast("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...");
      } catch(e) { showToast(e.message, "danger"); }
  }

  window.login = async () => {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      try {
          await signInWithEmailAndPassword(auth, email, pass);
      } catch(e) { showToast("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "danger"); }
  }

  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
      const authSec = document.getElementById('auth-section');
      const dashSec = document.getElementById('dashboard-section');
      const nav = document.getElementById('mainNavbar');
      
      if(user) {
          authSec.classList.add('d-none');
          dashSec.classList.remove('hidden');
          nav.classList.remove('hidden');
          
          currentUserData.storeName = localStorage.getItem('storeName') || 'Shop Admin';
          currentUserData.storePrefix = localStorage.getItem('storePrefix') || 'RS';
          
          document.getElementById('navStoreName').innerText = currentUserData.storeName;
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Dropdown
          document.getElementById('userEmailDisplay').innerText = user.email.split('@')[0];
          
          loadInventory();
          loadHistory();
      } else {
          authSec.classList.remove('d-none');
          dashSec.classList.add('hidden');
          nav.classList.add('hidden');
      }
  });

  // --- LOGIC: CREATE ---
  async function generateAutoID() {
      // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ orderBy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const q = query(collection(db, "products"), orderBy("createdAt", "desc"), limit(1));
      const snap = await getDocs(q);
      let newNum = 1;
      if(!snap.empty) {
          const lastCode = snap.docs[0].data().code;
          if(lastCode.startsWith(currentUserData.storePrefix)) {
              const numPart = parseInt(lastCode.replace(currentUserData.storePrefix, ""));
              if(!isNaN(numPart)) newNum = numPart + 1;
          }
      }
      return currentUserData.storePrefix + String(newNum).padStart(3, '0');
  }

  window.saveItem = async () => {
      const buy = document.getElementById('inpBuy').value;
      const sell = document.getElementById('inpSell').value;
      const user = document.getElementById('inpUser').value;
      const email = document.getElementById('inpGameEmail').value;
      const pass = document.getElementById('inpGamePass').value;

      if(!buy || !sell) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "warning");
      if(!email || !pass) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏°", "warning");

      const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
      modal.hide();
      showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", "info");

      try {
          const newCode = await generateAutoID();
          await addDoc(collection(db, "products"), {
              code: newCode,
              buyPrice: Number(buy),
              sellPrice: Number(sell),
              gameUser: user || "-",
              gameEmail: email,
              gamePass: pass,
              imageUrl: currentImageBase64 || "https://via.placeholder.com/150?text=No+Image",
              status: "available",
              createdAt: Timestamp.now(),
              soldAt: null
          });
          
          showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™ ${newCode} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
          loadInventory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

      } catch(e) { showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message, "danger"); }
  }

  // --- LOGIC: READ & DISPLAY (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!) ---
  async function loadInventory() {
      // üî• ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å: ‡∏•‡∏ö orderBy("createdAt", "desc") ‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Index
      const q = query(collection(db, "products"), where("status", "==", "available"));
      
      const snap = await getDocs(q);
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = "";

      if(snap.empty) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted fs-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</td></tr>`; return; }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô JS ‡πÅ‡∏ó‡∏ô (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
      let docs = [];
      snap.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
      docs.sort((a,b) => b.createdAt - a.createdAt); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤

      docs.forEach(d => {
          const tr = `
              <tr>
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center">
                        <img src="${d.imageUrl}" class="table-img shadow-sm me-3" onclick="viewImage('${d.imageUrl}')">
                    </div>
                  </td>
                  <td>
                    <div class="d-flex flex-column">
                        <span class="badge bg-primary bg-opacity-10 text-primary mb-1" style="width:fit-content">${d.code}</span>
                        <span class="fw-bold text-success fs-5">${d.sellPrice.toLocaleString()} ‡∏ø</span>
                    </div>
                  </td>
                  <td>
                      <div class="d-flex flex-column gap-1" style="max-width: 200px;">
                        <small class="text-muted d-flex align-items-center"><i class="bi bi-envelope-fill me-2 opacity-50"></i> <span class="text-truncate">${d.gameEmail}</span></small>
                        <small class="text-muted d-flex align-items-center"><i class="bi bi-key-fill me-2 opacity-50"></i> <span class="blur-text fw-medium text-dark bg-white border">${d.gamePass}</span></small>
                      </div>
                  </td>
                  <td class="text-end pe-4">
                      <button class="btn btn-warning btn-sm fw-bold shadow-sm rounded-pill px-3 py-2 text-dark" onclick="markSold('${d.id}')">
                          <i class="bi bi-bag-check-fill me-1"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢
                      </button>
                  </td>
              </tr>
          `;
          tbody.innerHTML += tr;
      });
  }

  async function loadHistory() {
      // üî• ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å: ‡∏ó‡∏≥‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      const q = query(collection(db, "products"), where("status", "==", "sold"));
      const snap = await getDocs(q);
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";

      if(snap.empty) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted fs-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td></tr>`; return; }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô JS ‡πÅ‡∏ó‡∏ô
      let docs = [];
      snap.forEach(doc => docs.push(doc.data()));
      docs.sort((a,b) => b.soldAt - a.soldAt);

      docs.forEach(d => {
          const profit = d.sellPrice - d.buyPrice;
          const profitColor = profit >= 0 ? 'text-success' : 'text-danger';
          const profitSign = profit >= 0 ? '+' : '';
          
          let dateTxt = "-";
          if(d.soldAt) {
             const dt = d.soldAt.toDate();
             dateTxt = dt.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit'});
          }

          const tr = `
              <tr>
                  <td class="ps-4 py-3"><span class="fw-bold text-secondary">${d.code}</span></td>
                  <td>${d.sellPrice.toLocaleString()} ‡∏ø</td>
                  <td><span class="${profitColor} fw-bold badge bg-${profit >= 0 ? 'success' : 'danger'}-subtle px-3 py-2 rounded-pill" style="font-size:0.9em">${profitSign}${profit.toLocaleString()} ‡∏ø</span></td>
                  <td><small class="text-muted fw-medium">${dateTxt}</small></td>
              </tr>
          `;
          tbody.innerHTML += tr;
      });
  }

  // --- LOGIC: UPDATE ---
  window.markSold = async (id) => {
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
      try {
          await updateDoc(doc(db, "products", id), {
              status: "sold",
              soldAt: Timestamp.now()
          });
          showToast("üí∞ ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!", "success");
          loadInventory();
          loadHistory();
      } catch(e) { showToast(e.message, "danger"); }
  }

  // --- EXTRA ---
  window.searchTable = (tableId) => {
      const val = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => {
          r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
      });
  }
  
  window.viewImage = (url) => { window.open(url, '_blank'); }

  document.querySelector('.hidden').style.display = 'none';
</script>

<style>
    .hidden { display: none !important; }
</style>

</body>
</html>
