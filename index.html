<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lucky Wheel - ‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background: #0f172a; color: white; overflow-x: hidden; }
        .wheel-container { position: relative; width: 350px; height: 350px; margin: 0 auto; }
        #canvas { width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 50px; background: #ef4444; clip-path: polygon(100% 0, 50% 100%, 0 0);
            z-index: 10; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        .glow { box-shadow: 0 0 50px rgba(139, 92, 246, 0.3); border-radius: 50%; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10">

    <div class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 drop-shadow-lg">LUCKY WHEEL</h1>
        <p class="text-slate-400 mt-2">‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏ç‡πà!</p>
    </div>

    <div class="wheel-container glow mb-8">
        <div class="pointer"></div>
        <canvas id="canvas" width="500" height="500"></canvas>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-xl border-4 border-slate-200 z-10">
            <span class="text-slate-800 font-bold text-xs uppercase">Spin</span>
        </div>
    </div>

    <div class="w-full max-w-md px-6">
        <div class="glass p-6 rounded-2xl shadow-xl">
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Code (‡∏£‡∏´‡∏±‡∏™‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å)</label>
                <input id="input-code" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." class="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-center text-lg font-bold tracking-widest focus:outline-none focus:border-purple-500 transition">
            </div>
            <button onclick="spin()" id="btn-spin" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 text-xl">
                ‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠!
            </button>
        </div>

        <div class="mt-8">
            <h3 class="font-bold text-slate-400 mb-3 text-center"><i class="fa-solid fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="history-list" class="space-y-2 text-sm opacity-80">
                </div>
        </div>
    </div>

    <script>
        // CONFIG (‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables
        let prizes = [];
        let startAngle = 0;
        let arc = 0;
        let spinTimeout = null;
        let spinArcStart = 10;
        let spinTime = 0;
        let spinTimeTotal = 0;
        let ctx;
        let isSpinning = false;

        // Init
        document.addEventListener("DOMContentLoaded", () => {
            initWheel();
            loadHistory();
        });

        // 1. Fetch Data & Draw Wheel
        function initWheel() {
            const canvas = document.getElementById("canvas");
            if(!canvas) return;
            ctx = canvas.getContext("2d");

            db.collection('wheel_prizes').orderBy('createdAt', 'asc').onSnapshot(snap => {
                prizes = [];
                snap.forEach(doc => prizes.push({id: doc.id, ...doc.data()}));
                if(prizes.length > 0) {
                    arc = Math.PI * 2 / prizes.length;
                    drawWheel();
                }
            });
        }

        function drawWheel() {
            if (!ctx) return;
            ctx.clearRect(0, 0, 500, 500);
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth = 2;
            ctx.font = 'bold 18px Kanit'; // Font size inside wheel

            const outsideRadius = 240;
            const textRadius = 170;
            const insideRadius = 50;

            for(let i = 0; i < prizes.length; i++) {
                const angle = startAngle + i * arc;
                ctx.fillStyle = prizes[i].color || getColor(i, prizes.length);
                
                ctx.beginPath();
                ctx.arc(250, 250, outsideRadius, angle, angle + arc, false);
                ctx.arc(250, 250, insideRadius, angle + arc, angle, true);
                ctx.stroke();
                ctx.fill();

                ctx.save();
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 4;
                ctx.fillStyle = "white";
                ctx.translate(250 + Math.cos(angle + arc / 2) * textRadius, 250 + Math.sin(angle + arc / 2) * textRadius);
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                const text = prizes[i].name;
                ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
                ctx.restore();
            }
        }

        // 2. Spin Logic
        async function spin() {
            if(isSpinning) return;
            
            const codeInput = document.getElementById('input-code');
            const codeVal = codeInput.value.trim();

            if(!codeVal) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î', 'warning');

            // Check Code in Database
            const codeRef = db.collection('wheel_codes').where('code', '==', codeVal).where('status', '==', 'unused').limit(1);
            const snapshot = await codeRef.get();

            if(snapshot.empty) {
                return Swal.fire('‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢', '‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
            }

            // Valid Code -> Start Spin
            isSpinning = true;
            document.getElementById('btn-spin').disabled = true;
            document.getElementById('btn-spin').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏°‡∏∏‡∏ô...";
            
            // Mark code as used immediately (prevent double use)
            const codeDoc = snapshot.docs[0];
            await db.collection('wheel_codes').doc(codeDoc.id).update({
                status: 'used',
                usedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Randomize Logic (Simple Client Side)
            // Note: For production, determine result in Cloud Function for security
            spinAngleStart = Math.random() * 10 + 10;
            spinTime = 0;
            spinTimeTotal = Math.random() * 3000 + 4000; // 4-7 seconds
            rotateWheel();
        }

        function rotateWheel() {
            spinTime += 30;
            if(spinTime >= spinTimeTotal) {
                stopRotateWheel();
                return;
            }
            // Easing function for smooth stop
            const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
            startAngle += (spinAngle * Math.PI / 180);
            drawWheel();
            spinTimeout = setTimeout('rotateWheel()', 30);
        }

        function stopRotateWheel() {
            clearTimeout(spinTimeout);
            const degrees = startAngle * 180 / Math.PI + 90;
            const arcd = arc * 180 / Math.PI;
            const index = Math.floor((360 - degrees % 360) / arcd);
            
            ctx.save();
            ctx.font = 'bold 30px Kanit';
            const text = prizes[index].name;
            ctx.restore();

            // Show Result
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            Swal.fire({
                title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!',
                text: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${text}`,
                icon: 'success',
                confirmButtonText: '‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•',
                backdrop: `rgba(0,0,123,0.4) url("https://media.giphy.com/media/26tOZ42Mg6pbTUPvy/giphy.gif") left top no-repeat`
            }).then(() => {
                isSpinning = false;
                document.getElementById('btn-spin').disabled = false;
                document.getElementById('btn-spin').innerText = "‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠!";
                document.getElementById('input-code').value = '';
                
                // Save History
                db.collection('wheel_history').add({
                    prize: text,
                    code: document.getElementById('input-code').value || 'Code',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        }

        // Helper: Easing
        function easeOut(t, b, c, d) {
            t /= d;
            t--;
            return c * (t*t*t + 1) + b;
        }

        // Helper: Colors
        function getColor(i, total) {
            const colors = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];
            return colors[i % colors.length];
        }

        function loadHistory() {
            db.collection('wheel_history').orderBy('timestamp', 'desc').limit(5).onSnapshot(snap => {
                const div = document.getElementById('history-list');
                div.innerHTML = snap.docs.map(d => 
                    `<div class="bg-slate-800 p-3 rounded-lg flex justify-between items-center border border-slate-700">
                        <span class="text-purple-400 font-bold">üéâ ${d.data().prize}</span>
                        <span class="text-xs text-slate-500">‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÅ‡∏ï‡∏Å!</span>
                    </div>`
                ).join('');
            });
        }
    </script>
</body>
</html>
