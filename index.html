<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>จองคิวออนไลน์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #1e293b; padding-bottom: 50px; }
        .glass-card { background: rgba(255, 255, 255, 0.98); border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.08); }
        .btn-gradient { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; transition: 0.2s; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }
        .btn-gradient:active { transform: scale(0.97); }
        
        /* Status Badges */
        .badge-status { padding: 4px 12px; border-radius: 50px; font-weight: bold; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 6px; }
        .st-wait { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .st-call { background: #ecfdf5; color: #059669; border: 1px solid #86efac; animation: pulse 1.5s infinite; }
        
        /* Marquee */
        .marquee-bar { background: #0f172a; color: #fff; position: fixed; top: 0; width: 100%; z-index: 50; height: 40px; display: flex; align-items: center; overflow: hidden; }
        .marquee-content { white-space: nowrap; animation: marquee 25s linear infinite; padding-left: 100%; font-size: 0.9rem; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col pt-16 px-4">

    <div id="ann-bar" class="marquee-bar hidden">
        <div class="bg-blue-600 h-full px-4 flex items-center font-bold z-10 text-xs shadow-lg"><i class="fa-solid fa-bullhorn mr-2"></i> ประกาศ</div>
        <div id="ann-text" class="marquee-content py-2">...</div>
    </div>

    <header class="mb-6 flex justify-between items-end max-w-md mx-auto w-full">
        <div>
            <h1 class="font-bold text-2xl text-slate-800 leading-none" id="shop-name">Loading...</h1>
            <div id="shop-badge" class="mt-2 inline-flex items-center gap-2 px-3 py-1 bg-white rounded-full text-xs font-bold shadow-sm border">Loading...</div>
        </div>
        <div class="text-right">
            <div class="text-xs text-slate-400 font-bold uppercase mb-1">คิวปัจจุบัน</div>
            <div class="text-4xl font-black text-slate-800 leading-none tracking-tight" id="current-q">---</div>
        </div>
    </header>

    <main class="flex-1 max-w-md mx-auto w-full flex flex-col justify-start relative">
        
        <div id="form-section" class="glass-card p-6 animate__animated animate__fadeInUp">
            <div class="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="fa-solid fa-ticket text-lg"></i></div>
                <h3 class="font-bold text-xl text-slate-700">รับบัตรคิวใหม่</h3>
            </div>
            <form onsubmit="App.book(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ชื่อลูกค้า</label>
                    <input id="inp-name" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 transition" placeholder="ระบุชื่อของคุณ" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">เบอร์โทรศัพท์</label>
                    <input id="inp-phone" type="tel" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-blue-500 transition" placeholder="0xx-xxx-xxxx">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">จำนวนคน</label>
                        <select id="inp-pax" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl font-medium"><option value="1">1 ท่าน</option><option value="2">2 ท่าน</option><option value="3">3 ท่าน</option><option value="4+">4+ ท่าน</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">เวลาถึงร้าน</label>
                        <input id="inp-time" type="time" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl font-bold text-blue-600 text-center" required>
                    </div>
                </div>
                <button id="btn-book" class="btn-gradient w-full py-4 rounded-xl font-bold text-lg shadow-lg mt-4 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check-circle"></i> กดรับบัตรคิว
                </button>
            </form>
        </div>

        <div id="ticket-section" class="hidden animate__animated animate__zoomIn">
            <div class="glass-card overflow-hidden relative">
                <div class="h-2 w-full bg-gradient-to-r from-blue-500 via-blue-600 to-blue-500"></div>
                
                <div class="p-8 text-center">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">หมายเลขคิวของคุณ</div>
                    <div id="my-q-num" class="text-7xl font-black text-slate-800 mb-2 tracking-tighter drop-shadow-sm">---</div>
                    
                    <div id="queue-ahead-box" class="inline-block bg-orange-50 border border-orange-100 px-4 py-2 rounded-lg mb-6">
                        <span class="text-xs font-bold text-orange-600 flex items-center gap-2">
                            <i class="fa-solid fa-hourglass-half"></i> มีคิวรอก่อนหน้าคุณ <span id="ahead-count" class="text-lg text-orange-700">0</span> คิว
                        </span>
                    </div>

                    <div class="flex justify-between items-center border-t border-b border-slate-100 py-4 mb-6">
                        <div class="text-left">
                            <div class="text-xs text-slate-400">ชื่อลูกค้า</div>
                            <div class="font-bold text-slate-700 text-lg" id="my-name">...</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400">สถานะ</div>
                            <div id="my-status" class="badge-status st-wait">WAITING</div>
                        </div>
                    </div>

                    <div id="custom-status-box" class="hidden mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                        <div class="text-xs font-bold text-blue-400 uppercase mb-1">สถานะปัจจุบัน</div>
                        <div id="custom-status-text" class="text-2xl font-bold text-blue-600 animate__animated">...</div>
                    </div>

                    <button onclick="App.testSound()" class="w-full py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition mb-3 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-volume-high text-blue-500"></i> ทดสอบเสียงเรียก
                    </button>
                    <button onclick="App.cancel()" class="text-sm text-red-400 font-medium hover:text-red-600 underline">ยกเลิกคิว</button>
                </div>
            </div>
        </div>

        <div id="msg-section" class="hidden text-center animate__animated animate__fadeInUp p-6">
            <div id="msg-bg" class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                <i id="msg-icon" class="text-4xl"></i>
            </div>
            <h2 id="msg-title" class="text-2xl font-bold text-slate-800 mb-2"></h2>
            <p id="msg-desc" class="text-slate-500 mb-8"></p>
            <button onclick="App.logout()" class="btn-gradient w-full py-3 rounded-xl font-bold shadow-lg">จองคิวใหม่ / กลับหน้าแรก</button>
        </div>

        <div id="shop-closed" class="hidden fixed inset-0 bg-slate-100/95 z-50 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm animate__animated animate__fadeIn">
            <i class="fa-solid fa-store-slash text-6xl text-slate-300 mb-4"></i>
            <h2 class="text-3xl font-bold text-slate-700 mb-2">ร้านปิดชั่วคราว</h2>
            <p class="text-slate-500">ขออภัย ระบบปิดรับจองคิวในขณะนี้<br>โปรดติดต่อเจ้าหน้าที่</p>
        </div>

    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        class CustomerApp {
            constructor() {
                this.myId = localStorage.getItem('q_ultimate_id');
                this.lastCallTime = 0;
                this.currCustomStatus = "";
                this.init();
            }

            init() {
                this.listenConfig();
                if(this.myId) this.listenTicket();
                else {
                    const now = new Date();
                    document.getElementById('inp-time').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                }
            }

            listenConfig() {
                db.collection('q_system').doc('config').onSnapshot(doc => {
                    if(!doc.exists) return;
                    const d = doc.data();
                    
                    // Shop Details
                    document.getElementById('shop-name').innerText = d.shopName || 'Queue System';
                    document.getElementById('current-q').innerText = d.current || '---';

                    // Shop Status (Open/Close)
                    const isOpen = d.isShopOpen !== false;
                    const badge = document.getElementById('shop-badge');
                    const closedScr = document.getElementById('shop-closed');
                    
                    if(isOpen) {
                        badge.innerHTML = `<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span class="text-green-700">Open (เปิดรับคิว)</span>`;
                        badge.className = "mt-2 inline-flex items-center gap-2 px-3 py-1 bg-green-50 border border-green-200 rounded-full text-xs font-bold";
                        closedScr.classList.add('hidden');
                    } else {
                        badge.innerHTML = `<div class="w-2 h-2 bg-red-500 rounded-full"></div><span class="text-red-700">Closed (ปิดรับคิว)</span>`;
                        badge.className = "mt-2 inline-flex items-center gap-2 px-3 py-1 bg-red-50 border border-red-200 rounded-full text-xs font-bold";
                        if(!this.myId) closedScr.classList.remove('hidden');
                    }

                    // Announcement
                    const ann = document.getElementById('ann-bar');
                    if(d.announceText) { ann.classList.remove('hidden'); document.getElementById('ann-text').innerText = d.announceText; }
                    else ann.classList.add('hidden');
                });
            }

            listenTicket() {
                db.collection('q_system').doc('config').collection('queues').doc(this.myId).onSnapshot(doc => {
                    if(!doc.exists) return this.logout();
                    const d = doc.data();

                    if(d.status === 'served') return this.showMsg('success');
                    if(d.status === 'cancelled') return this.showMsg('cancel');

                    this.showScreen('ticket-section');
                    this.renderTicket(d);
                    this.checkQueueAhead(d.raw); // คำนวณคิวรอ

                    // Custom Status
                    const cBox = document.getElementById('custom-status-box');
                    if(d.customStatus) {
                        cBox.classList.remove('hidden');
                        const cText = document.getElementById('custom-status-text');
                        if(this.currCustomStatus !== d.customStatus) {
                            this.currCustomStatus = d.customStatus;
                            cText.innerText = d.customStatus;
                            cText.classList.remove('animate__bounceIn');
                            void cText.offsetWidth;
                            cText.classList.add('animate__bounceIn');
                            if(navigator.vibrate) navigator.vibrate(50);
                        }
                    } else cBox.classList.add('hidden');

                    // Call Voice
                    if(d.status === 'called' && d.lastCallTime > this.lastCallTime) {
                        this.lastCallTime = d.lastCallTime;
                        this.announce(d.voiceMessage);
                    }
                });
            }

            // คำนวณว่ามีคนรอก่อนหน้ากี่คน
            checkQueueAhead(myRaw) {
                db.collection('q_system').doc('config').collection('queues')
                  .where('status', '==', 'waiting')
                  .where('raw', '<', myRaw)
                  .onSnapshot(snap => {
                      const count = snap.size;
                      document.getElementById('ahead-count').innerText = count;
                      // ถ้าถึงคิวตัวเอง (0 คิว) ให้เปลี่ยนข้อความเป็น "ถึงคิวคุณแล้ว"
                      const box = document.getElementById('queue-ahead-box');
                      if(count === 0) {
                          box.className = "inline-block bg-green-50 border border-green-100 px-4 py-2 rounded-lg mb-6";
                          box.innerHTML = `<span class="text-xs font-bold text-green-600"><i class="fa-solid fa-bell"></i> ถึงคิวของคุณแล้ว (หรือคิวถัดไป)</span>`;
                      }
                  });
            }

            renderTicket(d) {
                document.getElementById('my-q-num').innerText = d.number;
                document.getElementById('my-name').innerText = d.name;
                const st = document.getElementById('my-status');
                if(d.status === 'called') {
                    st.className = 'badge-status st-call'; st.innerHTML = '<i class="fa-solid fa-bullhorn"></i> กำลังเรียก';
                } else {
                    st.className = 'badge-status st-wait'; st.innerHTML = '<i class="fa-solid fa-clock"></i> รอเรียก';
                }
            }

            async book(e) {
                e.preventDefault();
                this.speak(' ');
                const btn = document.getElementById('btn-book');
                btn.disabled = true; btn.innerText = 'กำลังประมวลผล...';

                try {
                    const cfg = await db.collection('q_system').doc('config').get();
                    if(cfg.exists && cfg.data().isShopOpen === false) throw new Error("ร้านปิดรับจองแล้ว");

                    await db.runTransaction(async (t) => {
                        const ref = db.collection('q_system').doc('config');
                        const doc = await t.get(ref);
                        const d = doc.data();
                        const next = (d.last || 0) + 1;
                        const prefix = d.queuePrefix || 'A-';
                        const qRef = ref.collection('queues').doc();
                        
                        t.set(qRef, {
                            number: `${prefix}${String(next).padStart(3,'0')}`,
                            raw: next, prefix: prefix,
                            name: document.getElementById('inp-name').value,
                            phone: document.getElementById('inp-phone').value,
                            pax: document.getElementById('inp-pax').value,
                            arrivalTime: document.getElementById('inp-time').value,
                            status: 'waiting', customStatus: '',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            lastCallTime: 0
                        });
                        t.update(ref, { last: next });
                        localStorage.setItem('q_ultimate_id', qRef.id);
                        this.myId = qRef.id;
                    });
                    this.listenTicket();
                    Swal.fire({icon:'success', title:'จองสำเร็จ', timer:1500, showConfirmButton:false});
                } catch(e) {
                    btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> กดรับบัตรคิว';
                    Swal.fire('Error', e.message, 'error');
                }
            }

            showMsg(type) {
                this.showScreen('msg-section');
                const bg = document.getElementById('msg-bg');
                const icon = document.getElementById('msg-icon');
                const t = document.getElementById('msg-title');
                const d = document.getElementById('msg-desc');

                if(type === 'success') {
                    bg.className = 'w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm bg-green-100 text-green-600';
                    icon.className = 'fa-solid fa-check text-4xl';
                    t.innerText = 'ขอบคุณที่ใช้บริการ'; d.innerText = 'การบริการเสร็จสิ้นเรียบร้อยแล้ว';
                    if(navigator.vibrate) navigator.vibrate(200);
                } else {
                    bg.className = 'w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm bg-red-100 text-red-600';
                    icon.className = 'fa-solid fa-xmark text-4xl';
                    t.innerText = 'คิวถูกยกเลิก'; d.innerText = 'กรุณาติดต่อเจ้าหน้าที่';
                    if(navigator.vibrate) navigator.vibrate([100,50,100]);
                }
            }

            showScreen(id) {
                ['form-section','ticket-section','msg-section'].forEach(x => document.getElementById(x).classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            }

            testSound() { this.speak('ทดสอบระบบเสียง'); if(navigator.vibrate) navigator.vibrate(200); Swal.fire({toast:true, position:'top', icon:'success', title:'เสียงพร้อมใช้งาน', timer:1000, showConfirmButton:false}); }
            announce(msg) { 
                if(navigator.vibrate) navigator.vibrate([500,300,500]); 
                this.speak(msg||'ถึงคิวแล้ว'); 
                Swal.fire({title:'ถึงคิวคุณแล้ว!', text:'เชิญที่เคาน์เตอร์', icon:'success', confirmButtonText:'รับทราบ'});
            }
            speak(txt) {
                if('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    if(!txt) return;
                    const u = new SpeechSynthesisUtterance(txt);
                    u.lang = 'th-TH'; u.rate = 1.0;
                    window.speechSynthesis.speak(u);
                }
            }
            cancel() { Swal.fire({title:'ยกเลิกคิว?', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef4444'}).then(r=>{if(r.isConfirmed) db.collection('q_system').doc('config').collection('queues').doc(this.myId).update({status:'cancelled'});}); }
            logout() { localStorage.removeItem('q_ultimate_id'); location.reload(); }
        }
        const App = new CustomerApp();
    </script>
</body>
</html>
