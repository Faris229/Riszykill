<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Stock Pro (Modern UI)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    
    <style>
        :root { 
            --primary-bg: #f3f4f6;
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
        }
        body { font-family: 'Prompt', sans-serif; background-color: var(--primary-bg); color: #1f2937; }
        
        /* Modern Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
        }

        /* Modern Buttons */
        .btn-modern {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
            color: white;
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        }
        .btn-danger-soft {
            background-color: #fee2e2;
            color: #ef4444;
            border: none;
            border-radius: 50px;
            font-weight: 600;
        }
        .btn-danger-soft:hover { background-color: #fecaca; color: #dc2626; }

        /* Navbar Profile */
        .nav-profile-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #e0e7ff;
        }
        .dropdown-menu-modern {
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 1rem;
            padding: 10px;
            min-width: 240px;
        }
        .dropdown-item { border-radius: 8px; padding: 10px 15px; font-weight: 500; color: #4b5563; }
        .dropdown-item:hover { background-color: #f3f4f6; color: var(--primary-color); }
        .dropdown-item.text-danger:hover { background-color: #fef2f2; color: #ef4444; }

        /* Table & Elements */
        .table-hover tbody tr:hover { background-color: #f9fafb; }
        .blur-text { filter: blur(5px); transition: 0.3s; cursor: pointer; background: #e5e7eb; padding: 2px 8px; border-radius: 4px; user-select: none; }
        .blur-text:hover { filter: blur(0); background: transparent; }
        .table-img { width: 60px; height: 60px; object-fit: cover; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; cursor: zoom-in; }
        .table-img:hover { transform: scale(1.1); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top glass-card m-3 mt-2 px-3 py-2 hidden" id="mainNavbar">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-primary fs-4" href="#" onclick="window.scrollTo(0,0)">
        <i class="bi bi-joystick me-2"></i><span id="navStoreName">RS SHOP</span>
    </a>
    
    <div class="dropdown ms-auto">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
            <div class="text-end me-2 d-none d-sm-block">
                <div class="fw-bold small text-dark" id="navUserName">Admin</div>
                <div class="text-muted" style="font-size: 0.75rem;">Manager</div>
            </div>
            <img src="https://ui-avatars.com/api/?name=Admin&background=random" id="navProfileImg" class="nav-profile-img shadow-sm">
        </a>
        <ul class="dropdown-menu dropdown-menu-modern dropdown-menu-end mt-3">
            <li><div class="dropdown-header text-uppercase small fw-bold text-muted">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</div></li>
            <li><a class="dropdown-item" href="#" onclick="window.scrollTo(0,0)"><i class="bi bi-speedometer2 me-2"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a></li>
            <li><a class="dropdown-item" href="#stock-pane" onclick="goToStock()"><i class="bi bi-box-seam me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
            <li><hr class="dropdown-divider my-2"></li>
            <li><div class="dropdown-header text-uppercase small fw-bold text-muted">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div></li>
            <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editProfileModal"><i class="bi bi-person-gear me-2"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button></li>
            <li><button class="dropdown-item text-danger mt-1" onclick="confirmLogout()"><i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
        </ul>
    </div>
  </div>
</nav>

<div class="container" id="auth-section" style="padding-top: 10vh;">
    <div class="row justify-content-center">
        <div class="col-md-5 col-lg-4">
            <div class="glass-card p-4 p-md-5">
                <div class="text-center mb-4">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex p-3 mb-3">
                        <i class="bi bi-shield-lock-fill fs-2"></i>
                    </div>
                    <h3 class="fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <p class="text-muted small">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</p>
                </div>

                <ul class="nav nav-pills nav-fill mb-4 bg-light p-1 rounded-pill" role="tablist">
                    <li class="nav-item"><button class="nav-link active rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#login-tab">Login</button></li>
                    <li class="nav-item"><button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#signup-tab">Register</button></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="login-tab">
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control rounded-3 border-0 bg-light" id="loginEmail" placeholder="name@example.com">
                            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        </div>
                        <div class="form-floating mb-4">
                            <input type="password" class="form-control rounded-3 border-0 bg-light" id="loginPassword" placeholder="Password">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        </div>
                        <button class="btn btn-modern w-100 py-3" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                    
                    <div class="tab-pane fade" id="signup-tab">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control rounded-3 border-0 bg-light" id="signupStore" placeholder="Store Name">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô (Display Name)</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control rounded-3 border-0 bg-light" id="signupEmail" placeholder="Email">
                            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        </div>
                        <div class="form-floating mb-4">
                            <input type="password" class="form-control rounded-3 border-0 bg-light" id="signupPassword" placeholder="Password">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        </div>
                        <button class="btn btn-success w-100 py-3 rounded-pill fw-bold border-0" onclick="signup()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container hidden" id="dashboard-section" style="padding-top: 100px; padding-bottom: 50px;">
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold m-0 text-dark">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
            <p class="text-muted m-0">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö, ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
        </div>
        <button class="btn btn-modern shadow" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>

    <div class="glass-card p-2 mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 p-2">
            <ul class="nav nav-pills bg-light p-1 rounded-pill" id="dashTab">
                <li class="nav-item"><button class="nav-link active rounded-pill px-4 fw-bold" data-bs-toggle="tab" data-bs-target="#stock-pane">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button></li>
                <li class="nav-item"><button class="nav-link rounded-pill px-4 fw-bold text-secondary" data-bs-toggle="tab" data-bs-target="#history-pane">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button></li>
            </ul>
            <div class="input-group w-auto">
                <span class="input-group-text bg-white border-0 ps-3 rounded-start-pill"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="searchInput" class="form-control border-0 bg-white rounded-end-pill" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™..." onkeyup="searchTable('stockTable')">
            </div>
        </div>

        <div class="tab-content mt-2">
            <div class="tab-pane fade show active" id="stock-pane">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="stockTable">
                        <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                                <th class="ps-4 py-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</th>
                                <th class="text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white border-top-0"></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="history-pane">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="historyTable">
                        <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                                <th class="ps-4 py-3">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white border-top-0"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addItemModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header border-0 bg-light">
                <h5 class="modal-title fw-bold"><i class="bi bi-database-add me-2 text-primary"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-lg-5 text-center">
                        <label for="inpFile" class="w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-light rounded-4 border-2 border-dashed p-4" style="cursor: pointer; min-height: 250px;" id="dropZone">
                            <img id="previewImg" class="img-fluid rounded-3 shadow-sm mb-2" style="display:none; max-height: 200px;">
                            <div id="uploadText">
                                <i class="bi bi-cloud-arrow-up text-primary fs-1"></i>
                                <p class="mb-0 mt-2 fw-bold text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</p>
                            </div>
                        </label>
                        <input type="file" id="inpFile" accept="image/*" class="d-none" onchange="previewImage()">
                    </div>
                    <div class="col-lg-7">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="small fw-bold text-muted">‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                                <input type="number" id="inpBuy" class="form-control bg-light border-0 fw-bold" placeholder="0">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-success">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                <input type="number" id="inpSell" class="form-control border-success text-success fw-bold" placeholder="0">
                            </div>
                            <div class="col-12"><hr class="my-2 opacity-25"></div>
                            <div class="col-12">
                                <label class="small fw-bold">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Game Email)</label>
                                <input type="text" id="inpGameEmail" class="form-control" placeholder="example@gmail.com">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold">ID / Username</label>
                                <input type="text" id="inpUser" class="form-control" placeholder="Optional">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-danger">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                                <input type="text" id="inpGamePass" class="form-control border-danger-subtle text-danger" placeholder="Password">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-modern rounded-pill px-4" onclick="saveItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-person-gear me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô (Display Name)</label>
                    <input type="text" id="editStoreName" class="form-control rounded-3">
                </div>
                <hr class="my-4">
                <h6 class="fw-bold text-danger mb-3"><i class="bi bi-key me-2"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h6>
                <div class="mb-3">
                    <input type="password" id="editNewPass" class="form-control rounded-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ó‡∏¥‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)">
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="updateUserProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-rPvq9fFvhnYQCWxKtLf4Y3UK1uMnP0c",
    authDomain: "rssave-6169a.firebaseapp.com",
    projectId: "rssave-6169a",
    storageBucket: "rssave-6169a.firebasestorage.app",
    messagingSenderId: "619695253658",
    appId: "1:619695253658:web:2d1e3ccb1d5a3c08491723",
    measurementId: "G-1KHNKSTELW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentStorePrefix = 'RS';
  let currentImageBase64 = "";

  // --- Auth & Profile ---
  window.signup = async () => {
      const email = document.getElementById('signupEmail').value;
      const pass = document.getElementById('signupPassword').value;
      const store = document.getElementById('signupStore').value;
      if(!email || !pass || !store) return Swal.fire('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');

      try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(userCredential.user, { displayName: store }); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô Profile
          Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      } catch(e) { Swal.fire('Error', e.message, 'error'); }
  }

  window.login = async () => {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      try {
          await signInWithEmailAndPassword(auth, email, pass);
      } catch(e) { Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', 'error'); }
  }

  // Popup Logout
  window.confirmLogout = () => {
      Swal.fire({
          title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
          text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then((result) => {
          if (result.isConfirmed) signOut(auth);
      });
  }

  // Update Profile Logic
  window.updateUserProfile = async () => {
      const newName = document.getElementById('editStoreName').value;
      const newPass = document.getElementById('editNewPass').value;
      const user = auth.currentUser;

      if(!user) return;

      try {
          // Update Display Name
          if(newName && newName !== user.displayName) {
              await updateProfile(user, { displayName: newName });
          }
          // Update Password (Optional)
          if(newPass) {
              await updatePassword(user, newPass);
          }
          
          Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => {
              window.location.reload(); // Reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
          });
      } catch(e) {
          Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', e.message + ' (‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà)', 'error');
      }
  }

  onAuthStateChanged(auth, (user) => {
      const authSec = document.getElementById('auth-section');
      const dashSec = document.getElementById('dashboard-section');
      const nav = document.getElementById('mainNavbar');

      if(user) {
          authSec.classList.add('hidden');
          dashSec.classList.remove('hidden');
          nav.classList.remove('hidden');

          // Setup Profile UI
          const displayName = user.displayName || "Shop Admin";
          document.getElementById('navStoreName').innerText = displayName;
          document.getElementById('navUserName').innerText = displayName;
          document.getElementById('editStoreName').value = displayName;
          
          // Generate Avatar UI
          document.getElementById('navProfileImg').src = `https://ui-avatars.com/api/?name=${displayName}&background=4f46e5&color=fff`;

          // Setup Prefix
          currentStorePrefix = displayName.substring(0, 2).toUpperCase() || "RS";

          loadInventory();
          loadHistory();
      } else {
          authSec.classList.remove('hidden');
          dashSec.classList.add('hidden');
          nav.classList.add('hidden');
      }
  });

  // --- Image Helper ---
  window.previewImage = () => {
      const file = document.getElementById('inpFile').files[0];
      if(file){
          const reader = new FileReader();
          reader.onloadend = () => {
              const img = new Image();
              img.src = reader.result;
              img.onload = () => {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  const maxWidth = 500;
                  const scaleSize = maxWidth / img.width;
                  canvas.width = maxWidth;
                  canvas.height = img.height * scaleSize;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  currentImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                  
                  document.getElementById('uploadText').classList.add('d-none');
                  const pv = document.getElementById('previewImg');
                  pv.src = currentImageBase64;
                  pv.style.display = 'block';
              }
          }
          reader.readAsDataURL(file);
      }
  }
  
  // Menu Navigation Helper
  window.goToStock = () => {
      const tabEl = document.querySelector('button[data-bs-target="#stock-pane"]');
      const tab = new bootstrap.Tab(tabEl);
      tab.show();
  }

  // --- Logic Functions ---
  async function generateAutoID() {
      // ‡πÉ‡∏ä‡πâ JS ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Index
      const q = query(collection(db, "products"), where("status", "==", "available")); // ‡∏î‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      const snap = await getDocs(q);
      
      let maxNum = 0;
      snap.forEach(doc => {
         const code = doc.data().code;
         if(code.startsWith(currentStorePrefix)) {
             const num = parseInt(code.replace(currentStorePrefix, ""));
             if(num > maxNum) maxNum = num;
         }
      });
      // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ô History ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ‡∏ï‡πâ‡∏≠‡∏á Query History ‡∏î‡πâ‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
      return currentStorePrefix + String(maxNum + 1).padStart(3, '0');
  }

  window.saveItem = async () => {
      const buy = document.getElementById('inpBuy').value;
      const sell = document.getElementById('inpSell').value;
      const user = document.getElementById('inpUser').value;
      const email = document.getElementById('inpGameEmail').value;
      const pass = document.getElementById('inpGamePass').value;

      if(!buy || !sell) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤', 'warning');
      
      // Loading State
      const btn = document.querySelector('#addItemModal .btn-modern');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Thinking...'; btn.disabled = true;

      try {
          const newCode = await generateAutoID();
          await addDoc(collection(db, "products"), {
              code: newCode,
              buyPrice: Number(buy),
              sellPrice: Number(sell),
              gameUser: user || "-",
              gameEmail: email || "-",
              gamePass: pass || "-",
              imageUrl: currentImageBase64 || "https://via.placeholder.com/150?text=No+Img",
              status: "available",
              createdAt: Timestamp.now(),
              soldAt: null
          });
          
          bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
          Swal.fire({
              icon: 'success',
              title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
              text: `‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${newCode}`,
              timer: 1500,
              showConfirmButton: false
          });
          
          // Reset
          document.getElementById('inpBuy').value = '';
          document.getElementById('inpSell').value = '';
          document.getElementById('inpUser').value = '';
          document.getElementById('inpGameEmail').value = '';
          document.getElementById('inpGamePass').value = '';
          document.getElementById('inpFile').value = '';
          document.getElementById('previewImg').style.display = 'none';
          document.getElementById('uploadText').classList.remove('d-none');
          currentImageBase64 = "";

          loadInventory();

      } catch(e) { Swal.fire('Error', e.message, 'error'); }
      finally { btn.innerHTML = originalText; btn.disabled = false; }
  }

  async function loadInventory() {
      const q = query(collection(db, "products"), where("status", "==", "available"));
      const snap = await getDocs(q);
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = "";

      let docs = [];
      snap.forEach(d => docs.push({id: d.id, ...d.data()}));
      docs.sort((a,b) => b.createdAt - a.createdAt);

      if(docs.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</td></tr>`;
          return;
      }

      docs.forEach(d => {
          const tr = `
              <tr>
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center">
                        <img src="${d.imageUrl}" class="table-img me-3" onclick="window.open('${d.imageUrl}')">
                        <div>
                            <div class="fw-bold text-dark">${d.code}</div>
                            <div class="small text-muted">${d.gameEmail.split('@')[0]}...</div>
                        </div>
                    </div>
                  </td>
                  <td><span class="fw-bold text-primary">${d.sellPrice.toLocaleString()} ‡∏ø</span></td>
                  <td>
                      <div class="small text-muted mb-1"><i class="bi bi-envelope"></i> ${d.gameEmail}</div>
                      <div class="d-flex align-items-center"><i class="bi bi-key me-2 text-danger"></i> <span class="blur-text text-dark">${d.gamePass}</span></div>
                  </td>
                  <td class="text-end pe-4">
                      <button class="btn btn-warning shadow-sm btn-sm rounded-pill px-3 fw-bold text-dark" onclick="markSold('${d.id}')">
                          <i class="bi bi-cart-check"></i> ‡∏Ç‡∏≤‡∏¢
                      </button>
                  </td>
              </tr>
          `;
          tbody.innerHTML += tr;
      });
  }

  async function loadHistory() {
      const q = query(collection(db, "products"), where("status", "==", "sold"));
      const snap = await getDocs(q);
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";
      
      let docs = [];
      snap.forEach(d => docs.push(d.data()));
      docs.sort((a,b) => b.soldAt - a.soldAt);

      if(docs.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td></tr>`;
          return;
      }

      docs.forEach(d => {
          const profit = d.sellPrice - d.buyPrice;
          const isProfit = profit >= 0;
          const dateTxt = d.soldAt ? d.soldAt.toDate().toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'}) : '-';

          const tr = `
              <tr>
                  <td class="ps-4 py-3 fw-bold text-secondary">${d.code}</td>
                  <td>${d.sellPrice.toLocaleString()} ‡∏ø</td>
                  <td><span class="badge ${isProfit ? 'bg-success' : 'bg-danger'} rounded-pill fw-normal">${isProfit ? '+' : ''}${profit.toLocaleString()}</span></td>
                  <td class="text-muted small">${dateTxt}</td>
              </tr>
          `;
          tbody.innerHTML += tr;
      });
  }

  window.markSold = async (id) => {
      Swal.fire({
          title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢?',
          text: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢",
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
          confirmButtonColor: '#198754'
      }).then(async (result) => {
          if (result.isConfirmed) {
              try {
                  await updateDoc(doc(db, "products", id), {
                      status: "sold",
                      soldAt: Timestamp.now()
                  });
                  Swal.fire('‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', '', 'success');
                  loadInventory();
                  loadHistory();
              } catch(e) { Swal.fire('Error', e.message, 'error'); }
          }
      })
  }
  
  window.searchTable = (tId) => {
      const val = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll(`#${tId} tbody tr`);
      rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
  }

  document.querySelector('.hidden').style.display = 'none';
</script>

<style> .hidden { display: none !important; } </style>
</body>
</html>
