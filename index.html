<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RISZY SHOP - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ V2</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#005500',
                        'secondary': '#FFC72C',
                        'light-bg': '#f3f4f6',
                        'brand-green': '#009933',
                        'brand-dark': '#004d00',
                    },
                    fontFamily: {
                        sans: ['Mitr', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Mitr', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background-color: #FEF3C7; color: #D97706; }
        .status-success { background-color: #D1FAE5; color: #059669; }
        .status-cancel { background-color: #FEE2E2; color: #DC2626; }
        
        /* Animation for form switching */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800 pb-20">

    <!-- Navbar -->
    <nav class="bg-primary text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="https://i.postimg.cc/CdpMCWTh/IMG-9993.png" class="w-10 h-10 rounded-full border-2 border-secondary bg-white">
                <span class="font-bold text-lg tracking-wide hidden sm:block">RISZY SHOP</span>
                <span class="font-bold text-lg tracking-wide sm:hidden">RISZY</span>
            </div>
            <div class="flex gap-3 items-center">
                <div id="userGreeting" class="hidden text-xs text-secondary font-light mr-2"></div>
                <button onclick="togglePage('home')" class="hover:text-secondary transition text-sm"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="togglePage('history')" id="navHistoryBtn" class="hidden hover:text-secondary transition text-sm"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                <button onclick="logout()" id="navLogoutBtn" class="hidden text-red-300 hover:text-red-100 transition"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container max-w-2xl mx-auto p-4 mt-6">

        <!-- AUTH SECTION -->
        <div id="authSection" class="glass-panel p-6 rounded-2xl shadow-md bg-white fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-brand-dark" id="authTitle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p class="text-gray-500 text-sm">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Riszy Shop</p>
            </div>
            
            <form id="authForm" class="space-y-4">
                <!-- Username (Always Visible) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
                    <input type="text" id="authUsername" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-brand-green outline-none bg-gray-50" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©" required>
                </div>

                <!-- Email (Visible only in Register Mode) -->
                <div id="emailFieldContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</label>
                    <input type="email" id="authEmail" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-brand-green outline-none bg-gray-50" placeholder="example@gmail.com">
                </div>

                <!-- Password (Always Visible) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                    <input type="password" id="authPassword" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-brand-green outline-none bg-gray-50" placeholder="******" required>
                </div>
                
                <button type="submit" id="authSubmitBtn" class="w-full py-3 bg-brand-green hover:bg-green-700 text-white font-bold rounded-xl shadow transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>

            <div class="mt-4 text-center text-sm">
                <span id="authSwitchText" class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?</span>
                <button id="authSwitchBtn" class="text-modern-blue font-bold hover:underline text-blue-600 ml-1">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>

            <div class="mt-6 border-t pt-4 text-center">
                <button onclick="openAdminLogin()" class="text-xs text-gray-400 hover:text-gray-600 font-mono"><i class="fas fa-lock"></i> Admin Only</button>
            </div>
        </div>

        <!-- MAIN APP SECTION (Hidden by default) -->
        <div id="appSection" class="hidden space-y-6 fade-in">
            
            <!-- HOME: Product Selection -->
            <div id="page-home" class="page-content">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold text-primary mb-4 flex items-center"><i class="fas fa-shopping-bag mr-2"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    
                    <!-- Categories -->
                    <div class="grid grid-cols-3 gap-2 mb-6" id="categoryTabs">
                        <button onclick="filterCategory('gem')" class="cat-btn p-2 rounded-lg border text-sm font-bold bg-green-50 border-brand-green text-brand-green transition-all">üíé ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏°</button>
                        <button onclick="filterCategory('account')" class="cat-btn p-2 rounded-lg border text-sm text-gray-500 hover:bg-gray-50 transition-all">üÜî ‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°</button>
                        <button onclick="filterCategory('program')" class="cat-btn p-2 rounded-lg border text-sm text-gray-500 hover:bg-gray-50 transition-all">üéÆ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</button>
                    </div>

                    <!-- Products Grid -->
                    <div id="productsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                        <!-- Products will be injected here via JS -->
                        <div class="col-span-full text-center py-10 text-gray-400">
                            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...
                        </div>
                    </div>

                    <!-- Input Form -->
                    <div id="orderForm" class="hidden border-t pt-6 fade-in">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-gray-700" id="selectedProductName">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: -</h4>
                            <button onclick="closeOrderForm()" class="text-red-500 text-sm hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1" id="dynamicInputLabel">UID ‡πÄ‡∏Å‡∏° / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                            <input type="text" id="customerInput" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-brand-green outline-none bg-gray-50" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...">
                        </div>

                        <button onclick="submitOrder()" class="w-full py-3 bg-secondary hover:bg-yellow-400 text-brand-dark font-bold rounded-xl shadow-lg transform active:scale-95 transition">
                            <i class="fas fa-check-circle mr-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                        </button>
                    </div>
                </div>
            </div>

            <!-- HISTORY: Order Status -->
            <div id="page-history" class="page-content hidden fade-in">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold text-primary mb-4 flex items-center justify-between">
                        <span><i class="fas fa-list-alt mr-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
                        <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                    </h3>
                    <div id="orderHistoryList" class="space-y-3">
                        <!-- Orders injected here -->
                        <p class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- ADMIN PANEL (Overlay) -->
        <div id="adminPanel" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 z-[100] overflow-y-auto fade-in">
            <div class="max-w-4xl mx-auto p-4 min-h-screen">
                <div class="flex justify-between items-center mb-6 text-white">
                    <h1 class="text-2xl font-bold text-secondary">Admin System</h1>
                    <button onclick="closeAdminPanel()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
                </div>

                <!-- Admin Login -->
                <div id="adminLoginForm" class="bg-white p-8 rounded-xl shadow-2xl max-w-md mx-auto mt-20">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield text-4xl text-brand-dark"></i>
                        <h2 class="text-xl font-bold mt-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
                    </div>
                    <input type="text" id="adminUser" placeholder="Username (admin)" class="w-full p-3 border rounded-lg mb-3 outline-none focus:border-brand-green">
                    <input type="password" id="adminPass" placeholder="Password" class="w-full p-3 border rounded-lg mb-4 outline-none focus:border-brand-green">
                    <button onclick="checkAdminLogin()" class="w-full py-2 bg-primary text-white rounded-lg font-bold hover:bg-green-800 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</button>
                </div>

                <!-- Admin Content -->
                <div id="adminContent" class="hidden space-y-6">
                    
                    <!-- Navigation Tabs -->
                    <div class="flex gap-2 bg-gray-800 p-2 rounded-lg sticky top-0 z-10">
                        <button onclick="switchAdminTab('orders')" id="btn-tab-orders" class="flex-1 py-2 rounded bg-secondary text-brand-dark font-bold text-sm transition">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
                        <button onclick="switchAdminTab('stock')" id="btn-tab-stock" class="flex-1 py-2 rounded text-gray-300 hover:bg-gray-700 text-sm transition">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                        <button onclick="switchAdminTab('users')" id="btn-tab-users" class="flex-1 py-2 rounded text-gray-300 hover:bg-gray-700 text-sm transition">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                    </div>

                    <!-- TAB: Orders -->
                    <div id="admin-tab-orders" class="bg-white p-4 rounded-xl text-black shadow-lg">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg"><i class="fas fa-clipboard-list text-primary"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
                            <button onclick="initAdminDashboard()" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300"><i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase">
                                    <tr>
                                        <th class="p-3">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                        <th class="p-3">‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á</th>
                                        <th class="p-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="p-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="adminOrderTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB: Stock -->
                    <div id="admin-tab-stock" class="hidden space-y-4">
                        
                        <!-- Add Product -->
                        <div class="bg-white p-4 rounded-xl text-black shadow-lg">
                            <h3 class="font-bold text-lg mb-4 border-b pb-2"><i class="fas fa-plus-circle text-green-600"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="newProdName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏û‡∏ä‡∏£ 100)" class="border p-2 rounded outline-none focus:border-green-500">
                                <select id="newProdCat" class="border p-2 rounded outline-none">
                                    <option value="gem">‡∏´‡∏°‡∏ß‡∏î: ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏°</option>
                                    <option value="account">‡∏´‡∏°‡∏ß‡∏î: ‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°</option>
                                    <option value="program">‡∏´‡∏°‡∏ß‡∏î: ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</option>
                                </select>
                                <input id="newProdPrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" class="border p-2 rounded outline-none focus:border-green-500">
                                <button onclick="addNewProduct()" class="bg-green-600 text-white p-2 rounded font-bold hover:bg-green-700 shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                            </div>
                        </div>

                        <!-- Add Codes -->
                        <div class="bg-white p-4 rounded-xl text-black shadow-lg">
                            <h3 class="font-bold text-lg mb-4 border-b pb-2"><i class="fas fa-barcode text-blue-600"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î/‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</label>
                                <select id="stockProdSelect" class="w-full border p-2 rounded bg-gray-50 outline-none"></select>
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡πÇ‡∏Ñ‡πâ‡∏î)</label>
                                <textarea id="stockCodesArea" rows="4" class="w-full border p-2 rounded outline-none focus:border-blue-500" placeholder="CODE1111&#10;CODE2222&#10;CODE3333"></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="addStockCodes()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î</button>
                                <button onclick="clearAllCodes()" class="px-4 py-2 bg-red-100 text-red-600 rounded font-bold hover:bg-red-200 border border-red-200">‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                        </div>

                        <!-- Product List -->
                        <div class="bg-white p-4 rounded-xl text-black shadow-lg">
                            <h3 class="font-bold text-lg mb-4"><i class="fas fa-box text-orange-500"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                            <ul id="adminProductList" class="space-y-2 max-h-60 overflow-y-auto"></ul>
                        </div>
                    </div>

                    <!-- TAB: Users -->
                    <div id="admin-tab-users" class="hidden bg-white p-4 rounded-xl text-black shadow-lg">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2"><i class="fas fa-users text-purple-600"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                         <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                                        <th class="p-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                        <th class="p-2">Role</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUserTable"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <a href="https://www.facebook.com/p/Riszy-shop-61570552356915/" target="_blank" class="fixed bottom-5 right-5 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition z-40">
        <i class="fab fa-facebook-f text-xl"></i>
    </a>

    <!-- Scripts -->
    <script type="module">
        // --- 1. FIREBASE CONFIG (UPDATED) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, update, remove, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
          authDomain: "rsdm-9ca2a.firebaseapp.com",
          projectId: "rsdm-9ca2a",
          storageBucket: "rsdm-9ca2a.firebasestorage.app",
          messagingSenderId: "299212700124",
          appId: "1:299212700124:web:730160dae6bb1b09cbb719",
          measurementId: "G-CMX9GKW7FF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- 2. GLOBAL VARIABLES ---
        let currentUser = null;
        let selectedProduct = null;
        let currentCategory = 'gem';

        // --- 3. AUTH LOGIC (Updated for Username/Password) ---
        const authForm = document.getElementById('authForm');
        const authSwitchBtn = document.getElementById('authSwitchBtn');
        const emailFieldContainer = document.getElementById('emailFieldContainer');
        const authEmailInput = document.getElementById('authEmail');
        
        let isLoginMode = true;

        authSwitchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            
            // Toggle UI
            if (isLoginMode) {
                document.getElementById('authTitle').innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                document.getElementById('authSubmitBtn').innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                document.getElementById('authSwitchText').innerText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?';
                authSwitchBtn.innerText = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                emailFieldContainer.classList.add('hidden');
                authEmailInput.removeAttribute('required');
            } else {
                document.getElementById('authTitle').innerText = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                document.getElementById('authSubmitBtn').innerText = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                document.getElementById('authSwitchText').innerText = '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß?';
                authSwitchBtn.innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                emailFieldContainer.classList.remove('hidden');
                authEmailInput.setAttribute('required', 'true');
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value;
            const email = authEmailInput.value.trim();

            if (!username || !password) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', didOpen: () => Swal.showLoading() });

            try {
                if (!isLoginMode) {
                    // --- REGISTER LOGIC ---
                    if (!email) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£");

                    // 1. Check if username exists (Simple check)
                    const userCheckRef = query(ref(db, 'users'), orderByChild('username'), equalTo(username));
                    const userCheckSnap = await get(userCheckRef);
                    if (userCheckSnap.exists()) {
                         throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                    }

                    // 2. Create Auth User
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // 3. Save User Data to Realtime DB
                    await set(ref(db, 'users/' + user.uid), {
                        username: username,
                        email: email,
                        role: 'user',
                        createdAt: Date.now()
                    });

                    Swal.fire({ icon: 'success', title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
                } else {
                    // --- LOGIN LOGIC (Username -> Email -> Auth) ---
                    
                    // 1. Find email by username
                    const usersRef = query(ref(db, 'users'), orderByChild('username'), equalTo(username));
                    const snapshot = await get(usersRef);

                    if (snapshot.exists()) {
                        // Get the first match
                        const userData = Object.values(snapshot.val())[0];
                        const foundEmail = userData.email;
                        
                        // 2. Sign in with found email
                        await signInWithEmailAndPassword(auth, foundEmail, password);
                        Swal.fire({ icon: 'success', title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
                    } else {
                        throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                    }
                }
            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (msg.includes("auth/email-already-in-use")) msg = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
                if (msg.includes("auth/wrong-password")) msg = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                if (msg.includes("auth/user-not-found")) msg = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: msg });
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // Fetch extra user data (username)
                const userSnapshot = await get(ref(db, 'users/' + user.uid));
                const userData = userSnapshot.val();
                const displayName = userData ? userData.username : user.email;

                document.getElementById('userGreeting').innerHTML = `<i class="fas fa-user-circle"></i> ${displayName}`;
                
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('navHistoryBtn').classList.remove('hidden');
                document.getElementById('navLogoutBtn').classList.remove('hidden');
                
                loadProducts(currentCategory);
                listenToMyOrders();
            } else {
                currentUser = null;
                document.getElementById('userGreeting').innerText = '';
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
                document.getElementById('navHistoryBtn').classList.add('hidden');
                document.getElementById('navLogoutBtn').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        // --- 4. CUSTOMER APP LOGIC ---
        
        window.togglePage = (pageName) => {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageName}`).classList.remove('hidden');
        };

        window.closeOrderForm = () => {
             document.getElementById('orderForm').classList.add('hidden');
             const allBoxes = document.getElementById('productsGrid').children;
             for(let box of allBoxes) { box.classList.remove('ring-2', 'ring-brand-green', 'bg-green-50'); }
             selectedProduct = null;
        }

        window.filterCategory = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('bg-green-50', 'border-brand-green', 'text-brand-green');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            event.target.classList.remove('text-gray-500', 'border-transparent');
            event.target.classList.add('bg-green-50', 'border-brand-green', 'text-brand-green');
            
            closeOrderForm();
            loadProducts(cat);
        };

        function loadProducts(category) {
            const productsRef = ref(db, 'products');
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

            onValue(productsRef, (snapshot) => {
                grid.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-400 mt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>';
                    return;
                }

                let hasProduct = false;
                Object.entries(data).forEach(([key, product]) => {
                    if (product.category === category) {
                        hasProduct = true;
                        const div = document.createElement('div');
                        div.className = `cursor-pointer border border-gray-100 rounded-xl p-3 flex flex-col items-center justify-center transition hover:shadow-lg hover:border-brand-green bg-white h-36 relative group`;
                        div.onclick = (e) => selectProduct(e, key, product);
                        div.innerHTML = `
                            <div class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center mb-2 text-xl shadow-inner group-hover:scale-110 transition">
                                ${category === 'gem' ? 'üíé' : category === 'account' ? 'üÜî' : 'üéÆ'}
                            </div>
                            <div class="text-center font-bold text-primary text-sm mb-1 leading-tight px-1 break-words w-full">${product.name}</div>
                            <div class="text-xs text-brand-dark font-mono bg-green-100 px-2 py-0.5 rounded-full mt-1">${product.price} ‡∏ø</div>
                        `;
                        grid.appendChild(div);
                    }
                });

                if (!hasProduct) {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-400 mt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>';
                }
            });
        }

        window.selectProduct = (e, key, product) => {
            selectedProduct = { ...product, id: key };
            document.getElementById('selectedProductName').innerHTML = `<span class="text-primary">${product.name}</span> <span class="text-gray-400 text-sm">(${product.price} ‡∏ö.)</span>`;
            document.getElementById('orderForm').classList.remove('hidden');
            
            // Highlight selection
            const allBoxes = document.getElementById('productsGrid').children;
            for(let box of allBoxes) { box.classList.remove('ring-2', 'ring-brand-green', 'bg-green-50'); }
            e.currentTarget.classList.add('ring-2', 'ring-brand-green', 'bg-green-50');

            // Scroll to form
            document.getElementById('orderForm').scrollIntoView({ behavior: 'smooth' });

            // Dynamic Input Placeholder
            const input = document.getElementById('customerInput');
            const label = document.getElementById('dynamicInputLabel');
            if (product.category === 'gem') {
                label.innerText = 'UID ‡πÄ‡∏Å‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°)';
                input.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å UID ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
            } else {
                label.innerText = '‡∏ä‡∏∑‡πà‡∏≠ Facebook / ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠';
                input.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ü‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ü‡∏™';
            }
        };

        window.submitOrder = async () => {
            const inputVal = document.getElementById('customerInput').value.trim();
            if (!inputVal) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
            if (!selectedProduct) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'warning');

            // Get current username for the order record
            let currentUsername = "Unknown";
            try {
                const uSnap = await get(ref(db, 'users/' + currentUser.uid));
                if(uSnap.exists()) currentUsername = uSnap.val().username;
            } catch(e){}

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const newOrderRef = push(ref(db, 'orders'));
                await set(newOrderRef, {
                    userId: currentUser.uid,
                    username: currentUsername, // Add username to order for Admin easier view
                    email: currentUser.email,
                    productId: selectedProduct.id,
                    productName: selectedProduct.name,
                    price: selectedProduct.price,
                    customerInfo: inputVal,
                    category: selectedProduct.category,
                    status: 'pending',
                    timestamp: Date.now()
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥',
                    confirmButtonColor: '#009933'
                });

                document.getElementById('customerInput').value = '';
                closeOrderForm();
                togglePage('history'); 

            } catch (error) {
                console.error(error);
                Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', 'error');
            }
        };

        function listenToMyOrders() {
            if (!currentUser) return;
            const ordersRef = ref(db, 'orders');
            onValue(ordersRef, (snapshot) => {
                const list = document.getElementById('orderHistoryList');
                list.innerHTML = '';
                const data = snapshot.val();
                
                if (!data) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                    return;
                }

                // Filter: Only show orders belonging to current User UID
                const myOrders = Object.entries(data)
                    .filter(([key, order]) => order.userId === currentUser.uid)
                    .sort((a, b) => b[1].timestamp - a[1].timestamp);

                if (myOrders.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                    return;
                }

                myOrders.forEach(([key, order]) => {
                    let statusHtml = '';
                    let noteHtml = '';
                    
                    if (order.status === 'pending') {
                        statusHtml = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                    } else if (order.status === 'completed') {
                        statusHtml = '<span class="status-badge status-success"><i class="fas fa-check"></i> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
                        if (order.code) { 
                             noteHtml = `<div class="mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm font-mono text-green-800 break-all select-all flex items-center gap-2"><i class="fas fa-key"></i> ${order.code}</div>`;
                        }
                    } else {
                        statusHtml = '<span class="status-badge status-cancel"><i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
                    }

                    const date = new Date(order.timestamp).toLocaleString('th-TH');

                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-xl border border-gray-100 shadow-sm transition hover:shadow-md';
                    item.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm md:text-base">${order.productName}</h4>
                                <p class="text-xs text-gray-400">${date}</p>
                            </div>
                            ${statusHtml}
                        </div>
                        <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                            <i class="fas fa-info-circle text-xs mr-1"></i> <span class="font-medium">${order.customerInfo}</span>
                        </div>
                        ${noteHtml}
                    `;
                    list.appendChild(item);
                });
            });
        }


        // --- 5. ADMIN LOGIC ---
        
        window.openAdminLogin = () => { document.getElementById('adminPanel').classList.remove('hidden'); };
        window.closeAdminPanel = () => { document.getElementById('adminPanel').classList.add('hidden'); };

        window.checkAdminLogin = () => {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            // Hardcoded Admin as requested
            if (u === 'admin' && p === '1122') {
                document.getElementById('adminLoginForm').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                initAdminDashboard();
            } else {
                Swal.fire('Error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        };

        window.switchAdminTab = (tab) => {
            ['orders', 'stock', 'users'].forEach(t => {
                document.getElementById(`admin-tab-${t}`).classList.add('hidden');
                const btn = document.getElementById(`btn-tab-${t}`);
                if(btn) {
                    btn.classList.remove('bg-secondary', 'text-brand-dark');
                    btn.classList.add('text-gray-300');
                }
            });
            document.getElementById(`admin-tab-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`btn-tab-${tab}`);
            if(activeBtn) {
                 activeBtn.classList.add('bg-secondary', 'text-brand-dark');
                 activeBtn.classList.remove('text-gray-300');
            }
            
            if (tab === 'users') loadAdminUsers();
        };

        window.initAdminDashboard = () => {
            // Listen to all orders
            onValue(ref(db, 'orders'), (snapshot) => {
                const tbody = document.getElementById('adminOrderTable');
                tbody.innerHTML = '';
                const data = snapshot.val();
                if (!data) return;

                // Sort newest first
                const orders = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);

                orders.forEach(([key, order]) => {
                    const date = new Date(order.timestamp).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                    const displayUser = order.username ? order.username : order.email;
                    
                    let actionBtn = '';
                    if (order.status === 'pending') {
                        actionBtn = `
                            <button onclick="updateOrderStatus('${key}', 'completed')" class="bg-green-500 text-white px-2 py-1 rounded text-xs mr-1 hover:bg-green-600 shadow">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button onclick="updateOrderStatus('${key}', 'cancelled')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 shadow">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        `;
                    } else if (order.status === 'completed') {
                         actionBtn = `<button onclick="updateOrderStatus('${key}', 'pending')" class="text-xs text-gray-400 underline">‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>`;
                    } else {
                         actionBtn = `<span class="text-xs text-red-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    }

                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50 transition";
                    tr.innerHTML = `
                        <td class="p-3 text-gray-500 text-xs">${date}</td>
                        <td class="p-3 font-bold text-blue-900 text-sm">${displayUser}</td>
                        <td class="p-3 text-sm">${order.productName}</td>
                        <td class="p-3 font-mono text-primary select-all cursor-copy text-sm bg-gray-50 rounded" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">${order.customerInfo}</td>
                        <td class="p-3">
                            <span class="status-badge ${order.status === 'pending' ? 'status-pending' : order.status === 'completed' ? 'status-success' : 'status-cancel'}">
                                ${order.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-3">${actionBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });

            // Listen to products for stock
            onValue(ref(db, 'products'), (snapshot) => {
                const select = document.getElementById('stockProdSelect');
                const list = document.getElementById('adminProductList');
                
                const oldVal = select.value; // Keep selection
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
                list.innerHTML = '';
                
                const data = snapshot.val();
                if(!data) return;

                Object.entries(data).forEach(([key, prod]) => {
                    // Option
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = `${prod.name} (${prod.category})`;
                    select.appendChild(opt);

                    // List Item
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100';
                    li.innerHTML = `
                        <div>
                            <span class="font-bold text-gray-700">${prod.name}</span> 
                            <span class="text-xs text-gray-400 ml-2">${prod.category}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-brand-green font-mono">${prod.price}‡∏ö.</span>
                            <button onclick="removeProduct('${key}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(li);
                });
                if(oldVal) select.value = oldVal;
            });
        }

        function loadAdminUsers() {
            onValue(ref(db, 'users'), (snapshot) => {
                const tbody = document.getElementById('adminUserTable');
                tbody.innerHTML = '';
                const data = snapshot.val();
                if (!data) return;
                
                Object.values(data).forEach(u => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `<td class="p-2 font-bold">${u.username}</td><td class="p-2 text-gray-500">${u.email}</td><td class="p-2 text-xs badge">${u.role}</td>`;
                    tbody.appendChild(tr);
                });
            });
        }

        // --- Admin Actions ---
        
        window.addNewProduct = async () => {
            const name = document.getElementById('newProdName').value;
            const cat = document.getElementById('newProdCat').value;
            const price = document.getElementById('newProdPrice').value;

            if(!name || !price) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');

            await push(ref(db, 'products'), {
                name, category: cat, price: Number(price)
            });

            Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', toast: true, position: 'top-end', timer: 1500, showConfirmButton: false });
            document.getElementById('newProdName').value = '';
            document.getElementById('newProdPrice').value = '';
        };

        window.removeProduct = async (key) => {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) {
                await remove(ref(db, `products/${key}`));
            }
        };

        window.addStockCodes = async () => {
            const prodId = document.getElementById('stockProdSelect').value;
            const codesText = document.getElementById('stockCodesArea').value;

            if(!prodId) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            if(!codesText.trim()) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î', 'warning');

            const codes = codesText.split('\n').filter(line => line.trim() !== '');
            
            const updates = {};
            codes.forEach(code => {
                const newCodeKey = push(ref(db, 'codes/' + prodId)).key;
                updates[`codes/${prodId}/${newCodeKey}`] = { 
                    code: code.trim(),
                    status: 'available'
                };
            });

            await update(ref(db), updates);
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏° ${codes.length} ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            document.getElementById('stockCodesArea').value = '';
        };

        window.clearAllCodes = async () => {
             const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: "‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'
            });

            if (result.isConfirmed) {
                await set(ref(db, 'codes'), null);
                Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        };

        window.updateOrderStatus = async (orderId, status) => {
            // Check for available code if completing
            let updates = { status: status };
            
            // Logic: If status is completed and no code assigned, try to find one?
            // For now, simple status update.
            // If you want auto-assign code, we need to query 'codes/{productId}' where status='available' limitToFirst(1)
            
            await update(ref(db, `orders/${orderId}`), updates);
            Swal.fire({ icon: 'success', title: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}`, toast: true, position: 'top-end', timer: 1000, showConfirmButton: false });
        };

    </script>
</body>
</html>
