<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Stock (Private Edition)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    
    <style>
        :root { 
            --primary-bg: #f3f4f6;
            --primary-color: #4f46e5;
        }
        body { font-family: 'Prompt', sans-serif; background-color: var(--primary-bg); color: #1f2937; padding-bottom: 50px; }
        
        /* Modern UI Style */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .btn-modern {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border: none; color: white; padding: 10px 24px; border-radius: 50px; font-weight: 500; transition: 0.3s;
        }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4); color: white; }

        /* Profile & Navbar */
        .nav-profile-img {
            width: 42px; height: 42px; object-fit: cover; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #e0e7ff;
        }
        .dropdown-menu-modern { border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 1rem; padding: 10px; }
        .dropdown-item { border-radius: 8px; padding: 8px 15px; }
        .dropdown-item:hover { background-color: #f3f4f6; color: var(--primary-color); }

        /* Table Elements */
        .table-img { width: 60px; height: 60px; object-fit: cover; border-radius: 12px; cursor: zoom-in; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .blur-text { filter: blur(5px); background: #e5e7eb; padding: 2px 8px; border-radius: 4px; transition: 0.2s; cursor: pointer; user-select: none; }
        .blur-text:hover { filter: blur(0); background: transparent; }
        
        /* Edit Profile Upload */
        .profile-upload-box {
            width: 100px; height: 100px; border-radius: 50%; border: 3px solid #eee;
            margin: 0 auto; overflow: hidden; position: relative; cursor: pointer;
        }
        .profile-upload-box img { width: 100%; height: 100%; object-fit: cover; }
        .profile-upload-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5);
            color: white; font-size: 10px; text-align: center; padding: 3px; display: none;
        }
        .profile-upload-box:hover .profile-upload-overlay { display: block; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top glass-card m-3 mt-2 px-3 py-2 hidden" id="mainNavbar">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-primary fs-4" href="#" onclick="window.scrollTo(0,0)">
        <i class="bi bi-joystick me-2"></i><span id="navStoreName">MY SHOP</span>
    </a>
    
    <div class="dropdown ms-auto">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
            <div class="text-end me-2 d-none d-sm-block">
                <div class="fw-bold small text-dark" id="navUserName">Admin</div>
                <div class="text-muted" style="font-size: 0.7rem;">Owner</div>
            </div>
            <img src="https://via.placeholder.com/40" id="navProfileImg" class="nav-profile-img">
        </a>
        <ul class="dropdown-menu dropdown-menu-modern dropdown-menu-end mt-3">
            <li><h6 class="dropdown-header small text-uppercase fw-bold text-muted">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h6></li>
            <li><button class="dropdown-item" onclick="openEditProfile()"><i class="bi bi-person-circle me-2"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" onclick="confirmLogout()"><i class="bi bi-power me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
        </ul>
    </div>
  </div>
</nav>

<div class="container" id="auth-section" style="padding-top: 15vh;">
    <div class="row justify-content-center">
        <div class="col-md-5 col-lg-4">
            <div class="glass-card p-4 p-md-5">
                <div class="text-center mb-4">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex p-3 mb-3 shadow-sm">
                        <i class="bi bi-shield-check fs-1"></i>
                    </div>
                    <h3 class="fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <p class="text-muted small">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</p>
                </div>

                <ul class="nav nav-pills nav-fill mb-4 bg-light p-1 rounded-pill">
                    <li class="nav-item"><button class="nav-link active rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#login-tab">Login</button></li>
                    <li class="nav-item"><button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#signup-tab">Register</button></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="login-tab">
                        <input type="email" class="form-control rounded-pill mb-3 py-2 px-3" id="loginEmail" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                        <input type="password" class="form-control rounded-pill mb-4 py-2 px-3" id="loginPassword" placeholder="üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                        <button class="btn btn-modern w-100 py-2" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                    <div class="tab-pane fade" id="signup-tab">
                        <input type="text" class="form-control rounded-pill mb-3 py-2 px-3" id="signupStore" placeholder="üè™ ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                        <input type="email" class="form-control rounded-pill mb-3 py-2 px-3" id="signupEmail" placeholder="üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                        <input type="password" class="form-control rounded-pill mb-4 py-2 px-3" id="signupPassword" placeholder="üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                        <button class="btn btn-success w-100 py-2 rounded-pill fw-bold" onclick="signup()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container hidden" id="dashboard-section" style="padding-top: 100px;">
    
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold m-0"><i class="bi bi-grid-fill text-primary me-2"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
            <p class="text-muted m-0 small">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
        <button class="btn btn-modern shadow-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>

    <div class="glass-card p-3 mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-3">
            <ul class="nav nav-pills bg-light p-1 rounded-pill" id="dashTab">
                <li class="nav-item"><button class="nav-link active rounded-pill px-4 fw-bold" data-bs-toggle="tab" data-bs-target="#stock-pane">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å</button></li>
                <li class="nav-item"><button class="nav-link rounded-pill px-4 fw-bold text-secondary" data-bs-toggle="tab" data-bs-target="#history-pane">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></li>
            </ul>
            <input type="text" id="searchInput" class="form-control rounded-pill border-0 bg-light" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™..." style="max-width: 250px;" onkeyup="searchTable('stockTable')">
        </div>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="stock-pane">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="stockTable">
                        <thead class="bg-light text-secondary small text-uppercase">
                            <tr><th class="ps-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th><th class="text-end pe-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                        </thead>
                        <tbody class="bg-white"></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="history-pane">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="historyTable">
                        <thead class="bg-light text-secondary small text-uppercase">
                            <tr><th class="ps-3">‡∏£‡∏´‡∏±‡∏™</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th><th>‡∏Å‡∏≥‡πÑ‡∏£</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr>
                        </thead>
                        <tbody class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addItemModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-lg-5 text-center">
                        <label for="inpFile" class="w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-light rounded-4 border-2 border-dashed p-4" style="cursor: pointer; min-height: 200px;" id="dropZone">
                            <img id="previewImg" class="img-fluid rounded-3 mb-2" style="display:none; max-height: 180px;">
                            <div id="uploadText" class="text-muted"><i class="bi bi-cloud-upload fs-1"></i><br>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</div>
                        </label>
                        <input type="file" id="inpFile" accept="image/*" class="d-none" onchange="previewProductImage()">
                    </div>
                    <div class="col-lg-7">
                        <div class="row g-3">
                            <div class="col-6"><label class="small fw-bold">‡∏ó‡∏∏‡∏ô</label><input type="number" id="inpBuy" class="form-control bg-light" placeholder="0"></div>
                            <div class="col-6"><label class="small fw-bold text-success">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label><input type="number" id="inpSell" class="form-control border-success" placeholder="0"></div>
                            <div class="col-12"><label class="small fw-bold">Email ‡πÄ‡∏Å‡∏°</label><input type="text" id="inpGameEmail" class="form-control" placeholder="user@game.com"></div>
                            <div class="col-6"><label class="small fw-bold">ID / User</label><input type="text" id="inpUser" class="form-control" placeholder="Login ID"></div>
                            <div class="col-6"><label class="small fw-bold text-danger">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="text" id="inpGamePass" class="form-control text-danger" placeholder="Password"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-modern w-100 rounded-pill" onclick="saveItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4 text-center">
                 <div class="profile-upload-box mb-3">
                    <img id="editProfilePreview" src="https://via.placeholder.com/100">
                    <div class="profile-upload-overlay">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</div>
                    <input type="file" class="position-absolute top-0 start-0 w-100 h-100 opacity-0" accept="image/*" onchange="previewProfileImage(this)">
                </div>
                <input type="text" id="editStoreName" class="form-control rounded-pill mb-3 text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
                <input type="password" id="editNewPass" class="form-control rounded-pill text-center" placeholder="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)">
            </div>
            <div class="modal-footer border-0 pt-0"><button class="btn btn-primary w-100 rounded-pill" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-rPvq9fFvhnYQCWxKtLf4Y3UK1uMnP0c",
    authDomain: "rssave-6169a.firebaseapp.com",
    projectId: "rssave-6169a",
    storageBucket: "rssave-6169a.firebasestorage.app",
    messagingSenderId: "619695253658",
    appId: "1:619695253658:web:2d1e3ccb1d5a3c08491723",
    measurementId: "G-1KHNKSTELW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentProductImg = "";
  let currentProfileImg = "";

  // --- Auth System ---
  window.login = async () => {
      try {
          await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
      } catch(e) { Swal.fire('Error', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', 'error'); }
  }

  window.signup = async () => {
      const name = document.getElementById('signupStore').value;
      if(!name) return Swal.fire('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô', 'warning');
      try {
          const cred = await createUserWithEmailAndPassword(auth, document.getElementById('signupEmail').value, document.getElementById('signupPassword').value);
          // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          await updateProfile(cred.user, { 
              displayName: name, 
              photoURL: `https://ui-avatars.com/api/?name=${name}&background=4f46e5&color=fff` 
          });
          Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      } catch(e) { Swal.fire('Error', e.message, 'error'); }
  }

  window.confirmLogout = () => Swal.fire({title:'‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', showCancelButton:true, confirmButtonText:'Yes'}).then((r)=>{ if(r.isConfirmed) signOut(auth); });

  // --- Profile Logic ---
  window.openEditProfile = () => {
      const u = auth.currentUser;
      document.getElementById('editStoreName').value = u.displayName;
      document.getElementById('editProfilePreview').src = u.photoURL;
      new bootstrap.Modal(document.getElementById('editProfileModal')).show();
  }

  window.saveProfile = async () => {
      const u = auth.currentUser;
      try {
          let updates = { displayName: document.getElementById('editStoreName').value };
          if(currentProfileImg) updates.photoURL = currentProfileImg; // Base64
          await updateProfile(u, updates);
          
          const pass = document.getElementById('editNewPass').value;
          if(pass) await updatePassword(u, pass);
          
          Swal.fire('Updated', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success').then(()=>location.reload());
      } catch(e) { Swal.fire('Error', e.message, 'error'); }
  }

  // --- State Monitor ---
  onAuthStateChanged(auth, (user) => {
      if(user) {
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('dashboard-section').classList.remove('hidden');
          document.getElementById('mainNavbar').classList.remove('hidden');
          
          // Setup Navbar UI
          document.getElementById('navStoreName').innerText = user.displayName;
          document.getElementById('navUserName').innerText = user.displayName;
          document.getElementById('navProfileImg').src = user.photoURL;

          loadInventory(); // Load ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
      } else {
          document.getElementById('auth-section').classList.remove('hidden');
          document.getElementById('dashboard-section').classList.add('hidden');
          document.getElementById('mainNavbar').classList.add('hidden');
      }
  });

  // --- CRUD (Private Data Logic) ---
  
  // 1. Generate ID (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ)
  async function generateAutoID(prefix) {
      const u = auth.currentUser;
      // ‡∏î‡∏∂‡∏á‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      const q = query(collection(db, "products"), where("ownerId", "==", u.uid));
      const snap = await getDocs(q);
      
      let max = 0;
      snap.forEach(d => {
          const code = d.data().code;
          if(code.startsWith(prefix)) {
              const num = parseInt(code.replace(prefix, ""));
              if(!isNaN(num) && num > max) max = num;
          }
      });
      return prefix + String(max + 1).padStart(3, '0');
  }

  // 2. Save Item (Private)
  window.saveItem = async () => {
      const buy = document.getElementById('inpBuy').value;
      const sell = document.getElementById('inpSell').value;
      const u = auth.currentUser;

      if(!buy || !sell) return Swal.fire('!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤', 'warning');
      
      const prefix = u.displayName ? u.displayName.substring(0,2).toUpperCase() : "RS";
      const newCode = await generateAutoID(prefix);

      try {
          await addDoc(collection(db, "products"), {
              ownerId: u.uid, // üîí ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
              code: newCode,
              buyPrice: Number(buy),
              sellPrice: Number(sell),
              gameUser: document.getElementById('inpUser').value || "-",
              gameEmail: document.getElementById('inpGameEmail').value || "-",
              gamePass: document.getElementById('inpGamePass').value || "-",
              imageUrl: currentProductImg || "https://via.placeholder.com/150?text=No+Img",
              status: "available",
              createdAt: Timestamp.now(),
              soldAt: null
          });
          
          bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
          Swal.fire('Saved!', `‡∏£‡∏´‡∏±‡∏™: ${newCode}`, 'success');
          loadInventory();
          
          // Clear
          document.getElementById('inpBuy').value = '';
          document.getElementById('inpSell').value = '';
          document.getElementById('inpGameEmail').value = '';
          document.getElementById('inpGamePass').value = '';
          document.getElementById('previewImg').style.display='none';
          document.getElementById('uploadText').style.display='block';
          currentProductImg = "";

      } catch(e) { Swal.fire('Error', e.message, 'error'); }
  }

  // 3. Load Data (Private)
  async function loadInventory() {
      const u = auth.currentUser;
      if(!u) return;

      // Query ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ownerId == u.uid
      const q = query(collection(db, "products"), where("ownerId", "==", u.uid));
      const snap = await getDocs(q);
      
      let docs = [];
      snap.forEach(d => docs.push({id:d.id, ...d.data()}));

      // ‡πÅ‡∏¢‡∏Å Stock / History ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô JS (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á Index Error)
      const stock = docs.filter(d => d.status === "available").sort((a,b) => b.createdAt - a.createdAt);
      const history = docs.filter(d => d.status === "sold").sort((a,b) => b.soldAt - a.soldAt);

      renderStock(stock);
      renderHistory(history);
  }

  function renderStock(data) {
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = "";
      if(data.length===0) { tbody.innerHTML=`<tr><td colspan="4" class="text-center py-5 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>`; return;}

      data.forEach(d => {
          tbody.innerHTML += `
              <tr>
                  <td class="ps-3 py-3"><div class="d-flex align-items-center"><img src="${d.imageUrl}" class="table-img me-3" onclick="window.open('${d.imageUrl}')"><div><div class="fw-bold text-dark">${d.code}</div><small class="text-muted">${d.gameEmail}</small></div></div></td>
                  <td class="fw-bold text-primary">${d.sellPrice.toLocaleString()} ‡∏ø</td>
                  <td><span class="blur-text">${d.gamePass}</span></td>
                  <td class="text-end pe-3"><button class="btn btn-warning btn-sm rounded-pill px-3 shadow-sm" onclick="markSold('${d.id}')">‡∏Ç‡∏≤‡∏¢</button></td>
              </tr>
          `;
      });
  }

  function renderHistory(data) {
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";
      if(data.length===0) { tbody.innerHTML=`<tr><td colspan="4" class="text-center py-5 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`; return;}

      data.forEach(d => {
          const profit = d.sellPrice - d.buyPrice;
          const date = d.soldAt ? d.soldAt.toDate().toLocaleDateString('th-TH') : '-';
          tbody.innerHTML += `
              <tr>
                  <td class="ps-3 py-3 fw-bold text-secondary">${d.code}</td>
                  <td>${d.sellPrice.toLocaleString()}</td>
                  <td class="${profit>=0?'text-success':'text-danger'} fw-bold">${profit>=0?'+':''}${profit.toLocaleString()}</td>
                  <td class="text-muted small">${date}</td>
              </tr>
          `;
      });
  }

  window.markSold = (id) => {
      Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≤‡∏¢?', showCancelButton:true, confirmButtonText:'‡∏Ç‡∏≤‡∏¢‡πÄ‡∏•‡∏¢', confirmButtonColor:'#198754'}).then(async(r)=>{
          if(r.isConfirmed) {
              await updateDoc(doc(db, "products", id), { status: "sold", soldAt: Timestamp.now() });
              loadInventory();
              Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '', 'success');
          }
      });
  }

  // --- Image Utilities ---
  window.previewProductImage = () => processImg(document.getElementById('inpFile'), (res) => {
      currentProductImg = res;
      document.getElementById('previewImg').src = res;
      document.getElementById('previewImg').style.display='block';
      document.getElementById('uploadText').style.display='none';
  });

  window.previewProfileImage = (el) => processImg(el, (res) => {
      currentProfileImg = res;
      document.getElementById('editProfilePreview').src = res;
  });

  function processImg(input, cb) {
      if(input.files && input.files[0]) {
          const r = new FileReader();
          r.onload = (e) => {
              const img = new Image();
              img.src = e.target.result;
              img.onload = () => {
                  const c = document.createElement('canvas');
                  const ctx = c.getContext('2d');
                  const scale = 500/img.width;
                  c.width = 500; c.height = img.height*scale;
                  ctx.drawImage(img,0,0,c.width,c.height);
                  cb(c.toDataURL('image/jpeg', 0.8));
              }
          };
          r.readAsDataURL(input.files[0]);
      }
  }

  window.searchTable = (id) => {
      const v = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll(`#${id} tbody tr`).forEach(r => r.style.display = r.innerText.toLowerCase().includes(v)?'':'none');
  }

  document.querySelector('.hidden').style.display = 'none';
</script>
</body>
</html>
