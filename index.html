<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodApp | ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root { --primary: #ff4757; --bg: #f8f9fa; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        
        /* Components */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; background: var(--primary); }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        
        /* Wallet */
        .wallet-card { background: linear-gradient(135deg, #ff6b6b, #ff4757); color: white; text-align: center; padding: 25px; border-radius: 20px; margin: 20px; box-shadow: 0 10px 20px rgba(255, 71, 87, 0.3); }
        .balance { font-size: 2.5rem; font-weight: 800; }
        
        /* Bottom Nav */
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0; border-top: 1px solid #eee; }
        .nav-item { flex: 1; text-align: center; color: #aaa; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 1.5rem; display: block; margin-bottom: 3px; }

        /* Auth */
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:var(--primary); text-align:center;">Food Customer</h1>
        <input id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="input-box">
        <input id="pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="input-box">
        <button class="btn" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button class="btn" style="background:none; color:#555; margin-top:10px;" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
    </div>

    <div id="app" style="display:none;">
        <div style="padding:20px; font-weight:bold; font-size:1.2rem; color:var(--primary);">FoodApp üçî</div>

        <div id="page-home">
            <div class="wallet-card">
                <div>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="balance">‡∏ø <span id="u-bal">0.00</span></div>
                <button onclick="deposit()" style="background:rgba(255,255,255,0.2); border:none; padding:8px 20px; color:white; border-radius:20px; cursor:pointer; margin-top:10px;">+ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>

            <div style="padding:0 20px;">
                <h3>‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
                <div class="card" onclick="openOrder()">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="width:50px; height:50px; background:#ffeaa7; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">üçú</div>
                        <div>
                            <b>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠</b><br>
                            <span style="color:#888; font-size:0.9rem;">‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</span>
                        </div>
                    </div>
                </div>

                <h3>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                <div id="my-orders">Loading...</div>
            </div>
        </div>

        <div id="page-profile" style="display:none; padding:20px;">
            <h2>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
            <div class="card">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                <input id="p-name" class="input-box">
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                <input id="p-phone" class="input-box">
                <button class="btn" onclick="updateProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <button class="btn" style="background:#dc3545;" onclick="auth.signOut()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
            <div class="nav-item" onclick="nav('profile', this)"><i class="fa-solid fa-user"></i>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(user => {
            if(user) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏´‡∏°
                db.collection('users').doc(user.uid).get().then(doc => {
                    if(doc.data().role === 'rider') {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡πÅ‡∏≠‡∏õ','‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ Rider','error').then(()=>auth.signOut());
                    } else {
                        currentUser = user;
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('app').style.display = 'block';
                        loadData();
                    }
                });
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // Auth Functions
        async function login() {
            try {
                await auth.signInWithEmailAndPassword(
                    document.getElementById('email').value,
                    document.getElementById('pass').value
                );
            } catch(e) { Swal.fire('Error',e.message,'error'); }
        }

        async function register() {
            const {value: form} = await Swal.fire({
                title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)',
                html: '<input id="sw-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">' +
                      '<input id="sw-phone" class="swal2-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">',
                focusConfirm: false,
                preConfirm: () => [document.getElementById('sw-name').value, document.getElementById('sw-phone').value]
            });
            if(form) {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('pass').value;
                if(!email || !pass) return Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô','','warning');
                
                try {
                    const c = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(c.user.uid).set({
                        email, username: form[0], phone: form[1], 
                        role: 'customer', balance: 0
                    });
                    Swal.fire('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success');
                } catch(e) { Swal.fire('Error',e.message,'error'); }
            }
        }

        // App Functions
        function loadData() {
            // Balance
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('u-bal').innerText = d.balance.toFixed(2);
                document.getElementById('p-name').value = d.username;
                document.getElementById('p-phone').value = d.phone;
            });

            // My Orders
            db.collection('orders').where('buyerId','==',currentUser.uid).orderBy('timestamp','desc').onSnapshot(snap => {
                const div = document.getElementById('my-orders');
                div.innerHTML = '';
                snap.forEach(doc => {
                    const o = doc.data();
                    const statusColor = o.status==='completed' ? 'green' : (o.status==='pending'?'orange':'blue');
                    
                    // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß)
                    let btnHTML = '';
                    if(o.status === 'delivering') {
                        btnHTML = `<button onclick="confirmReceive('${doc.id}')" style="margin-top:10px; width:100%; padding:8px; background:#2ed573; color:white; border:none; border-radius:5px; cursor:pointer;">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</button>`;
                    }

                    div.innerHTML += `
                        <div class="card" style="border-left:5px solid ${statusColor}">
                            <div style="display:flex; justify-content:space-between;">
                                <b>${o.menu}</b>
                                <span style="color:${statusColor}; font-size:0.8rem;">${o.status.toUpperCase()}</span>
                            </div>
                            <div style="font-size:0.9rem; color:#666;">
                                ${o.address}<br>
                                ‡∏£‡∏≤‡∏Ñ‡∏≤: ${o.price} + ‡∏Ñ‡πà‡∏≤‡∏´‡∏¥‡πâ‡∏ß: ${o.tip} = <b>${o.price+o.tip} ‡∏ø</b> (${o.payment})
                            </div>
                            ${btnHTML}
                        </div>
                    `;
                });
            });
        }

        async function openOrder() {
            const {value: form} = await Swal.fire({
                title: '‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
                html: 
                    '<input id="od-menu" class="swal2-input" placeholder="‡πÄ‡∏°‡∏ô‡∏π">' +
                    '<input id="od-price" type="number" class="swal2-input" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)">' +
                    '<input id="od-tip" type="number" class="swal2-input" placeholder="‡∏Ñ‡πà‡∏≤‡∏´‡∏¥‡πâ‡∏ß (Tip)">' +
                    '<input id="od-addr" class="swal2-input" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á">' +
                    '<select id="od-pay" class="swal2-input"><option value="wallet">‡∏ï‡∏±‡∏î Wallet (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option><option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option></select>',
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('od-menu').value,
                    document.getElementById('od-price').value,
                    document.getElementById('od-tip').value,
                    document.getElementById('od-addr').value,
                    document.getElementById('od-pay').value
                ]
            });

            if(form) {
                const total = parseFloat(form[1]) + parseFloat(form[2]);
                // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏î Wallet ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                if(form[4] === 'wallet') {
                    const u = await db.collection('users').doc(currentUser.uid).get();
                    if(u.data().balance < total) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô','error');
                }

                await db.collection('orders').add({
                    buyerId: currentUser.uid, menu: form[0], price: parseFloat(form[1]), tip: parseFloat(form[2]),
                    address: form[3], payment: form[4], status: 'pending', timestamp: new Date()
                });
                Swal.fire('‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß','‡∏£‡∏≠‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô','success');
            }
        }

        async function confirmReceive(orderId) {
            const oDoc = await db.collection('orders').doc(orderId).get();
            const o = oDoc.data();
            const total = o.price + o.tip;

            if(o.payment === 'wallet') {
                // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô Auto
                await db.runTransaction(async t => {
                    const buyerRef = db.collection('users').doc(currentUser.uid);
                    const riderRef = db.collection('users').doc(o.riderId);
                    
                    const bBal = (await t.get(buyerRef)).data().balance;
                    if(bBal < total) throw "‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠";

                    t.update(buyerRef, { balance: bBal - total });
                    t.update(riderRef, { balance: (await t.get(riderRef)).data().balance + total });
                    t.update(db.collection('orders').doc(orderId), { status: 'completed' });
                    t.set(db.collection('transactions').doc(), { type:'pay', from:currentUser.uid, to:o.riderId, amt:total, ts:new Date() });
                });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß','success');
            } else {
                // ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                await db.collection('orders').doc(orderId).update({ status: 'completed' });
                Swal.fire('‡∏à‡∏ö‡∏á‡∏≤‡∏ô','‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÉ‡∏´‡πâ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå','success');
            }
        }

        async function deposit() {
            const {value: n} = await Swal.fire({title:'‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô', input:'number'});
            if(n) {
                await db.collection('transactions').add({uid:currentUser.uid, type:'deposit', amount:parseFloat(n), status:'pending'});
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß','‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','success');
            }
        }

        async function updateProfile() {
            await db.collection('users').doc(currentUser.uid).update({
                username: document.getElementById('p-name').value,
                phone: document.getElementById('p-phone').value
            });
            Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','','success');
        }

        function nav(page, el) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('page-home').style.display = page==='home'?'block':'none';
            document.getElementById('page-profile').style.display = page==='profile'?'block':'none';
        }
    </script>
</body>
</html>
