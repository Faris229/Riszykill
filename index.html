<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏° (RS SAVE Pro)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f4f6f9; }
        .main-card { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .auth-box { max-width: 450px; margin: 60px auto; }
        .img-preview { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; border: 2px dashed #ddd; display: none; margin-top: 10px; }
        .table-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .table-img:hover { transform: scale(1.5); }
        .blur-text { filter: blur(5px); cursor: pointer; transition: 0.3s; user-select: none; }
        .blur-text:hover { filter: blur(0px); }
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-gradient bg-primary shadow-sm hidden" id="mainNavbar">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#"><i class="bi bi-controller"></i> <span id="navStoreName">RS SHOP</span></a>
    <div class="d-flex align-items-center">
        <span class="text-white me-3 d-none d-md-block" id="userEmailDisplay"></span>
        <button class="btn btn-sm btn-light text-primary fw-bold" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>
</nav>

<div class="container" id="auth-section">
    <div class="card auth-box p-4 main-card">
        <div class="text-center mb-4">
            <h3 class="fw-bold text-primary">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏°</h3>
            <p class="text-muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
        </div>

        <ul class="nav nav-pills nav-fill mb-3 bg-light rounded p-1" id="authTab" role="tablist">
            <li class="nav-item"><button class="nav-link active rounded-pill" data-bs-toggle="pill" data-bs-target="#login-tab">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></li>
            <li class="nav-item"><button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#signup-tab">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="login-tab">
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="loginEmail" placeholder="Email">
                    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Password">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                </div>
                <button class="btn btn-primary w-100 py-2 fw-bold" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            
            <div class="tab-pane fade" id="signup-tab">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="signupStore" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô RS Store)</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="signupEmail" placeholder="Email">
                    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="signupPassword" placeholder="Password">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                </div>
                <button class="btn btn-success w-100 py-2 fw-bold" onclick="signup()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4 hidden" id="dashboard-section">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold m-0"><i class="bi bi-grid-fill text-primary"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h4>
        <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="bi bi-plus-lg"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏î‡∏µ‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>

    <ul class="nav nav-tabs nav-justified mb-3 border-0" id="dashTab">
        <li class="nav-item">
            <button class="nav-link active fw-bold border-0 border-bottom border-3 border-primary bg-white" data-bs-toggle="tab" data-bs-target="#stock-pane">
                üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold border-0 bg-white text-secondary" data-bs-toggle="tab" data-bs-target="#history-pane">
                üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="stock-pane">
            <div class="card main-card p-3 mb-3">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInput" class="form-control border-start-0" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°..." onkeyup="searchTable('stockTable')">
                </div>
            </div>
            
            <div class="card main-card overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="stockTable">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                                <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏≠‡∏î‡∏µ (‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™)</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="history-pane">
            <div class="card main-card overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="historyTable">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏£‡∏´‡∏±‡∏™</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏Å‡∏≥‡πÑ‡∏£</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12 text-center">
                        <label for="inpFile" class="btn btn-outline-secondary w-100 p-4 border-dashed">
                            <i class="bi bi-cloud-upload fs-2"></i><br>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </label>
                        <input type="file" id="inpFile" accept="image/*" class="d-none" onchange="previewImage()">
                        <img id="previewImg" class="img-preview mx-auto shadow-sm">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <input type="number" id="inpBuy" class="form-control" placeholder="0.00">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-success fw-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label>
                        <input type="number" id="inpSell" class="form-control border-success" placeholder="0.00">
                    </div>
                    
                    <div class="col-12"><hr></div>
                    
                    <div class="col-md-6">
                        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ / Username</label>
                        <input type="text" id="inpUser" class="form-control" placeholder="Login ID">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏Å‡∏° (Email)</label>
                        <input type="text" id="inpGameEmail" class="form-control" placeholder="example@gmail.com">
                    </div>
                    <div class="col-12">
                        <label class="form-label text-danger">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏° (Password)</label>
                        <input type="text" id="inpGamePass" class="form-control" placeholder="Password ‡∏Ç‡∏≠‡∏á‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary px-4" onclick="saveItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="msgToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Success!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  // Import Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // --- ‚öôÔ∏è CONFIG ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
  const firebaseConfig = {
    apiKey: "AIzaSyC-rPvq9fFvhnYQCWxKtLf4Y3UK1uMnP0c",
    authDomain: "rssave-6169a.firebaseapp.com",
    projectId: "rssave-6169a",
    storageBucket: "rssave-6169a.firebasestorage.app",
    messagingSenderId: "619695253658",
    appId: "1:619695253658:web:2d1e3ccb1d5a3c08491723",
    measurementId: "G-1KHNKSTELW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUserData = { storePrefix: 'RS', storeName: 'My Shop' };
  let currentImageBase64 = ""; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

  // --- Helper Functions ---
  const showToast = (msg, type='success') => {
      const el = document.getElementById('msgToast');
      document.getElementById('toastBody').innerText = msg;
      el.className = `toast align-items-center text-white bg-${type} border-0`;
      new bootstrap.Toast(el).show();
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô Base64 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏ô‡∏±‡∏Å Database)
  window.previewImage = () => {
      const file = document.getElementById('inpFile').files[0];
      if(file){
          const reader = new FileReader();
          reader.onloadend = () => {
              // ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö
              const img = new Image();
              img.src = reader.result;
              img.onload = () => {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 500px
                  const maxWidth = 500;
                  const scaleSize = maxWidth / img.width;
                  canvas.width = maxWidth;
                  canvas.height = img.height * scaleSize;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  
                  currentImageBase64 = canvas.toDataURL('image/jpeg', 0.7); // Quality 0.7
                  
                  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                  const preview = document.getElementById('previewImg');
                  preview.src = currentImageBase64;
                  preview.style.display = 'block';
              }
          }
          reader.readAsDataURL(file);
      }
  }

  // --- AUTH SYSTEM ---
  window.signup = async () => {
      const email = document.getElementById('signupEmail').value;
      const pass = document.getElementById('signupPassword').value;
      const store = document.getElementById('signupStore').value;
      if(!email || !pass || !store) return showToast("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "danger");
      
      try {
          await createUserWithEmailAndPassword(auth, email, pass);
          localStorage.setItem('storePrefix', store.substring(0, 2).toUpperCase());
          localStorage.setItem('storeName', store);
          showToast("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
      } catch(e) { showToast(e.message, "danger"); }
  }

  window.login = async () => {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      try {
          await signInWithEmailAndPassword(auth, email, pass);
      } catch(e) { showToast("Login failed: " + e.message, "danger"); }
  }

  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
      const authSec = document.getElementById('auth-section');
      const dashSec = document.getElementById('dashboard-section');
      const nav = document.getElementById('mainNavbar');
      
      if(user) {
          authSec.classList.add('d-none');
          dashSec.classList.remove('hidden');
          nav.classList.remove('hidden');
          
          currentUserData.storeName = localStorage.getItem('storeName') || 'Shop Admin';
          currentUserData.storePrefix = localStorage.getItem('storePrefix') || 'RS';
          
          document.getElementById('navStoreName').innerText = currentUserData.storeName;
          document.getElementById('userEmailDisplay').innerText = user.email;
          
          loadInventory();
          loadHistory();
      } else {
          authSec.classList.remove('d-none');
          dashSec.classList.add('hidden');
          nav.classList.add('hidden');
      }
  });

  // --- LOGIC: CREATE ---
  async function generateAutoID() {
      const q = query(collection(db, "products"), orderBy("createdAt", "desc"), limit(1));
      const snap = await getDocs(q);
      let newNum = 1;
      
      if(!snap.empty) {
          const lastCode = snap.docs[0].data().code;
          // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Prefix ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°
          if(lastCode.startsWith(currentUserData.storePrefix)) {
              const numPart = parseInt(lastCode.replace(currentUserData.storePrefix, ""));
              if(!isNaN(numPart)) newNum = numPart + 1;
          }
      }
      return currentUserData.storePrefix + String(newNum).padStart(3, '0');
  }

  window.saveItem = async () => {
      const buy = document.getElementById('inpBuy').value;
      const sell = document.getElementById('inpSell').value;
      const user = document.getElementById('inpUser').value;
      const email = document.getElementById('inpGameEmail').value;
      const pass = document.getElementById('inpGamePass').value;

      if(!buy || !sell) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤", "warning");

      // ‡∏õ‡∏¥‡∏î Modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
      modal.hide();
      showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", "info");

      try {
          const newCode = await generateAutoID();
          await addDoc(collection(db, "products"), {
              code: newCode,
              buyPrice: Number(buy),
              sellPrice: Number(sell),
              gameUser: user || "-",
              gameEmail: email || "-",
              gamePass: pass || "-",
              imageUrl: currentImageBase64 || "https://via.placeholder.com/100?text=No+Img", // ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Base64
              status: "available",
              createdAt: Timestamp.now(),
              soldAt: null
          });
          
          showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${newCode} ‡πÅ‡∏•‡πâ‡∏ß!`);
          
          // Reset Form
          document.getElementById('inpBuy').value = '';
          document.getElementById('inpSell').value = '';
          document.getElementById('inpUser').value = '';
          document.getElementById('inpGameEmail').value = '';
          document.getElementById('inpGamePass').value = '';
          document.getElementById('inpFile').value = '';
          document.getElementById('previewImg').style.display = 'none';
          currentImageBase64 = "";
          
          loadInventory();

      } catch(e) { showToast("Error: " + e.message, "danger"); }
  }

  // --- LOGIC: READ & DISPLAY ---
  async function loadInventory() {
      const q = query(collection(db, "products"), where("status", "==", "available"), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = "";

      if(snap.empty) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</td></tr>`; return; }

      snap.forEach(doc => {
          const d = doc.data();
          const tr = `
              <tr>
                  <td><img src="${d.imageUrl}" class="table-img shadow-sm" onclick="viewImage('${d.imageUrl}')"></td>
                  <td><span class="badge bg-dark text-white p-2" style="font-size:1em">${d.code}</span></td>
                  <td class="fw-bold text-success">${d.sellPrice.toLocaleString()} ‡∏ø</td>
                  <td>
                      <small class="text-muted"><i class="bi bi-envelope"></i> ${d.gameEmail}</small><br>
                      <small class="text-muted"><i class="bi bi-key"></i> Pass:</small> <span class="blur-text badge bg-light text-dark border">${d.gamePass}</span>
                  </td>
                  <td>
                      <button class="btn btn-warning btn-sm fw-bold shadow-sm" onclick="markSold('${doc.id}')">
                          <i class="bi bi-currency-dollar"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢
                      </button>
                  </td>
              </tr>
          `;
          tbody.innerHTML += tr;
      });
  }

  async function loadHistory() {
      const q = query(collection(db, "products"), where("status", "==", "sold"), orderBy("soldAt", "desc"));
      const snap = await getDocs(q);
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";

      if(snap.empty) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td></tr>`; return; }

      snap.forEach(doc => {
          const d = doc.data();
          const profit = d.sellPrice - d.buyPrice;
          const profitColor = profit >= 0 ? 'text-success' : 'text-danger';
          const profitSign = profit >= 0 ? '+' : '';
          
          // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
          let dateTxt = "-";
          if(d.soldAt) {
             const dt = d.soldAt.toDate();
             dateTxt = `${dt.getDate()}/${dt.getMonth()+1}/${dt.getFullYear()}`;
          }

          const tr = `
              <tr>
                  <td><span class="fw-bold text-secondary">${d.code}</span></td>
                  <td>${d.sellPrice.toLocaleString()}</td>
                  <td class="${profitColor} fw-bold">${profitSign}${profit.toLocaleString()}</td>
                  <td><small class="text-muted">${dateTxt}</small></td>
              </tr>
          `;
          tbody.innerHTML += tr;
      });
  }

  // --- LOGIC: UPDATE ---
  window.markSold = async (id) => {
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
      try {
          await updateDoc(doc(db, "products", id), {
              status: "sold",
              soldAt: Timestamp.now()
          });
          showToast("üí∞ ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!", "success");
          loadInventory();
          loadHistory();
      } catch(e) { showToast(e.message, "danger"); }
  }

  // --- EXTRA ---
  window.searchTable = (tableId) => {
      const val = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => {
          r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
      });
  }
  
  window.viewImage = (url) => {
      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô Tab ‡πÉ‡∏´‡∏°‡πà
      window.open(url, '_blank');
  }

  // Utility styles helper
  document.querySelector('.hidden').style.display = 'none'; // Initial hide
</script>

<style>
    .hidden { display: none !important; }
</style>

</body>
</html>
