<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RISZY SHOP - ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#005500',
                        'secondary': '#FFC72C',
                        'brand-green': '#009933',
                    },
                    fontFamily: { sans: ['Mitr', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Mitr', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800 pb-20">

    <!-- Navbar -->
    <nav class="bg-primary text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <span class="font-bold text-lg">RISZY SHOP</span>
            <div id="navMenu" class="hidden flex gap-3 text-sm">
                <button onclick="togglePage('home')">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="togglePage('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                <button onclick="logout()" class="text-red-300">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </nav>

    <div class="container max-w-md mx-auto p-4 mt-6">

        <!-- SYSTEM STATUS CHECK -->
        <div id="systemCheck" class="mb-4 p-2 text-xs text-center bg-yellow-100 text-yellow-800 rounded hidden">
            <i class="fas fa-wifi"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...
        </div>

        <!-- AUTH SECTION -->
        <div id="authSection" class="bg-white p-6 rounded-2xl shadow-lg fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-brand-green" id="authTitle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p class="text-gray-400 text-xs mt-1">Version 3.0 (Debug Mode)</p>
            </div>
            
            <form id="authForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
                    <input type="text" id="authUsername" class="w-full p-3 border rounded-xl bg-gray-50 focus:border-green-500 outline-none" placeholder="User001" required>
                </div>

                <div id="emailContainer" class="hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</label>
                    <input type="email" id="authEmail" class="w-full p-3 border rounded-xl bg-gray-50 focus:border-green-500 outline-none" placeholder="email@example.com">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                    <input type="password" id="authPassword" class="w-full p-3 border rounded-xl bg-gray-50 focus:border-green-500 outline-none" placeholder="******" required>
                </div>
                
                <button type="submit" id="authSubmitBtn" class="w-full py-3 bg-brand-green text-white font-bold rounded-xl shadow hover:bg-green-700 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>

            <div class="mt-4 text-center text-sm">
                <button id="toggleAuthMode" class="text-blue-600 font-bold hover:underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            
            <div class="mt-6 pt-4 border-t text-center">
                <button onclick="document.getElementById('adminPanel').classList.remove('hidden')" class="text-xs text-gray-400">Admin Login</button>
            </div>
        </div>

        <!-- APP SECTION -->
        <div id="appSection" class="hidden space-y-4 fade-in">
            <div id="userWelcome" class="text-center text-primary font-bold mb-4"></div>
            
            <!-- Home Page -->
            <div id="page-home">
                <div class="bg-white p-4 rounded-xl shadow mb-4">
                    <h3 class="font-bold mb-3 border-b pb-2">üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button onclick="setCategory('gem')" class="p-2 border rounded text-xs font-bold hover:bg-green-50">üíé ‡πÄ‡∏û‡∏ä‡∏£</button>
                        <button onclick="setCategory('account')" class="p-2 border rounded text-xs font-bold hover:bg-green-50">üÜî ‡πÑ‡∏≠‡∏î‡∏µ</button>
                        <button onclick="setCategory('program')" class="p-2 border rounded text-xs font-bold hover:bg-green-50">üéÆ ‡πÇ‡∏õ‡∏£</button>
                    </div>
                    <div id="productList" class="grid grid-cols-2 gap-2">
                        <!-- JS Insert Items -->
                    </div>
                </div>

                <!-- Order Form -->
                <div id="orderForm" class="hidden bg-white p-4 rounded-xl shadow border-2 border-brand-green">
                    <h4 id="selectedItemName" class="font-bold text-brand-green mb-2"></h4>
                    <input type="text" id="customerInfo" class="w-full p-2 border rounded mb-2 text-sm" placeholder="UID / ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ü‡∏™ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå">
                    <button onclick="confirmOrder()" class="w-full py-2 bg-secondary font-bold rounded shadow">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                    <button onclick="document.getElementById('orderForm').classList.add('hidden')" class="w-full py-2 mt-2 text-gray-400 text-xs">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>

            <!-- History Page -->
            <div id="page-history" class="hidden bg-white p-4 rounded-xl shadow">
                <h3 class="font-bold mb-3 border-b pb-2">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
                <div id="historyList" class="space-y-2 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black/90 z-50 p-4 overflow-y-auto text-left">
        <div class="max-w-md mx-auto bg-white rounded-lg p-4 mt-10">
            <div class="flex justify-between mb-4">
                <h2 class="font-bold text-xl">Admin System</h2>
                <button onclick="document.getElementById('adminPanel').classList.add('hidden')" class="text-red-500">‡∏õ‡∏¥‡∏î</button>
            </div>

            <div id="adminLoginBox">
                <input type="text" id="adminUser" placeholder="User" class="w-full border p-2 mb-2">
                <input type="password" id="adminPass" placeholder="Pass" class="w-full border p-2 mb-2">
                <button onclick="adminLogin()" class="w-full bg-black text-white py-2 rounded">Login</button>
            </div>

            <div id="adminContent" class="hidden space-y-4">
                <div class="bg-gray-100 p-2 rounded">
                    <h3 class="font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <input id="addName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full border p-1 mb-1 text-sm">
                    <input id="addPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" type="number" class="w-full border p-1 mb-1 text-sm">
                    <select id="addCat" class="w-full border p-1 mb-1 text-sm">
                        <option value="gem">‡πÄ‡∏û‡∏ä‡∏£</option>
                        <option value="account">‡πÑ‡∏≠‡∏î‡∏µ</option>
                        <option value="program">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</option>
                    </select>
                    <button onclick="addProduct()" class="bg-green-600 text-white px-4 py-1 rounded text-sm w-full">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
                
                <div class="bg-gray-100 p-2 rounded">
                    <h3 class="font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
                    <button onclick="loadAdminOrders()" class="bg-blue-500 text-white px-2 py-1 rounded text-xs mb-2">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    <div id="adminOrderList" class="text-xs space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, update, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        const firebaseConfig = {
  apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
  authDomain: "rsdm-9ca2a.firebaseapp.com",
  projectId: "rsdm-9ca2a",
  storageBucket: "rsdm-9ca2a.firebasestorage.app",
  messagingSenderId: "299212700124",
  appId: "1:299212700124:web:730160dae6bb1b09cbb719",
  measurementId: "G-CMX9GKW7FF"
};

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Variables
        let currentUser = null;
        let isRegisterMode = false;
        let selectedProduct = null;
        let currentCat = 'gem';

        // --- SYSTEM CHECK ---
        const sysCheck = document.getElementById('systemCheck');
        sysCheck.classList.remove('hidden');
        const connectedRef = ref(db, ".info/connected");
        onValue(connectedRef, (snap) => {
            if (snap.val() === true) {
                sysCheck.innerHTML = '<i class="fas fa-check-circle text-green-600"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                sysCheck.className = "mb-4 p-2 text-xs text-center bg-green-100 text-green-800 rounded";
                setTimeout(() => sysCheck.classList.add('hidden'), 3000);
            } else {
                sysCheck.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ (‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Rules ‡∏ú‡∏¥‡∏î)';
                sysCheck.className = "mb-4 p-2 text-xs text-center bg-red-100 text-red-800 rounded";
            }
        });

        // --- AUTH LOGIC ---
        const toggleBtn = document.getElementById('toggleAuthMode');
        const authTitle = document.getElementById('authTitle');
        const emailContainer = document.getElementById('emailContainer');
        const authSubmitBtn = document.getElementById('authSubmitBtn');

        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            if(isRegisterMode) {
                authTitle.innerText = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
                emailContainer.classList.remove('hidden');
                authSubmitBtn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£";
                toggleBtn.innerText = "‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            } else {
                authTitle.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                emailContainer.classList.add('hidden');
                authSubmitBtn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                toggleBtn.innerText = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà";
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value;
            const email = document.getElementById('authEmail').value.trim();

            if(!username || !password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            authSubmitBtn.disabled = true;
            authSubmitBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

            try {
                if(isRegisterMode) {
                    // REGISTER
                    if(!email) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•");
                    
                    // Check username duplicate
                    const userQuery = query(ref(db, 'users'), orderByChild('username'), equalTo(username));
                    const snap = await get(userQuery);
                    if(snap.exists()) throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß");

                    // Create Auth
                    const userCred = await createUserWithEmailAndPassword(auth, email, password);
                    // Save User Data
                    await set(ref(db, 'users/' + userCred.user.uid), {
                        username: username,
                        email: email,
                        role: 'user'
                    });
                    Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");

                } else {
                    // LOGIN (Username -> Email -> Auth)
                    // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Database Rule: .read = true
                    const userQuery = query(ref(db, 'users'), orderByChild('username'), equalTo(username));
                    const snap = await get(userQuery);

                    if(!snap.exists()) {
                        throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ (‡∏´‡∏£‡∏∑‡∏≠ Database Rules ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)");
                    }

                    const userData = Object.values(snap.val())[0];
                    const userEmail = userData.email;

                    await signInWithEmailAndPassword(auth, userEmail, password);
                    Swal.fire("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö", "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                }
            } catch (err) {
                console.error("Auth Error:", err);
                let msg = err.message;
                if(msg.includes("permission_denied")) msg = "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ Rules ‡πÉ‡∏ô Firebase Console)";
                if(msg.includes("auth/wrong-password")) msg = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î";
                if(msg.includes("auth/user-not-found")) msg = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", msg, "error");
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerText = isRegisterMode ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            }
        });

        // --- AUTH STATE ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('navMenu').classList.remove('hidden');
                
                // Get Username
                try {
                    const snap = await get(ref(db, 'users/' + user.uid));
                    if(snap.exists()) {
                        document.getElementById('userWelcome').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${snap.val().username}`;
                    }
                } catch(e) { console.log(e); }

                loadProducts(currentCat);
            } else {
                currentUser = null;
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
                document.getElementById('navMenu').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        // --- APP LOGIC ---
        window.togglePage = (page) => {
            document.getElementById('page-home').classList.add('hidden');
            document.getElementById('page-history').classList.add('hidden');
            document.getElementById(`page-${page}`).classList.remove('hidden');
            if(page === 'history') loadHistory();
        }

        window.setCategory = (cat) => {
            currentCat = cat;
            loadProducts(cat);
        }

        function loadProducts(cat) {
            const list = document.getElementById('productList');
            list.innerHTML = "Loading...";
            onValue(ref(db, 'products'), (snap) => {
                list.innerHTML = "";
                if(!snap.exists()) {
                    list.innerHTML = "<p class='col-span-2 text-center text-gray-400'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>";
                    return;
                }
                const data = snap.val();
                Object.entries(data).forEach(([key, item]) => {
                    if(item.category === cat) {
                        const div = document.createElement('div');
                        div.className = "border p-2 rounded text-center cursor-pointer hover:border-green-500 bg-white shadow-sm";
                        div.innerHTML = `
                            <div class="font-bold text-sm">${item.name}</div>
                            <div class="text-green-600 text-xs">${item.price} ‡∏ö‡∏≤‡∏ó</div>
                        `;
                        div.onclick = () => {
                            selectedProduct = { ...item, id: key };
                            document.getElementById('selectedItemName').innerText = `‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${item.name} (${item.price}‡∏ö.)`;
                            document.getElementById('orderForm').classList.remove('hidden');
                        };
                        list.appendChild(div);
                    }
                });
            });
        }

        window.confirmOrder = async () => {
            const info = document.getElementById('customerInfo').value;
            if(!info) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
            if(!selectedProduct) return;

            try {
                await push(ref(db, 'orders'), {
                    userId: currentUser.uid,
                    productId: selectedProduct.id,
                    productName: selectedProduct.name,
                    price: selectedProduct.price,
                    customerInfo: info,
                    status: 'pending',
                    timestamp: Date.now()
                });
                Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß", "success");
                document.getElementById('orderForm').classList.add('hidden');
                document.getElementById('customerInfo').value = '';
                togglePage('history');
            } catch(e) {
                alert("‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e.message);
            }
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            onValue(query(ref(db, 'orders'), orderByChild('userId'), equalTo(currentUser.uid)), (snap) => {
                list.innerHTML = "";
                if(!snap.exists()) {
                    list.innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
                    return;
                }
                const data = snap.val();
                // Sort client side
                const arr = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
                
                arr.forEach(order => {
                    let statusColor = order.status === 'pending' ? 'text-yellow-600' : (order.status==='completed'?'text-green-600':'text-red-600');
                    let statusText = order.status === 'pending' ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : (order.status==='completed'?'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à':'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
                    
                    list.innerHTML += `
                        <div class="border p-2 rounded bg-gray-50">
                            <div class="flex justify-between">
                                <span class="font-bold">${order.productName}</span>
                                <span class="${statusColor} font-bold text-xs">${statusText}</span>
                            </div>
                            <div class="text-xs text-gray-500">${new Date(order.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                });
            });
        }

        // --- ADMIN ---
        window.adminLogin = () => {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if(u === 'admin' && p === '1122') {
                document.getElementById('adminLoginBox').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                loadAdminOrders();
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
            }
        }

        window.addProduct = async () => {
            const name = document.getElementById('addName').value;
            const price = document.getElementById('addPrice').value;
            const cat = document.getElementById('addCat').value;
            if(name && price) {
                await push(ref(db, 'products'), { name, price: Number(price), category: cat });
                alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß");
            }
        }

        window.loadAdminOrders = () => {
            const list = document.getElementById('adminOrderList');
            onValue(ref(db, 'orders'), (snap) => {
                list.innerHTML = "";
                if(!snap.exists()) return;
                const data = snap.val();
                Object.entries(data).sort((a,b)=>b[1].timestamp-a[1].timestamp).forEach(([key, order]) => {
                    list.innerHTML += `
                        <div class="border p-2 bg-white mb-1">
                            <div>${order.productName} | ${order.customerInfo}</div>
                            <div class="flex gap-2 mt-1">
                                <button onclick="setStatus('${key}', 'completed')" class="bg-green-500 text-white px-1 rounded">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button onclick="setStatus('${key}', 'cancelled')" class="bg-red-500 text-white px-1 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.setStatus = (key, status) => {
            update(ref(db, `orders/${key}`), { status });
        }

        // Expose to window
        window.toggleAuthMode = () => {}; 
    </script>
</body>
</html>
