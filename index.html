<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FoodRunner | ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #ff4757;
            --primary-light: #ff6b81;
            --bg: #f8f9fa;
            --text-dark: #2f3542;
            --text-grey: #a4b0be;
            --card-bg: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: var(--text-dark); margin: 0; padding-bottom: 80px; }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 3000; padding: 30px; display: flex; flex-direction: column; justify-content: center; }
        .logo-box { text-align: center; margin-bottom: 30px; }
        .logo-icon { font-size: 3.5rem; color: var(--primary); margin-bottom: 10px; animation: bounce 2s infinite; }
        
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #dfe4ea; border-radius: 12px; margin-bottom: 12px; font-family: inherit; background: #f1f2f6; font-size: 1rem; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1); }

        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }
        .btn-ghost { background: transparent; color: var(--text-grey); margin-top: 10px; }

        /* --- APP STRUCTURE --- */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 1.5rem; font-weight: 800; color: var(--text-dark); }
        
        /* 1. HOME & WALLET */
        .wallet-card { 
            background: linear-gradient(135deg, #2f3542, #57606f); color: white; 
            border-radius: 20px; padding: 25px; margin-bottom: 25px; 
            box-shadow: 0 10px 20px rgba(47, 53, 66, 0.3); position: relative; overflow: hidden;
        }
        .balance-label { font-size: 0.85rem; opacity: 0.8; letter-spacing: 1px; text-transform: uppercase; }
        .balance-val { font-size: 2.2rem; font-weight: 700; margin: 5px 0 15px 0; }
        .w-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .w-btn { background: rgba(255,255,255,0.15); border: none; color: white; padding: 8px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(5px); font-size: 0.9rem; }

        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; color: var(--text-dark); }
        
        .order-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); position: relative; border-left: 5px solid #ccc; transition: transform 0.2s; }
        .order-card:active { transform: scale(0.98); }
        .order-card.pending { border-left-color: #ffa502; }
        .order-card.accepted { border-left-color: #3742fa; }
        .order-card.delivering { border-left-color: #2ed573; }
        .order-card.completed { border-left-color: #a4b0be; opacity: 0.7; }
        
        .status-badge { position: absolute; top: 15px; right: 15px; font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: #f1f2f6; font-weight: bold; }

        /* 2. ORDER PAGE */
        .form-card { background: white; border-radius: 20px; padding: 25px; box-shadow: var(--shadow); }
        .form-group label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: var(--text-dark); }
        
        /* 3. CHAT LIST PAGE */
        .chat-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; box-shadow: var(--shadow); transition: 0.2s; }
        .chat-item:active { transform: scale(0.98); background: #f1f2f6; }
        .chat-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: white; flex-shrink: 0; }
        .chat-info { flex: 1; }
        .chat-name { font-weight: bold; font-size: 1rem; }
        .chat-sub { font-size: 0.8rem; color: var(--text-grey); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        /* 4. PROFILE */
        .profile-head { text-align: center; margin-bottom: 30px; }
        .avatar { width: 80px; height: 80px; background: #dfe4ea; border-radius: 50%; margin: 0 auto 10px; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: #747d8c; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px 0; display: flex; justify-content: space-around; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-radius: 20px 20px 0 0; }
        .nav-item { text-align: center; color: var(--text-grey); font-size: 0.75rem; cursor: pointer; transition: 0.2s; width: 25%; }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.active i { transform: translateY(-2px); }

        /* CHAT ROOM MODAL */
        .chat-screen { position: fixed; inset: 0; background: #f8f9fa; z-index: 2000; display: none; flex-direction: column; }
        .chat-screen.active { display: flex; animation: slideIn 0.3s; }
        .chat-top { background: white; padding: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chat-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-bottom { background: white; padding: 10px; display: flex; gap: 10px; border-top: 1px solid #eee; }
        
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 0.9rem; line-height: 1.4; position: relative; }
        .msg-me { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background: white; border: 1px solid #eee; align-self: flex-start; border-bottom-left-radius: 2px; }

        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateX(100%);} to {transform: translateX(0);} }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="logo-box">
            <i class="fa-solid fa-burger logo-icon"></i>
            <h1>FoodRunner</h1>
            <p style="color:#a4b0be;">‡∏™‡∏±‡πà‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏î‡πâ‡πÑ‡∏ß ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
        </div>

        <div id="login-form">
            <input id="l-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
            <input id="l-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn btn-primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn btn-ghost" onclick="toggleAuth('reg')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <div id="reg-form" style="display:none;">
            <h3>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
            <input id="r-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
            <input id="r-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
            <input id="r-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
            <input id="r-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            
            <div style="background:#f1f2f6; padding:15px; border-radius:12px; margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:bold; color:#57606f;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)</label>
                <select id="r-bank" style="margin-top:5px;">
                    <option value="kbank">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
                    <option value="scb">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
                    <option value="wallet">TrueMoney Wallet</option>
                </select>
                <input id="r-bank-no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå" style="margin-bottom:0;">
            </div>

            <button class="btn btn-primary" onclick="register()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
            <button class="btn btn-ghost" onclick="toggleAuth('login')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="app" style="display:none;">
        
        <div id="page-home" class="page active">
            <div class="header">
                <div class="title">FoodRunner</div>
                <div style="font-size:0.9rem; font-weight:bold; color:var(--text-grey);">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="u-name">User</span></div>
            </div>

            <div class="wallet-card">
                <div class="balance-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="balance-val">‡∏ø <span id="u-bal">0.00</span></div>
                <div class="w-actions">
                    <button class="w-btn" onclick="deposit()"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <button class="w-btn" onclick="withdraw()"><i class="fa-solid fa-arrow-right-from-bracket"></i> ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>

            <div class="section-title">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
            <div id="my-orders-list">
                <div style="text-align:center; padding:30px; color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
            </div>
        </div>

        <div id="page-order" class="page">
            <div class="header"><div class="title">‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div></div>
            
            <div class="form-card">
                <div class="form-group">
                    <label>‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£?</label>
                    <input id="ord-menu" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà, ‡∏ä‡∏≤‡∏ô‡∏°‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å">
                </div>
                <div class="form-group">
                    <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ö‡∏≤‡∏ó)</label>
                    <input id="ord-price" type="number" placeholder="0">
                </div>
                <div class="form-group">
                    <label>‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏´‡∏¥‡πâ‡∏ß‡∏û‡∏µ‡πà‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? (‡∏ö‡∏≤‡∏ó)</label>
                    <input id="ord-tip" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20, 30, 50">
                </div>
                <div class="form-group">
                    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á / ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏û‡∏ö</label>
                    <textarea id="ord-addr" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô..."></textarea>
                </div>
                <div class="form-group">
                    <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <select id="ord-pay">
                        <option value="wallet">üí≥ ‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏î)</option>
                        <option value="cash">üíµ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="createOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</button>
            </div>
        </div>

        <div id="page-chat" class="page">
            <div class="header"><div class="title">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div></div>
            
            <div class="chat-item" onclick="openChat('admin', 'support')">
                <div class="chat-icon" style="background:#ff9f43;"><i class="fa-solid fa-headset"></i></div>
                <div class="chat-info">
                    <div class="chat-name">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
                    <div class="chat-sub">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤</div>
                </div>
            </div>

            <div class="section-title" style="margin-top:20px; font-size:0.9rem;">‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
            <div id="rider-chat-list">
                </div>
        </div>

        <div id="page-profile" class="page">
            <div class="header"><div class="title">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div></div>
            
            <div class="profile-head">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <h3 id="p-name">User Name</h3>
                <p id="p-email" style="color:#aaa;">user@email.com</p>
            </div>

            <div class="form-card">
                <label>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
                <select id="p-bank" style="margin-top:5px;">
                    <option value="kbank">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
                    <option value="scb">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
                    <option value="wallet">TrueMoney Wallet</option>
                </select>
                <input id="p-bank-no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
                <button class="btn btn-primary" onclick="updateProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <button class="btn btn-ghost" style="color:#ff4757; margin-top:20px;" onclick="auth.signOut()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('home', this)">
                <i class="fa-solid fa-house"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </div>
            <div class="nav-item" onclick="nav('order', this)">
                <i class="fa-solid fa-receipt"></i> ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </div>
            <div class="nav-item" onclick="nav('chat', this)">
                <i class="fa-solid fa-comment-dots"></i> ‡πÅ‡∏ä‡∏ó
            </div>
            <div class="nav-item" onclick="nav('profile', this)">
                <i class="fa-solid fa-user"></i> ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
            </div>
        </div>
    </div>

    <div id="chat-screen" class="chat-screen">
        <div class="chat-top">
            <button onclick="closeChat()" style="background:none; border:none; font-size:1.2rem;"><i class="fa-solid fa-chevron-left"></i></button>
            <div style="font-weight:bold; font-size:1.1rem;" id="chat-title">Title</div>
        </div>
        <div class="chat-area" id="chat-msgs"></div>
        <div class="chat-bottom">
            <input id="chat-inp" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex:1; padding:12px; border:1px solid #ddd; border-radius:20px; margin:0;">
            <button onclick="sendMessage()" style="width:45px; height:45px; background:var(--primary); color:white; border:none; border-radius:50%; box-shadow:0 2px 10px rgba(255, 71, 87, 0.4);"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentChatType = ''; // 'admin' or 'rider'
        let currentChatId = ''; // if rider -> orderId, if admin -> uid

        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                loadUserData();
                loadMyOrders();
                loadRiderChats();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // --- AUTH ---
        function toggleAuth(mode) {
            document.getElementById('login-form').style.display = mode==='login'?'block':'none';
            document.getElementById('reg-form').style.display = mode==='reg'?'block':'none';
        }
        async function register() {
            const email = document.getElementById('r-email').value;
            const pass = document.getElementById('r-pass').value;
            const name = document.getElementById('r-name').value;
            const phone = document.getElementById('r-phone').value;
            const bank = document.getElementById('r-bank').value;
            const bankNo = document.getElementById('r-bank-no').value;

            try {
                const c = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(c.user.uid).set({
                    email, username: name, phone, bankName: bank, bankNo: bankNo, 
                    role: 'customer', balance: 0, createdAt: new Date()
                });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }
        function login() {
            auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value)
                .catch(e => Swal.fire('Error', e.message, 'error'));
        }

        // --- DATA ---
        function loadUserData() {
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('u-name').innerText = d.username;
                document.getElementById('p-name').innerText = d.username;
                document.getElementById('p-email').innerText = d.email;
                document.getElementById('u-bal').innerText = d.balance.toFixed(2);
                document.getElementById('p-bank').value = d.bankName;
                document.getElementById('p-bank-no').value = d.bankNo;
            });
        }

        function loadMyOrders() {
            db.collection('orders').where('buyerId','==',currentUser.uid).orderBy('timestamp','desc').onSnapshot(snap => {
                const div = document.getElementById('my-orders-list');
                if(snap.empty) {
                    div.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>';
                    return;
                }
                div.innerHTML = '';
                snap.forEach(doc => {
                    const o = doc.data();
                    const statusMap = {'pending':'‡∏£‡∏≠‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', 'accepted':'‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'buying':'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠', 'delivering':'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡∏™‡πà‡∏á', 'completed':'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'};
                    
                    // Button Logic
                    let actionBtn = '';
                    if(o.status === 'delivering') {
                        actionBtn = `<button onclick="completeOrder('${doc.id}')" style="width:100%; padding:10px; background:#2ed573; color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏ö‡∏á‡∏≤‡∏ô)</button>`;
                    }

                    div.innerHTML += `
                        <div class="order-card ${o.status}">
                            <span class="status-badge">${statusMap[o.status]}</span>
                            <div style="font-weight:bold; font-size:1.1rem;">${o.menu}</div>
                            <div style="font-size:0.9rem; color:#666;">${o.address}</div>
                            <div style="margin-top:5px; color:var(--primary); font-weight:bold;">
                                ‡∏£‡∏≤‡∏Ñ‡∏≤: ${o.price+o.tip} ‡∏ø <span style="color:#aaa; font-weight:normal; font-size:0.8rem;">(${o.payment})</span>
                            </div>
                            ${actionBtn}
                        </div>
                    `;
                });
            });
        }

        // --- ORDERING ---
        async function createOrder() {
            const menu = document.getElementById('ord-menu').value;
            const price = parseFloat(document.getElementById('ord-price').value);
            const tip = parseFloat(document.getElementById('ord-tip').value);
            const addr = document.getElementById('ord-addr').value;
            const pay = document.getElementById('ord-pay').value;

            if(!menu || !price || !tip || !addr) return Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','','warning');

            if(pay === 'wallet') {
                const uDoc = await db.collection('users').doc(currentUser.uid).get();
                if(uDoc.data().balance < (price + tip)) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô','error');
            }

            await db.collection('orders').add({
                buyerId: currentUser.uid, menu, price, tip, address: addr, payment: pay,
                status: 'pending', riderId: null, timestamp: new Date()
            });
            Swal.fire('‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','‡∏£‡∏≠‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô','success').then(()=>{
                document.getElementById('ord-menu').value = '';
                nav('home', document.querySelectorAll('.nav-item')[0]);
            });
        }

        async function completeOrder(id) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß?')) return;
            const orderRef = db.collection('orders').doc(id);
            const o = (await orderRef.get()).data();
            const total = o.price + o.tip;

            if(o.payment === 'wallet') {
                await db.runTransaction(async t => {
                    const buyerRef = db.collection('users').doc(currentUser.uid);
                    const riderRef = db.collection('users').doc(o.riderId);
                    const bBal = (await t.get(buyerRef)).data().balance;
                    
                    if(bBal < total) throw "‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠";
                    
                    const rBal = (await t.get(riderRef)).data().balance;
                    t.update(buyerRef, { balance: bBal - total });
                    t.update(riderRef, { balance: rBal + total });
                    t.update(orderRef, { status: 'completed' });
                    
                    const txRef = db.collection('transactions').doc();
                    t.set(txRef, { type:'payment', from:currentUser.uid, to:o.riderId, amount:total, order:id, timestamp: new Date() });
                });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
            } else {
                await orderRef.update({ status: 'completed' });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
            }
        }

        // --- WALLET ---
        async function deposit() {
            const {value:n} = await Swal.fire({title:'‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô', input:'number'});
            if(n) {
                await db.collection('transactions').add({uid:currentUser.uid, type:'deposit', amount:parseFloat(n), status:'pending'});
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß','‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','success');
            }
        }
        async function withdraw() {
            const {value:n} = await Swal.fire({title:'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏´‡∏±‡∏Å 1 ‡∏ö‡∏≤‡∏ó)', input:'number'});
            if(n) {
                const amt = parseFloat(n);
                const u = (await db.collection('users').doc(currentUser.uid).get()).data();
                if(u.balance < amt+1) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','','error');
                
                await db.collection('transactions').add({uid:currentUser.uid, type:'withdraw', amount:amt, fee:1, total:amt+1, status:'pending'});
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß','','success');
            }
        }

        async function updateProfile() {
            await db.collection('users').doc(currentUser.uid).update({
                bankName: document.getElementById('p-bank').value,
                bankNo: document.getElementById('p-bank-no').value
            });
            Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','','success');
        }

        // --- CHAT SYSTEM ---
        function loadRiderChats() {
            // Find orders where status is accepted/buying/delivering
            db.collection('orders').where('buyerId','==',currentUser.uid).onSnapshot(snap => {
                const div = document.getElementById('rider-chat-list');
                div.innerHTML = '';
                snap.forEach(doc => {
                    const o = doc.data();
                    if(o.riderId && o.status !== 'completed') {
                        div.innerHTML += `
                            <div class="chat-item" onclick="openChat('rider', '${doc.id}', '${o.menu}')">
                                <div class="chat-icon" style="background:#2ed573;"><i class="fa-solid fa-motorcycle"></i></div>
                                <div class="chat-info">
                                    <div class="chat-name">‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${o.menu})</div>
                                    <div class="chat-sub">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏¢...</div>
                                </div>
                            </div>
                        `;
                    }
                });
            });
        }

        let chatUnsub = null;
        function openChat(type, id, title='Admin Support') {
            currentChatType = type;
            currentChatId = id;
            document.getElementById('chat-screen').classList.add('active');
            document.getElementById('chat-title').innerText = title;
            
            const div = document.getElementById('chat-msgs');
            div.innerHTML = '';

            let ref;
            if(type === 'admin') {
                ref = db.collection('support_msgs').where('roomId','==',currentUser.uid).orderBy('time');
                currentChatId = currentUser.uid; // Room ID for admin chat is user uid
            } else {
                ref = db.collection('orders').doc(id).collection('chat').orderBy('time');
            }

            if(chatUnsub) chatUnsub();
            chatUnsub = ref.onSnapshot(snap => {
                div.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const cls = m.uid === currentUser.uid ? 'msg-me' : 'msg-other';
                    div.innerHTML += `<div class="msg ${cls}">${m.msg}</div>`;
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        async function sendMessage() {
            const txt = document.getElementById('chat-inp').value;
            if(!txt) return;

            if(currentChatType === 'admin') {
                // Update Parent for Admin list
                await db.collection('support').doc(currentUser.uid).set({
                    uid: currentUser.uid, email: currentUser.email, lastMsg: txt, status: 'pending', timestamp: new Date()
                }, {merge:true});
                
                await db.collection('support_msgs').add({
                    roomId: currentUser.uid, uid: currentUser.uid, msg: txt, time: new Date()
                });
            } else {
                await db.collection('orders').doc(currentChatId).collection('chat').add({
                    uid: currentUser.uid, msg: txt, time: new Date()
                });
            }
            document.getElementById('chat-inp').value = '';
        }

        function closeChat() { document.getElementById('chat-screen').classList.remove('active'); }

        // --- NAVIGATION ---
        function nav(page, el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(el) el.classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-'+page).classList.add('active');
        }
    </script>
</body>
</html>
