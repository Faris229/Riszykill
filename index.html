<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RISZY SHOP - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#005500',
                        'secondary': '#FFC72C',
                        'light-bg': '#f3f4f6',
                        'brand-green': '#009933',
                        'brand-dark': '#004d00',
                    },
                    fontFamily: {
                        sans: ['Mitr', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Mitr', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background-color: #FEF3C7; color: #D97706; }
        .status-success { background-color: #D1FAE5; color: #059669; }
        .status-cancel { background-color: #FEE2E2; color: #DC2626; }
    </style>
</head>
<body class="text-gray-800 pb-20">

    <nav class="bg-primary text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="https://i.postimg.cc/CdpMCWTh/IMG-9993.png" class="w-10 h-10 rounded-full border-2 border-secondary bg-white">
                <span class="font-bold text-lg tracking-wide">RISZY SHOP</span>
            </div>
            <div class="flex gap-3">
                <button onclick="togglePage('home')" class="hover:text-secondary transition"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="togglePage('history')" id="navHistoryBtn" class="hidden hover:text-secondary transition"><i class="fas fa-history"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                <button onclick="logout()" id="navLogoutBtn" class="hidden text-red-300 hover:text-red-100 transition"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container max-w-2xl mx-auto p-4 mt-6">

        <div id="authSection" class="glass-panel p-6 rounded-2xl shadow-md bg-white">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-brand-dark" id="authTitle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p class="text-gray-500 text-sm">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            </div>
            
            <form id="authForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="authEmail" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-brand-green outline-none" placeholder="example@email.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="authPassword" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-brand-green outline-none" placeholder="******" required>
                </div>
                
                <button type="submit" id="authSubmitBtn" class="w-full py-3 bg-brand-green hover:bg-green-700 text-white font-bold rounded-xl shadow transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>

            <div class="mt-4 text-center text-sm">
                <span id="authSwitchText" class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?</span>
                <button id="authSwitchBtn" class="text-modern-blue font-bold hover:underline text-blue-600">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>

            <div class="mt-6 border-t pt-4 text-center">
                <button onclick="openAdminLogin()" class="text-xs text-gray-400 hover:text-gray-600">Admin Login</button>
            </div>
        </div>

        <div id="appSection" class="hidden space-y-6">
            
            <div id="page-home" class="page-content">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold text-primary mb-4 flex items-center"><i class="fas fa-shopping-bag mr-2"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    
                    <div class="grid grid-cols-3 gap-2 mb-6" id="categoryTabs">
                        <button onclick="filterCategory('gem')" class="cat-btn p-2 rounded-lg border text-sm font-bold bg-green-50 border-brand-green text-brand-green">üíé ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏°</button>
                        <button onclick="filterCategory('account')" class="cat-btn p-2 rounded-lg border text-sm text-gray-500 hover:bg-gray-50">üÜî ‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°</button>
                        <button onclick="filterCategory('program')" class="cat-btn p-2 rounded-lg border text-sm text-gray-500 hover:bg-gray-50">üéÆ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</button>
                    </div>

                    <div id="productsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                        <div class="col-span-full text-center py-10 text-gray-400">
                            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...
                        </div>
                    </div>

                    <div id="orderForm" class="hidden border-t pt-6">
                        <h4 class="font-bold text-gray-700 mb-3" id="selectedProductName">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: -</h4>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1" id="dynamicInputLabel">UID ‡πÄ‡∏Å‡∏° / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                            <input type="text" id="customerInput" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-brand-green outline-none bg-gray-50" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...">
                        </div>

                        <button onclick="submitOrder()" class="w-full py-3 bg-secondary hover:bg-yellow-400 text-brand-dark font-bold rounded-xl shadow-lg transform active:scale-95 transition">
                            <i class="fas fa-check-circle mr-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                        </button>
                    </div>
                </div>
            </div>

            <div id="page-history" class="page-content hidden">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-list-alt mr-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
                    <div id="orderHistoryList" class="space-y-3">
                        <p class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                    </div>
                </div>
            </div>

        </div>

        <div id="adminPanel" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 z-[100] overflow-y-auto">
            <div class="max-w-4xl mx-auto p-4 min-h-screen">
                <div class="flex justify-between items-center mb-6 text-white">
                    <h1 class="text-2xl font-bold text-secondary">Admin Dashboard</h1>
                    <button onclick="closeAdminPanel()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
                </div>

                <div id="adminLoginForm" class="bg-white p-8 rounded-xl shadow-2xl max-w-md mx-auto mt-20">
                    <h2 class="text-xl font-bold text-center mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
                    <input type="text" id="adminUser" placeholder="Username" class="w-full p-3 border rounded-lg mb-3">
                    <input type="password" id="adminPass" placeholder="Password" class="w-full p-3 border rounded-lg mb-4">
                    <button onclick="checkAdminLogin()" class="w-full py-2 bg-primary text-white rounded-lg font-bold">Login</button>
                </div>

                <div id="adminContent" class="hidden space-y-6">
                    
                    <div class="flex gap-2 bg-gray-800 p-2 rounded-lg">
                        <button onclick="switchAdminTab('orders')" class="flex-1 py-2 rounded bg-secondary text-brand-dark font-bold text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
                        <button onclick="switchAdminTab('stock')" class="flex-1 py-2 rounded text-white hover:bg-gray-700 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    </div>

                    <div id="admin-tab-orders" class="bg-white p-4 rounded-xl text-black">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase">
                                    <tr>
                                        <th class="p-3">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                        <th class="p-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="p-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="adminOrderTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="admin-tab-stock" class="hidden space-y-4">
                        
                        <div class="bg-white p-4 rounded-xl text-black">
                            <h3 class="font-bold text-lg mb-4 border-b pb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="newProdName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏û‡∏ä‡∏£ 100)" class="border p-2 rounded">
                                <select id="newProdCat" class="border p-2 rounded">
                                    <option value="gem">‡∏´‡∏°‡∏ß‡∏î: ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏°</option>
                                    <option value="account">‡∏´‡∏°‡∏ß‡∏î: ‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°</option>
                                    <option value="program">‡∏´‡∏°‡∏ß‡∏î: ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</option>
                                </select>
                                <input id="newProdPrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" class="border p-2 rounded">
                                <button onclick="addNewProduct()" class="bg-green-600 text-white p-2 rounded font-bold hover:bg-green-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl text-black">
                            <h3 class="font-bold text-lg mb-4 border-b pb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î/‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</label>
                                <select id="stockProdSelect" class="w-full border p-2 rounded bg-gray-50"></select>
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡πÇ‡∏Ñ‡πâ‡∏î)</label>
                                <textarea id="stockCodesArea" rows="5" class="w-full border p-2 rounded" placeholder="CODE1234&#10;CODE5678&#10;CODE9012"></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="addStockCodes()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î</button>
                                <button onclick="clearAllCodes()" class="px-4 py-2 bg-red-100 text-red-600 rounded font-bold hover:bg-red-200">‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl text-black">
                            <h3 class="font-bold text-lg mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                            <ul id="adminProductList" class="space-y-2"></ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <a href="https://www.facebook.com/p/Riszy-shop-61570552356915/" target="_blank" class="fixed bottom-5 right-5 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition z-40">
        <i class="fab fa-facebook-f text-xl"></i>
    </a>

    <script type="module">
        // --- 1. FIREBASE CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-rPvq9fFvhnYQCWxKtLf4Y3UK1uMnP0c",
            authDomain: "rssave-6169a.firebaseapp.com",
            databaseURL: "https://rssave-6169a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rssave-6169a",
            storageBucket: "rssave-6169a.firebasestorage.app",
            messagingSenderId: "619695253658",
            appId: "1:619695253658:web:4cd77e7fff5c4718491723",
            measurementId: "G-LMS63E7P3F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- 2. GLOBAL VARIABLES ---
        let currentUser = null;
        let selectedProduct = null;
        let currentCategory = 'gem';

        // --- 3. AUTH LOGIC ---
        const authForm = document.getElementById('authForm');
        const authSwitchBtn = document.getElementById('authSwitchBtn');
        let isLoginMode = true;

        authSwitchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            document.getElementById('authSubmitBtn').innerText = isLoginMode ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            document.getElementById('authSwitchText').innerText = isLoginMode ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?' : '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß?';
            authSwitchBtn.innerText = isLoginMode ? '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    // Create user profile in DB
                    const user = auth.currentUser;
                    set(ref(db, 'users/' + user.uid), {
                        email: email,
                        role: 'user'
                    });
                }
                Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
            } catch (error) {
                Swal.fire({ icon: 'error', title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: error.message });
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('navHistoryBtn').classList.remove('hidden');
                document.getElementById('navLogoutBtn').classList.remove('hidden');
                
                loadProducts(currentCategory);
                listenToMyOrders();
            } else {
                currentUser = null;
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
                document.getElementById('navHistoryBtn').classList.add('hidden');
                document.getElementById('navLogoutBtn').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        // --- 4. CUSTOMER APP LOGIC ---
        
        // Tab Switching
        window.togglePage = (pageName) => {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageName}`).classList.remove('hidden');
        };

        // Category Filter
        window.filterCategory = (cat) => {
            currentCategory = cat;
            // Update buttons UI
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('bg-green-50', 'border-brand-green', 'text-brand-green');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            event.target.classList.remove('text-gray-500', 'border-transparent');
            event.target.classList.add('bg-green-50', 'border-brand-green', 'text-brand-green');

            loadProducts(cat);
            // Reset selection
            selectedProduct = null;
            document.getElementById('orderForm').classList.add('hidden');
        };

        // Load Products
        function loadProducts(category) {
            const productsRef = ref(db, 'products');
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '<div class="col-span-full text-center"><i class="fas fa-spinner fa-spin"></i></div>';

            onValue(productsRef, (snapshot) => {
                grid.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>';
                    return;
                }

                let hasProduct = false;
                Object.entries(data).forEach(([key, product]) => {
                    if (product.category === category) {
                        hasProduct = true;
                        const div = document.createElement('div');
                        div.className = `cursor-pointer border rounded-xl p-4 flex flex-col items-center justify-center transition hover:shadow-md hover:border-brand-green bg-white h-32 relative`;
                        div.onclick = () => selectProduct(key, product);
                        div.innerHTML = `
                            <div class="text-center font-bold text-primary text-sm mb-1">${product.name}</div>
                            <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">${product.price} ‡∏ö‡∏≤‡∏ó</div>
                        `;
                        grid.appendChild(div);
                    }
                });

                if (!hasProduct) {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>';
                }
            });
        }

        window.selectProduct = (key, product) => {
            selectedProduct = { ...product, id: key };
            document.getElementById('selectedProductName').innerHTML = `<span class="text-primary">${product.name}</span> <span class="text-gray-400 text-sm">(${product.price} ‡∏ö.)</span>`;
            document.getElementById('orderForm').classList.remove('hidden');
            
            // Highlight selection visually
            const allBoxes = document.getElementById('productsGrid').children;
            for(let box of allBoxes) { box.classList.remove('ring-2', 'ring-brand-green', 'bg-green-50'); }
            event.currentTarget.classList.add('ring-2', 'ring-brand-green', 'bg-green-50');

            // Dynamic Placeholder
            const input = document.getElementById('customerInput');
            const label = document.getElementById('dynamicInputLabel');
            if (product.category === 'gem') {
                label.innerText = 'UID ‡πÄ‡∏Å‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°)';
                input.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å UID ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
            } else {
                label.innerText = '‡∏ä‡∏∑‡πà‡∏≠ Facebook / ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠';
                input.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ü‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ü‡∏™';
            }
        };

        window.submitOrder = async () => {
            const inputVal = document.getElementById('customerInput').value.trim();
            if (!inputVal) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
            if (!selectedProduct) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'warning');

            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const newOrderRef = push(ref(db, 'orders'));
                await set(newOrderRef, {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    productId: selectedProduct.id,
                    productName: selectedProduct.name,
                    price: selectedProduct.price,
                    customerInfo: inputVal, // UID or Contact
                    category: selectedProduct.category,
                    status: 'pending', // pending, completed, cancelled
                    timestamp: Date.now()
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥',
                    confirmButtonColor: '#009933'
                });

                document.getElementById('customerInput').value = '';
                document.getElementById('orderForm').classList.add('hidden');
                togglePage('history'); // Go to history page

            } catch (error) {
                console.error(error);
                Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', 'error');
            }
        };

        function listenToMyOrders() {
            if (!currentUser) return;
            const ordersRef = ref(db, 'orders');
            onValue(ordersRef, (snapshot) => {
                const list = document.getElementById('orderHistoryList');
                list.innerHTML = '';
                const data = snapshot.val();
                
                if (!data) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                    return;
                }

                // Filter client side for simplicity (or use query in Firebase)
                const myOrders = Object.entries(data)
                    .filter(([key, order]) => order.userId === currentUser.uid)
                    .sort((a, b) => b[1].timestamp - a[1].timestamp);

                if (myOrders.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                    return;
                }

                myOrders.forEach(([key, order]) => {
                    let statusHtml = '';
                    let noteHtml = '';
                    
                    if (order.status === 'pending') {
                        statusHtml = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                    } else if (order.status === 'completed') {
                        statusHtml = '<span class="status-badge status-success"><i class="fas fa-check"></i> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
                        if (order.code) { // If admin attached a code
                             noteHtml = `<div class="mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm font-mono text-green-800 break-all select-all">Code: ${order.code}</div>`;
                        }
                    } else {
                        statusHtml = '<span class="status-badge status-cancel"><i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
                    }

                    const date = new Date(order.timestamp).toLocaleString('th-TH');

                    const item = document.createElement('div');
                    item.className = 'bg-gray-50 p-4 rounded-xl border border-gray-100';
                    item.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800">${order.productName}</h4>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                            ${statusHtml}
                        </div>
                        <p class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span class="font-medium">${order.customerInfo}</span></p>
                        ${noteHtml}
                    `;
                    list.appendChild(item);
                });
            });
        }


        // --- 5. ADMIN LOGIC ---
        
        window.openAdminLogin = () => {
            document.getElementById('adminPanel').classList.remove('hidden');
        };
        window.closeAdminPanel = () => {
            document.getElementById('adminPanel').classList.add('hidden');
        };

        window.checkAdminLogin = () => {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if (u === 'admin' && p === '1122') {
                document.getElementById('adminLoginForm').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                initAdminDashboard();
            } else {
                Swal.fire('Error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        };

        window.switchAdminTab = (tab) => {
            document.getElementById('admin-tab-orders').classList.add('hidden');
            document.getElementById('admin-tab-stock').classList.add('hidden');
            document.getElementById(`admin-tab-${tab}`).classList.remove('hidden');
            
            // Visual feedback for buttons could be added here
        };

        function initAdminDashboard() {
            // Listen to all orders
            onValue(ref(db, 'orders'), (snapshot) => {
                const tbody = document.getElementById('adminOrderTable');
                tbody.innerHTML = '';
                const data = snapshot.val();
                if (!data) return;

                // Sort newest first
                const orders = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);

                orders.forEach(([key, order]) => {
                    const date = new Date(order.timestamp).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                    
                    let actionBtn = '';
                    if (order.status === 'pending') {
                        actionBtn = `
                            <button onclick="updateOrderStatus('${key}', 'completed')" class="bg-green-500 text-white px-2 py-1 rounded text-xs mr-1 hover:bg-green-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button onclick="updateOrderStatus('${key}', 'cancelled')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        `;
                    } else {
                        actionBtn = `<span class="text-xs text-gray-400">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    }

                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="p-3 text-gray-500">${date}</td>
                        <td class="p-3 font-bold text-blue-900">${order.userEmail}</td>
                        <td class="p-3">${order.productName}</td>
                        <td class="p-3 font-mono text-primary select-all cursor-copy" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">${order.customerInfo}</td>
                        <td class="p-3">
                            <span class="status-badge ${order.status === 'pending' ? 'status-pending' : order.status === 'completed' ? 'status-success' : 'status-cancel'}">
                                ${order.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-3">${actionBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });

            // Listen to products for the select dropdown & list
            onValue(ref(db, 'products'), (snapshot) => {
                const select = document.getElementById('stockProdSelect');
                const list = document.getElementById('adminProductList');
                
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
                list.innerHTML = '';
                
                const data = snapshot.val();
                if(!data) return;

                Object.entries(data).forEach(([key, prod]) => {
                    // Option for dropdown
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = `${prod.name} (${prod.category})`;
                    select.appendChild(opt);

                    // List Item
                    const li = document.createElement('li');
                    li.className = 'flex justify-between bg-gray-50 p-2 rounded border';
                    li.innerHTML = `<span>${prod.name}</span> <span class="text-gray-400 text-sm">${prod.price}‡∏ö.</span>`;
                    list.appendChild(li);
                });
            });
        }

        // --- Admin Actions ---
        
        window.addNewProduct = async () => {
            const name = document.getElementById('newProdName').value;
            const cat = document.getElementById('newProdCat').value;
            const price = document.getElementById('newProdPrice').value;

            if(!name || !price) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');

            await push(ref(db, 'products'), {
                name, category: cat, price: Number(price)
            });

            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
            document.getElementById('newProdName').value = '';
            document.getElementById('newProdPrice').value = '';
        };

        window.addStockCodes = async () => {
            const prodId = document.getElementById('stockProdSelect').value;
            const codesText = document.getElementById('stockCodesArea').value;

            if(!prodId) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            if(!codesText.trim()) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î', 'warning');

            const codes = codesText.split('\n').filter(line => line.trim() !== '');
            
            // Save each code individually
            const updates = {};
            codes.forEach(code => {
                const newCodeKey = push(ref(db, 'codes/' + prodId)).key;
                updates[`codes/${prodId}/${newCodeKey}`] = { 
                    code: code.trim(),
                    status: 'available'
                };
            });

            await update(ref(db), updates);
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏° ${codes.length} ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            document.getElementById('stockCodesArea').value = '';
        };

        window.clearAllCodes = async () => {
             const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: "‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'
            });

            if (result.isConfirmed) {
                await set(ref(db, 'codes'), null);
                Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        };

        window.updateOrderStatus = async (orderId, status) => {
            // If completed, we might want to fetch a code automatically or let admin manually send via external chat.
            // For this requirements: just update status. 
            // Optional: If we wanted to auto-assign a code:
            /*
            if(status === 'completed') {
                // Fetch order details -> find productID -> find available code -> assign -> mark code used
            }
            */
            
            await update(ref(db, `orders/${orderId}`), { status: status });
            Swal.fire('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï', `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        };

    </script>
</body>
</html>
