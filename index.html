<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>จองคิวออนไลน์ - สำหรับลูกค้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; color: #334155; }
        
        /* Custom UI Components */
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 1.5rem; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: white; 
            border-radius: 1rem; 
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn-primary:active { transform: scale(0.96); box-shadow: none; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }

        .status-badge { padding: 6px 16px; border-radius: 99px; font-weight: 700; font-size: 0.85rem; letter-spacing: 0.5px; }
        .st-wait { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .st-call { 
            background: #ecfdf5; color: #059669; border: 1px solid #d1fae5;
            animation: pulse-green 2s infinite;
        }

        /* Animations */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .marquee-wrap { position: fixed; top: 0; width: 100%; height: 40px; background: #1e293b; color: white; z-index: 50; display: flex; align-items: center; }
        .marquee-content { display: inline-block; white-space: nowrap; animation: marquee 20s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* Input Styling */
        .input-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            width: 100%;
            outline: none;
            transition: 0.3s;
        }
        .input-box:focus { border-color: #3b82f6; background: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col pt-14 pb-6">

    <div id="ann-bar" class="marquee-wrap hidden">
        <div class="bg-blue-600 h-full px-4 flex items-center font-bold z-10 text-xs shadow-md">
            <i class="fa-solid fa-bullhorn mr-2"></i> ประกาศ
        </div>
        <div id="ann-text" class="marquee-content text-sm font-medium py-2">...</div>
    </div>

    <header class="px-6 mb-6 sticky top-14 z-40">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <div>
                <h1 class="font-bold text-2xl text-slate-800 tracking-tight" id="shop-name">Loading...</h1>
                <p class="text-xs text-slate-400 font-medium">บริการจองคิวออนไลน์</p>
            </div>
            <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-bold text-slate-600">Online</span>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-md mx-auto w-full px-6 flex flex-col justify-start gap-6">
        
        <div class="text-center py-4">
            <div class="inline-block relative">
                <h2 class="text-6xl font-black text-slate-800 tracking-tighter" id="current-q">---</h2>
                <span class="absolute -top-2 -right-4 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-bounce hidden" id="calling-badge">NOW</span>
            </div>
            <p class="text-sm text-slate-400 font-medium mt-1">คิวที่กำลังเรียก</p>
            <div class="mt-4 bg-white inline-flex items-center px-4 py-2 rounded-xl shadow-sm border border-slate-100">
                <i class="fa-solid fa-user-group text-blue-500 mr-2"></i>
                <span class="text-lg font-bold text-blue-600 mr-1" id="wait-count">0</span> 
                <span class="text-xs text-slate-400">คิวรอ</span>
            </div>
        </div>

        <div id="form-section" class="glass-card p-6 animate__animated animate__fadeIn">
            <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center">
                <i class="fa-solid fa-ticket text-blue-500 mr-2"></i> จองคิวใหม่
            </h3>
            <form onsubmit="App.book(event)" class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 ml-1 mb-1 block">ชื่อผู้จอง</label>
                    <input id="inp-name" class="input-box" placeholder="ระบุชื่อของคุณ" required>
                </div>
                <div>
                    <label class="text-xs text-slate-400 ml-1 mb-1 block">เบอร์โทรศัพท์ (ถ้ามี)</label>
                    <input id="inp-phone" type="tel" class="input-box" placeholder="0xx-xxx-xxxx">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400 ml-1 mb-1 block">จำนวนคน</label>
                        <select id="inp-pax" class="input-box">
                            <option value="1">1 ท่าน</option>
                            <option value="2">2 ท่าน</option>
                            <option value="3">3 ท่าน</option>
                            <option value="4+">4+ ท่าน</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 ml-1 mb-1 block">เวลาถึงร้าน</label>
                        <input id="inp-time" type="time" class="input-box text-center font-bold text-blue-600" required>
                    </div>
                </div>
                <button id="btn-book" class="btn-primary w-full py-4 font-bold text-lg shadow-lg mt-2 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-check-circle"></i> กดรับบัตรคิว
                </button>
                <p class="text-[10px] text-center text-slate-400 mt-2">*กรุณาเปิดเสียงโทรศัพท์เพื่อรอเรียก</p>
            </form>
        </div>

        <div id="ticket-section" class="hidden animate__animated animate__zoomIn">
            <div class="glass-card overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-6 text-center text-white relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                    <div class="text-xs uppercase tracking-widest opacity-80 mb-1">Your Queue Number</div>
                    <div id="my-q-num" class="text-6xl font-black drop-shadow-md">---</div>
                    <div id="my-status" class="status-badge bg-white/20 text-white mt-3 backdrop-blur inline-block border border-white/30">WAITING</div>
                </div>
                
                <div class="p-6 bg-white">
                    <div class="space-y-3 border-b border-dashed border-slate-200 pb-4 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">ชื่อลูกค้า</span>
                            <span class="font-bold text-slate-700" id="my-name">...</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">เวลาที่ระบุ</span>
                            <span class="font-bold text-blue-600" id="my-arrival">...</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">จำนวน</span>
                            <span class="font-bold text-slate-700" id="my-pax">...</span>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-3 rounded-xl text-xs text-yellow-700 mb-4 border border-yellow-100 flex gap-2 items-start">
                        <i class="fa-solid fa-volume-high mt-0.5 text-yellow-600"></i>
                        <span>ระบบจะส่งเสียงเรียกและสั่นเมื่อถึงคิวของคุณ กรุณาอย่าปิดหน้าจอนี้</span>
                    </div>

                    <button onclick="App.cancel()" class="w-full py-3 text-sm text-red-500 hover:bg-red-50 rounded-xl transition font-medium">
                        <i class="fa-solid fa-times-circle mr-1"></i> ยกเลิกคิว
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        class CustomerApp {
            constructor() {
                this.myId = localStorage.getItem('q_id_pro');
                this.lastCallTimestamp = 0; // เก็บเวลาการเรียกล่าสุด เพื่อกันเรียกซ้ำเอง
                this.init();
            }

            init() {
                this.listenConfig();
                if(this.myId) {
                    this.listenTicket();
                } else {
                    // ถ้าไม่มีคิว ให้ตั้งเวลา Input เป็นเวลาปัจจุบัน
                    const now = new Date();
                    const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
                    document.getElementById('inp-time').value = timeStr;
                }
            }

            // ฟังการตั้งค่าร้านค้า + คิวปัจจุบัน
            listenConfig() {
                db.collection('q_system').doc('config').onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        document.getElementById('shop-name').innerText = d.shopName || 'Smart Queue';
                        document.getElementById('current-q').innerText = d.current || '---';
                        
                        // Badge คำว่า NOW
                        const badge = document.getElementById('calling-badge');
                        if(d.isCalling) badge.classList.remove('hidden'); else badge.classList.add('hidden');

                        // Announcement Bar
                        const bar = document.getElementById('ann-bar');
                        if(d.showAnnounce && d.announceText) {
                            bar.classList.remove('hidden');
                            document.getElementById('ann-text').innerText = d.announceText;
                        } else {
                            bar.classList.add('hidden');
                        }

                        // นับจำนวนคนรอ
                        db.collection('q_system').doc('config').collection('queues')
                          .where('status','==','waiting')
                          .onSnapshot(snapshot => {
                              document.getElementById('wait-count').innerText = snapshot.size;
                          });
                    }
                });
            }

            // ฟังตั๋วของตัวเอง
            listenTicket() {
                db.collection('q_system').doc('config').collection('queues').doc(this.myId)
                .onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        
                        // ถ้าสถานะเป็น จบงาน หรือ ยกเลิก
                        if(d.status === 'completed' || d.status === 'cancelled') {
                            if(d.status === 'completed') Swal.fire('ขอบคุณที่ใช้บริการ', 'คิวของคุณเสร็จสิ้นแล้ว', 'success').then(() => this.logout());
                            else this.logout();
                            return;
                        }

                        this.renderTicket(d);

                        // --- LOGIC เสียงเรียก ---
                        if(d.status === 'called') {
                            // ตรวจสอบว่าเป็นคำสั่งเรียกใหม่หรือไม่ (ดูจาก timestamp ที่แอดมินส่งมา)
                            // ถ้าแอดมินกด "เรียกซ้ำ" timestamp จะเปลี่ยน เราก็จะพูดใหม่
                            if (d.lastCallTime && d.lastCallTime > this.lastCallTimestamp) {
                                this.lastCallTimestamp = d.lastCallTime;
                                const msg = `ขอเชิญคิวที่, ${d.number}, ค่ะ`;
                                this.announce(msg, d.number);
                            }
                        }
                    } else {
                        // หาไม่เจอ (อาจจะโดนลบ)
                        this.logout();
                    }
                }, error => {
                    console.error("Error listening ticket:", error);
                });
            }

            // ฟังก์ชันจองคิว
            async book(e) {
                e.preventDefault();
                
                // *** เทคนิค Unlock Audio Context ของ Browser มือถือ ***
                // เล่นเสียงเงียบๆ 1 ครั้งทันทีที่ user กดปุ่ม เพื่อเปิดสิทธิ์การเล่นเสียงในอนาคต
                this.speak(' '); 

                const btn = document.getElementById('btn-book');
                btn.disabled = true; 
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังจอง...';

                try {
                    await db.runTransaction(async (t) => {
                        const configRef = db.collection('q_system').doc('config');
                        const configDoc = await t.get(configRef);
                        
                        if(!configDoc.exists) throw "Config not found";

                        const data = configDoc.data();
                        
                        // 1. ดึง Prefix จาก Config (ถ้าไม่มีใช้ A-)
                        const prefix = data.queuePrefix || 'A-';
                        
                        // 2. คำนวณเลขถัดไป
                        const nextRaw = (data.last || 0) + 1;
                        const qNumber = `${prefix}${String(nextRaw).padStart(3,'0')}`;

                        // 3. สร้างตั๋วใหม่
                        const newQRef = configRef.collection('queues').doc();
                        
                        t.set(newQRef, {
                            number: qNumber,
                            raw: nextRaw,
                            prefix: prefix, // เก็บ prefix ไว้ในตั๋วด้วย เผื่ออนาคตเปลี่ยน
                            name: document.getElementById('inp-name').value,
                            phone: document.getElementById('inp-phone').value,
                            pax: document.getElementById('inp-pax').value + ' ท่าน',
                            arrivalTime: document.getElementById('inp-time').value,
                            status: 'waiting',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            lastCallTime: 0 // เริ่มต้นยังไม่เคยถูกเรียก
                        });

                        // 4. อัปเดตเลข running
                        t.update(configRef, { last: nextRaw });

                        // จำ ID ไว้ในเครื่อง
                        localStorage.setItem('q_id_pro', newQRef.id);
                        this.myId = newQRef.id;
                    });

                    // สำเร็จ
                    this.listenTicket();
                    Swal.fire({
                        icon: 'success', 
                        title: 'จองคิวสำเร็จ', 
                        text: 'กรุณารอเรียกคิว',
                        timer: 1500, 
                        showConfirmButton: false
                    });

                } catch(err) {
                    console.error(err);
                    btn.disabled = false; 
                    btn.innerHTML = 'กดรับบัตรคิว';
                    Swal.fire('เกิดข้อผิดพลาด', err.message, 'error');
                }
            }

            // ฟังก์ชันเรนเดอร์หน้าบัตรคิว
            renderTicket(d) {
                document.getElementById('form-section').classList.add('hidden');
                document.getElementById('ticket-section').classList.remove('hidden');
                
                document.getElementById('my-q-num').innerText = d.number;
                document.getElementById('my-name').innerText = d.name;
                document.getElementById('my-arrival').innerText = d.arrivalTime || '-';
                document.getElementById('my-pax').innerText = d.pax || '-';

                const statusBadge = document.getElementById('my-status');
                if(d.status === 'called') {
                    statusBadge.className = 'status-badge st-call inline-block mt-3 border border-green-200';
                    statusBadge.innerText = 'กำลังเรียกคุณ (CALLED)';
                } else {
                    statusBadge.className = 'status-badge st-wait inline-block mt-3';
                    statusBadge.innerText = 'รอเรียก (WAITING)';
                }
            }

            // ฟังก์ชันแจ้งเตือน (สั่น + พูด + Popup)
            announce(msg, number) {
                // 1. สั่น (ถ้าเครื่องรองรับ)
                if(navigator.vibrate) navigator.vibrate([500, 300, 500]);

                // 2. พูด
                this.speak(msg);

                // 3. แสดง Popup
                Swal.fire({
                    title: `ถึงคิวคุณแล้ว! ${number}`,
                    text: 'กรุณาติดต่อเคาน์เตอร์บริการ',
                    icon: 'success',
                    confirmButtonText: 'รับทราบ',
                    confirmButtonColor: '#2563eb',
                    backdrop: `rgba(0,0,123,0.4)`
                });
            }

            // ฟังก์ชันพูด (Speech Synthesis) แก้บั๊กเสียงตีกัน
            speak(txt) {
                if('speechSynthesis' in window) {
                    // *** สำคัญ: ยกเลิกเสียงเก่าก่อนพูดใหม่เสมอ ***
                    window.speechSynthesis.cancel();

                    if(txt.trim() === '') return; // ถ้าส่งมาแค่ unlock ไม่ต้องพูด

                    const u = new SpeechSynthesisUtterance(txt);
                    u.lang = 'th-TH'; 
                    u.rate = 0.9; // พูดช้าลงนิดนึงให้ชัด
                    u.volume = 1.0;
                    window.speechSynthesis.speak(u);
                }
            }

            cancel() {
                Swal.fire({
                    title: 'ต้องการยกเลิกคิว?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ใช, ยกเลิก',
                    cancelButtonText: 'ไม่',
                    confirmButtonColor: '#ef4444'
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.collection('q_system').doc('config').collection('queues').doc(this.myId).update({
                            status: 'cancelled'
                        }).then(() => this.logout());
                    }
                });
            }

            logout() {
                localStorage.removeItem('q_id_pro');
                location.reload();
            }
        }

        // Start App
        const App = new CustomerApp();
    </script>
</body>
</html>
