<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HubFu Enterprise - Game Rental Platform</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #2563eb;
            --bg-soft: #f8fafc;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: var(--bg-soft); 
            color: #334155;
            -webkit-font-smoothing: antialiased;
        }
        
        /* --- UI Component Styles --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .sidebar-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
        }
        .sidebar-item:hover, .sidebar-item.active {
            background: white;
            color: var(--accent);
            border-left-color: var(--accent);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .btn-main {
            background: var(--primary);
            color: white;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }

        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        .animate-slide { animation: slideUp 0.4s ease-out forwards; }
        
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
            border-radius: 6px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm md:text-base">

    <aside class="w-64 bg-slate-50 border-r border-gray-200 hidden md:flex flex-col z-30">
        <div class="h-16 flex items-center px-6 border-b border-gray-200 bg-white">
            <div class="w-8 h-8 bg-black text-white rounded-lg flex items-center justify-center font-bold text-lg mr-3 shadow-lg">HF</div>
            <span class="font-bold text-lg tracking-tight text-slate-800">HubFu</span>
        </div>

        <div class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <p class="px-3 text-xs font-bold text-gray-400 uppercase mb-2">Menu</p>
            <button onclick="App.router('home')" id="nav-home" class="sidebar-item w-full flex items-center px-3 py-2.5 text-gray-600 rounded-lg font-medium active">
                <i class="fa-solid fa-home w-6"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
            <button onclick="App.router('market')" id="nav-market" class="sidebar-item w-full flex items-center px-3 py-2.5 text-gray-600 rounded-lg font-medium">
                <i class="fa-solid fa-store w-6"></i> ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            </button>
            <button onclick="App.router('inventory')" id="nav-inventory" class="sidebar-item w-full flex items-center px-3 py-2.5 text-gray-600 rounded-lg font-medium">
                <i class="fa-solid fa-box-open w-6"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
            </button>
            <button onclick="App.router('wallet')" id="nav-wallet" class="sidebar-item w-full flex items-center px-3 py-2.5 text-gray-600 rounded-lg font-medium">
                <i class="fa-solid fa-wallet w-6"></i> ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button onclick="App.router('auction')" id="nav-auction" class="sidebar-item w-full flex items-center px-3 py-2.5 text-gray-600 rounded-lg font-medium">
                <i class="fa-solid fa-gavel w-6"></i> ‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•
            </button>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white">
            <div id="sidebar-user-info" class="hidden">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-slate-200 overflow-hidden">
                        <img id="user-avatar-small" src="" class="w-full h-full object-cover">
                    </div>
                    <div class="overflow-hidden">
                        <div id="user-name-small" class="font-bold truncate text-slate-800">User</div>
                        <div id="user-balance-small" class="text-xs font-bold text-green-600">‡∏ø0.00</div>
                    </div>
                </div>
                <button onclick="Auth.logout()" class="w-full border border-red-200 text-red-500 hover:bg-red-50 py-1.5 rounded-lg text-xs font-bold transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <div id="sidebar-guest-info">
                <button onclick="App.openLoginModal()" class="w-full btn-main py-2 rounded-lg font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen relative">
        
        <header class="h-16 bg-white/80 backdrop-blur border-b border-gray-200 flex justify-between items-center px-4 md:px-8 z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <button onclick="App.toggleMobileMenu()" class="md:hidden text-2xl text-slate-600"><i class="fa-solid fa-bars"></i></button>
                <h2 id="page-title" class="font-bold text-lg text-slate-800">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="header-balance" class="hidden md:flex flex-col items-end mr-2 animate-fade">
                    <span class="text-[10px] text-gray-400 uppercase font-bold">Balance</span>
                    <span class="text-sm font-bold text-green-600" id="header-balance-text">‡∏ø0.00</span>
                </div>
                <button class="relative text-slate-400 hover:text-blue-600 transition">
                    <i class="fa-solid fa-bell text-xl"></i>
                    <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
            </div>
        </header>

        <main id="app-root" class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            </main>

        <div id="mobile-menu" class="fixed inset-0 z-50 bg-black/50 hidden md:hidden animate-fade">
            <div class="bg-white w-3/4 h-full shadow-2xl p-6 flex flex-col animate-slide">
                <div class="flex justify-between items-center mb-8">
                    <span class="font-bold text-xl">Menu</span>
                    <button onclick="App.toggleMobileMenu()" class="text-2xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <nav class="space-y-4 text-lg">
                    <a onclick="App.router('home'); App.toggleMobileMenu()" class="block font-medium">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                    <a onclick="App.router('market'); App.toggleMobileMenu()" class="block font-medium">üõçÔ∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</a>
                    <a onclick="App.router('inventory'); App.toggleMobileMenu()" class="block font-medium">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
                    <a onclick="App.router('wallet'); App.toggleMobileMenu()" class="block font-medium">üí≥ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a>
                    <hr>
                    <a onclick="Auth.logout()" class="block font-medium text-red-500">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                </nav>
            </div>
        </div>

    </div>

    <div id="chat-widget" class="fixed bottom-6 right-6 z-40 flex flex-col items-end">
        <div id="chat-window" class="bg-white w-80 h-96 rounded-2xl shadow-2xl border border-gray-200 mb-4 hidden flex-col overflow-hidden animate-slide origin-bottom-right">
            <div class="bg-slate-900 p-3 flex justify-between items-center text-white">
                <span class="font-bold text-sm"><i class="fa-solid fa-headset mr-2"></i>Live Support</span>
                <button onclick="Chat.toggle()" class="hover:text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 bg-slate-50 p-3 overflow-y-auto space-y-2 text-sm">
                </div>
            <form onsubmit="Chat.send(event)" class="p-2 border-t flex gap-2 bg-white">
                <input id="chat-input" type="text" class="flex-1 bg-slate-100 rounded-full px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
                <button type="submit" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </form>
        </div>
        <button onclick="Chat.toggle()" class="w-14 h-14 bg-black text-white rounded-full shadow-xl hover:scale-110 transition flex items-center justify-center text-xl z-50">
            <i class="fa-solid fa-comment-dots"></i>
        </button>
    </div>

    <div id="modal-auth" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden animate-fade">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl relative overflow-hidden">
            <button onclick="App.closeModal('modal-auth')" class="absolute top-4 right-4 text-gray-400 hover:text-black"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800">Welcome Back</h3>
                <p class="text-slate-400 text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</p>
            </div>

            <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                <button onclick="Auth.switchTab('login')" id="tab-login" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow text-slate-800 transition">Login</button>
                <button onclick="Auth.switchTab('register')" id="tab-register" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 transition">Register</button>
            </div>

            <form id="auth-form" onsubmit="Auth.submit(event)">
                <div class="space-y-4">
                    <input type="email" id="auth-email" placeholder="Email Address" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-black transition" required>
                    <input type="password" id="auth-pass" placeholder="Password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:border-black transition" required>
                </div>
                <button type="submit" class="w-full btn-main py-3.5 rounded-xl font-bold mt-6 shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </form>
        </div>
    </div>

    <div id="modal-product" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden animate-fade">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div id="product-modal-content" class="overflow-y-auto flex-1">
                </div>
        </div>
    </div>

    <script>
        /**
         * ------------------------------------------------------------------
         * CONFIGURATION
         * ------------------------------------------------------------------
         */
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601",
            measurementId: "G-PDB6KGDJYB"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        /**
         * ------------------------------------------------------------------
         * CORE APP CONTROLLER
         * ------------------------------------------------------------------
         */
        const App = {
            state: {
                user: null,
                userData: null,
                products: [],
                currentPage: 'home'
            },

            init: () => {
                // Listen Auth
                auth.onAuthStateChanged(user => {
                    App.state.user = user;
                    if(user) {
                        // Realtime User Data
                        db.collection('users').doc(user.uid).onSnapshot(doc => {
                            if(doc.exists) {
                                App.state.userData = doc.data();
                                UI.updateAuthUI(true);
                            } else {
                                // Create default user doc if missing
                                db.collection('users').doc(user.uid).set({
                                    email: user.email,
                                    balance: 0,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        });
                        Chat.initListener(user.uid);
                    } else {
                        App.state.userData = null;
                        UI.updateAuthUI(false);
                    }
                    App.router(App.state.currentPage); // Reload current page
                });

                // Listen Products
                db.collection('products').where('status', '==', 'available').onSnapshot(snap => {
                    App.state.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(App.state.currentPage === 'home' || App.state.currentPage === 'market') {
                        App.renderPage(App.state.currentPage);
                    }
                });
            },

            router: (page) => {
                App.state.currentPage = page;
                
                // Update Sidebar Active State
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
                const navBtn = document.getElementById(`nav-${page}`);
                if(navBtn) navBtn.classList.add('active');

                // Page Title
                const titles = { home: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å', market: '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', inventory: '‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô', wallet: '‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô', auction: '‡∏•‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•' };
                document.getElementById('page-title').innerText = titles[page] || 'HubFu';

                // Protected Routes
                if(['inventory', 'wallet', 'auction'].includes(page) && !App.state.user) {
                    App.openLoginModal();
                    return;
                }

                App.renderPage(page);
            },

            renderPage: (page) => {
                const root = document.getElementById('app-root');
                root.innerHTML = UI.getSkeleton(); // Show loading first

                setTimeout(() => {
                    let content = '';
                    switch(page) {
                        case 'home': content = Pages.home(); break;
                        case 'market': content = Pages.market(); break;
                        case 'inventory': content = Pages.inventory(); break;
                        case 'wallet': content = Pages.wallet(); break;
                        case 'auction': content = Pages.auction(); break;
                    }
                    root.innerHTML = `<div class="animate-slide">${content}</div>`;
                    
                    // Post-render scripts (Listeners)
                    if(page === 'inventory') Inventory.startTimers();
                }, 200);
            },

            toggleMobileMenu: () => {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            },

            openLoginModal: () => {
                document.getElementById('modal-auth').classList.remove('hidden');
            },

            closeModal: (id) => {
                document.getElementById(id).classList.add('hidden');
            }
        };

        /**
         * ------------------------------------------------------------------
         * PAGE TEMPLATES
         * ------------------------------------------------------------------
         */
        const Pages = {
            home: () => `
                <div class="mb-8 relative rounded-3xl overflow-hidden h-48 md:h-72 shadow-xl group">
                    <img src="https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=2070" class="w-full h-full object-cover group-hover:scale-105 transition duration-700">
                    <div class="absolute inset-0 bg-gradient-to-r from-black/80 to-transparent flex flex-col justify-center px-8 md:px-12 text-white">
                        <span class="bg-blue-600 w-fit px-3 py-1 rounded-full text-[10px] font-bold mb-3 uppercase tracking-wider">Premium Access</span>
                        <h2 class="text-3xl md:text-5xl font-bold mb-2">‡πÄ‡∏ä‡πà‡∏≤‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ó‡∏û</h2>
                        <p class="text-gray-300 text-sm md:text-base mb-6 max-w-lg">‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏Å‡∏°‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á 10 ‡∏ö‡∏≤‡∏ó/‡∏ä‡∏°.</p>
                        <button onclick="App.router('market')" class="bg-white text-black px-6 py-2.5 rounded-xl font-bold w-fit hover:bg-gray-200 transition">‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>
                <div class="flex justify-between items-end mb-4">
                    <h3 class="text-xl font-bold text-slate-800">üî• ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    ${UI.renderProductCards(App.state.products.slice(0, 4))}
                </div>
            `,

            market: () => `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="relative w-full md:w-96">
                        <i class="fa-solid fa-search absolute left-4 top-3 text-gray-400"></i>
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡∏°..." class="w-full bg-white border border-gray-200 rounded-full pl-10 pr-4 py-2.5 focus:outline-none focus:border-black transition" onkeyup="UI.filterProducts(this.value)">
                    </div>
                    <div class="flex gap-2 text-sm overflow-x-auto w-full md:w-auto pb-2">
                        <button class="px-4 py-1.5 rounded-full bg-black text-white whitespace-nowrap">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button class="px-4 py-1.5 rounded-full bg-white border border-gray-200 hover:bg-gray-50 whitespace-nowrap">FPS</button>
                        <button class="px-4 py-1.5 rounded-full bg-white border border-gray-200 hover:bg-gray-50 whitespace-nowrap">MOBA</button>
                    </div>
                </div>
                <div id="market-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    ${UI.renderProductCards(App.state.products)}
                </div>
            `,

            wallet: () => `
                <div class="max-w-2xl mx-auto">
                    <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-6 md:p-8 text-white shadow-2xl mb-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white opacity-5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <div class="flex justify-between items-start mb-8">
                            <span class="font-bold tracking-widest text-lg">HubFu<span class="text-blue-400">Pay</span></span>
                            <i class="fa-solid fa-wifi rotate-90 opacity-50"></i>
                        </div>
                        <div class="mb-2 text-xs text-gray-400 uppercase">Current Balance</div>
                        <div class="text-4xl font-bold mb-8">‡∏ø${(App.state.userData?.balance || 0).toLocaleString()}</div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-[10px] text-gray-400 uppercase">Account</div>
                                <div class="font-medium tracking-wide text-sm">${App.state.user.email}</div>
                            </div>
                            <div class="text-xl font-bold italic opacity-80">VISA</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <button onclick="Wallet.openTopupModal()" class="bg-blue-600 text-white p-4 rounded-2xl flex flex-col items-center gap-2 hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                            <i class="fa-solid fa-circle-plus text-2xl"></i>
                            <span class="font-bold">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
                        </button>
                        <button onclick="Chat.toggle()" class="bg-white border border-gray-200 text-slate-700 p-4 rounded-2xl flex flex-col items-center gap-2 hover:bg-gray-50 transition">
                            <i class="fa-solid fa-headset text-2xl"></i>
                            <span class="font-bold">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl border border-gray-100 p-6">
                        <h3 class="font-bold text-slate-800 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h3>
                        <div id="transaction-list" class="space-y-3">
                            <div class="text-center text-gray-400 text-sm py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                        </div>
                    </div>
                </div>
            `,

            inventory: () => `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                        <div id="inventory-active" class="space-y-4 min-h-[200px]">
                            </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 mb-4 text-gray-400">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h3>
                        <div id="inventory-history" class="space-y-3 opacity-80">
                            </div>
                    </div>
                </div>
            `,

            auction: () => `
                <div class="text-center py-20 bg-white rounded-3xl border border-gray-100 shadow-sm">
                    <div class="w-20 h-20 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 animate-bounce">
                        <i class="fa-solid fa-gavel"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•</h2>
                    <p class="text-slate-400 max-w-sm mx-auto mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÑ‡∏≠‡∏î‡∏µ‡πÅ‡∏£‡∏£‡πå‡πÅ‡∏ö‡∏ö Real-time ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>
                </div>
            `
        };

        /**
         * ------------------------------------------------------------------
         * LOGIC MODULES
         * ------------------------------------------------------------------
         */

        const UI = {
            getSkeleton: () => `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 animate-pulse">
                    <div class="h-40 bg-gray-200 rounded-xl col-span-full mb-4"></div>
                    <div class="h-48 bg-gray-200 rounded-xl"></div>
                    <div class="h-48 bg-gray-200 rounded-xl"></div>
                    <div class="h-48 bg-gray-200 rounded-xl"></div>
                    <div class="h-48 bg-gray-200 rounded-xl"></div>
                </div>
            `,

            renderProductCards: (products) => {
                if(!products.length) return `<div class="col-span-full text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
                return products.map(p => `
                    <div class="bg-white rounded-2xl overflow-hidden border border-gray-100 card-hover cursor-pointer group" onclick="Rental.openModal('${p.id}')">
                        <div class="h-32 md:h-40 overflow-hidden relative bg-gray-100">
                            <img src="${p.image}" onerror="this.src='https://via.placeholder.com/300?text=No+Image'" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                            <div class="absolute top-2 right-2 bg-white/90 backdrop-blur text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">‡∏ß‡πà‡∏≤‡∏á</div>
                        </div>
                        <div class="p-3 md:p-4">
                            <h4 class="font-bold text-slate-800 truncate text-sm md:text-base">${p.name}</h4>
                            <p class="text-xs text-gray-400 line-clamp-1 mb-3">${p.desc || 'No details'}</p>
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-blue-600">‡∏ø${p.price}<span class="text-[10px] text-gray-400 font-normal">/‡∏ä‡∏°.</span></span>
                                <button class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-slate-100 hover:bg-black hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-plus text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            filterProducts: (keyword) => {
                const filtered = App.state.products.filter(p => p.name.toLowerCase().includes(keyword.toLowerCase()));
                document.getElementById('market-grid').innerHTML = UI.renderProductCards(filtered);
            },

            updateAuthUI: (isLoggedIn) => {
                if(isLoggedIn) {
                    const u = App.state.userData;
                    const avatar = `https://ui-avatars.com/api/?name=${App.state.user.email}&background=0f172a&color=fff`;
                    
                    document.getElementById('sidebar-guest-info').classList.add('hidden');
                    document.getElementById('sidebar-user-info').classList.remove('hidden');
                    document.getElementById('user-avatar-small').src = avatar;
                    document.getElementById('user-name-small').innerText = App.state.user.email.split('@')[0];
                    document.getElementById('user-balance-small').innerText = `‡∏ø${(u.balance||0).toLocaleString()}`;

                    document.getElementById('header-balance-text').innerText = `‡∏ø${(u.balance||0).toLocaleString()}`;
                    
                    // Trigger Data Load for Wallet/Inventory if needed
                    if(App.state.currentPage === 'wallet') Wallet.loadHistory();
                    if(App.state.currentPage === 'inventory') Inventory.loadItems();
                } else {
                    document.getElementById('sidebar-guest-info').classList.remove('hidden');
                    document.getElementById('sidebar-user-info').classList.add('hidden');
                    document.getElementById('header-balance-text').innerText = '‡∏ø0.00';
                }
            }
        };

        const Auth = {
            currentTab: 'login',
            
            switchTab: (tab) => {
                Auth.currentTab = tab;
                const loginBtn = document.getElementById('tab-login');
                const regBtn = document.getElementById('tab-register');
                
                if(tab === 'login') {
                    loginBtn.classList.add('bg-white', 'shadow', 'text-slate-800');
                    loginBtn.classList.remove('text-slate-400');
                    regBtn.classList.remove('bg-white', 'shadow', 'text-slate-800');
                    regBtn.classList.add('text-slate-400');
                } else {
                    regBtn.classList.add('bg-white', 'shadow', 'text-slate-800');
                    regBtn.classList.remove('text-slate-400');
                    loginBtn.classList.remove('bg-white', 'shadow', 'text-slate-800');
                    loginBtn.classList.add('text-slate-400');
                }
            },

            submit: (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                
                Swal.showLoading();

                const promise = Auth.currentTab === 'login' 
                    ? auth.signInWithEmailAndPassword(email, pass)
                    : auth.createUserWithEmailAndPassword(email, pass);

                promise.then(() => {
                    Swal.fire({icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false});
                    App.closeModal('modal-auth');
                }).catch(err => {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
                });
            },

            logout: () => {
                auth.signOut().then(() => {
                    Swal.fire('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
                });
            }
        };

        const Rental = {
            openModal: (id) => {
                if(!App.state.user) { App.openLoginModal(); return; }
                
                const p = App.state.products.find(x => x.id === id);
                const modal = document.getElementById('modal-product');
                const content = document.getElementById('product-modal-content');
                
                content.innerHTML = `
                    <div class="relative">
                        <img src="${p.image}" class="w-full h-56 object-cover">
                        <button onclick="App.closeModal('modal-product')" class="absolute top-4 right-4 bg-black/50 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-black"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="p-6">
                        <h3 class="text-2xl font-bold mb-2">${p.name}</h3>
                        <p class="text-gray-500 text-sm mb-6">${p.desc || 'No description provided.'}</p>
                        
                        <div class="bg-slate-50 p-4 rounded-xl border border-gray-100 mb-6">
                            <div class="flex justify-between mb-2 font-bold text-sm">
                                <span>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πà‡∏≤</span>
                                <span id="rent-hours-display">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                            </div>
                            <input type="range" min="1" max="24" value="1" class="w-full accent-black" oninput="Rental.updateCalc(this.value, ${p.price})">
                        </div>

                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-400 uppercase">Total Price</p>
                                <p class="text-3xl font-bold text-blue-600" id="rent-total-price">‡∏ø${p.price}</p>
                            </div>
                            <button onclick="Rental.confirm('${p.id}', '${p.name}', ${p.price})" class="bg-black text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition">
                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤
                            </button>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');
            },

            updateCalc: (h, price) => {
                document.getElementById('rent-hours-display').innerText = `${h} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
                document.getElementById('rent-total-price').innerText = `‡∏ø${(h * price).toLocaleString()}`;
                Rental.currentHours = h;
            },
            currentHours: 1,

            confirm: async (pid, pname, price) => {
                const hours = Rental.currentHours;
                const cost = hours * price;
                
                if(App.state.userData.balance < cost) {
                    Swal.fire({icon: 'warning', title: '‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', confirmButtonText: '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô'}).then((res) => {
                        if(res.isConfirmed) { App.closeModal('modal-product'); App.router('wallet'); }
                    });
                    return;
                }

                try {
                    // Client-side simulation of transaction (Secure logic should be Cloud Functions)
                    await db.collection('rentals').add({
                        userId: App.state.user.uid,
                        productId: pid,
                        productName: pname,
                        hours: Number(hours),
                        cost: cost,
                        status: 'pending',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    App.closeModal('modal-product');
                    Swal.fire('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á‡πÅ‡∏ä‡∏ó', 'success');
                    Rental.currentHours = 1; // Reset
                } catch(e) {
                    Swal.fire('Error', e.message, 'error');
                }
            }
        };

        const Wallet = {
            loadHistory: () => {
                const container = document.getElementById('transaction-list');
                if(!container) return;
                
                db.collection('topups').where('userId', '==', App.state.user.uid).orderBy('timestamp', 'desc').limit(10).onSnapshot(snap => {
                    if(snap.empty) { container.innerHTML = '<div class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }
                    
                    container.innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        const color = d.status === 'approved' ? 'text-green-600' : (d.status === 'pending' ? 'text-yellow-600' : 'text-red-600');
                        return `
                            <div class="flex justify-between items-center p-3 hover:bg-slate-50 rounded-lg transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-money-bill"></i></div>
                                    <div>
                                        <div class="font-bold text-sm text-slate-800">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div>
                                        <div class="text-[10px] text-gray-400">${moment(d.timestamp?.toDate()).format('DD/MM/YY HH:mm')}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-sm">+‡∏ø${d.amount}</div>
                                    <div class="text-[10px] font-bold uppercase ${color}">${d.status}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            },

            openTopupModal: () => {
                Swal.fire({
                    title: '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (KBank)',
                    html: `
                        <div class="bg-green-50 p-4 rounded-xl border border-green-100 mb-4">
                            <p class="font-bold text-green-800 text-lg">012-3-45678-9</p>
                            <p class="text-xs text-green-600">‡∏ö‡∏à‡∏Å. ‡∏Æ‡∏±‡∏ö‡∏ü‡∏π ‡πÄ‡∏≠‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏û‡∏£‡∏™‡πå</p>
                        </div>
                        <input id="swal-amt" type="number" class="swal2-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                        <input id="swal-ref" type="text" class="swal2-input" placeholder="‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 14.30)">
                    `,
                    showCancelButton: true,
                    confirmButtonText: '‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô',
                    confirmButtonColor: '#0f172a',
                    preConfirm: () => {
                        const amt = document.getElementById('swal-amt').value;
                        const ref = document.getElementById('swal-ref').value;
                        if(!amt || !ref) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                        return {amt, ref};
                    }
                }).then(res => {
                    if(res.isConfirmed) {
                        db.collection('topups').add({
                            userId: App.state.user.uid,
                            email: App.state.user.email,
                            amount: Number(res.value.amt),
                            ref: res.value.ref,
                            status: 'pending',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'success'));
                    }
                });
            }
        };

        const Inventory = {
            activeInterval: null,

            loadItems: () => {
                // Active Rentals
                db.collection('rentals').where('userId', '==', App.state.user.uid).where('status', 'in', ['pending', 'active']).onSnapshot(snap => {
                    const el = document.getElementById('inventory-active');
                    if(!el) return;
                    
                    if(snap.empty) { el.innerHTML = '<div class="text-center text-gray-400 py-10 border border-dashed rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }
                    
                    el.innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        const isPending = d.status === 'pending';
                        // Calc expiry (Mock logic: timestamp + hours)
                        const startTime = d.timestamp?.toDate().getTime() || Date.now();
                        const endTime = startTime + (d.hours * 60 * 60 * 1000);
                        
                        return `
                            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative overflow-hidden group">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-lg">${d.productName}</h4>
                                    <span class="text-[10px] font-bold px-2 py-1 rounded ${isPending ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600'} uppercase">${d.status}</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                                    <i class="fa-regular fa-clock"></i>
                                    <span class="countdown-timer font-mono" data-end="${endTime}">Calculating...</span>
                                </div>
                                ${isPending ? 
                                    '<button class="w-full bg-gray-100 text-gray-400 py-2 rounded-lg text-sm font-bold cursor-not-allowed">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...</button>' : 
                                    '<button onclick="Chat.toggle()" class="w-full bg-black text-white py-2 rounded-lg text-sm font-bold hover:bg-gray-800">‡∏î‡∏π ID/Pass ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó</button>'
                                }
                            </div>
                        `;
                    }).join('');
                });
                
                // History
                db.collection('rentals').where('userId', '==', App.state.user.uid).orderBy('timestamp', 'desc').limit(5).onSnapshot(snap => {
                     const el = document.getElementById('inventory-history');
                     if(el && !snap.empty) {
                         el.innerHTML = snap.docs.map(d => 
                             `<div class="flex justify-between text-sm p-3 bg-white rounded-lg border border-gray-100"><span>${d.data().productName}</span><span class="text-gray-400">${moment(d.data().timestamp?.toDate()).fromNow()}</span></div>`
                         ).join('');
                     }
                });
            },

            startTimers: () => {
                if(Inventory.activeInterval) clearInterval(Inventory.activeInterval);
                Inventory.loadItems(); // Initial Load
                
                Inventory.activeInterval = setInterval(() => {
                    document.querySelectorAll('.countdown-timer').forEach(el => {
                        const end = parseInt(el.dataset.end);
                        const now = Date.now();
                        const diff = end - now;
                        
                        if(diff <= 0) {
                            el.innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤";
                            el.classList.add('text-red-500');
                        } else {
                            const h = Math.floor(diff / (1000 * 60 * 60));
                            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            const s = Math.floor((diff % (1000 * 60)) / 1000);
                            el.innerText = `${h}‡∏ä‡∏°. ${m}‡∏ô. ${s}‡∏ß‡∏¥.`;
                        }
                    });
                }, 1000);
            }
        };

        const Chat = {
            listener: null,
            toggle: () => {
                const win = document.getElementById('chat-window');
                win.classList.toggle('hidden');
                win.classList.toggle('flex');
            },
            initListener: (uid) => {
                rtdb.ref('chats/' + uid).limitToLast(20).on('child_added', snap => {
                    const m = snap.val();
                    const container = document.getElementById('chat-messages');
                    const isMe = m.sender === 'user';
                    
                    container.innerHTML += `
                        <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="${isMe ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'} px-3 py-2 rounded-2xl max-w-[85%] shadow-sm mb-1 break-words">
                                ${m.text}
                            </div>
                        </div>
                    `;
                    container.scrollTop = container.scrollHeight;
                });
            },
            send: (e) => {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                if(!input.value || !App.state.user) return;
                
                rtdb.ref('chats/' + App.state.user.uid).push({
                    text: input.value,
                    sender: 'user',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = '';
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>
</html>
