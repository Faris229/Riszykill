<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MathMate - ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Kanit:wght@300;400;600&display=swap');
        
        body { font-family: 'Kanit', sans-serif; background-color: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Display Screen */
        .calc-screen {
            font-family: 'JetBrains Mono', monospace;
            background: #1e293b;
            border-bottom: 2px solid #3b82f6;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* Buttons */
        .key-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 10px;
        }
        
        .btn-key {
            height: 50px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            cursor: pointer;
            user-select: none;
        }
        
        .btn-num { background: #334155; color: white; box-shadow: 0 4px 0 #1e293b; }
        .btn-num:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-op { background: #0f172a; color: #60a5fa; box-shadow: 0 4px 0 #020617; }
        .btn-op:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-fn { background: #475569; color: #fbbf24; font-size: 0.9rem; box-shadow: 0 4px 0 #1e293b; }
        .btn-fn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-eq { background: #2563eb; color: white; box-shadow: 0 4px 0 #1d4ed8; }
        .btn-eq:active { transform: translateY(4px); box-shadow: none; }

        .btn-del { background: #ef4444; color: white; box-shadow: 0 4px 0 #b91c1c; }
        .btn-del:active { transform: translateY(4px); box-shadow: none; }

        /* Tabs */
        .tab-btn { padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; transition: all 0.2s; }
        .tab-btn.active { background: #3b82f6; color: white; }
        .tab-btn:not(.active) { background: #1e293b; color: #94a3b8; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>

    <header class="h-14 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-4 z-20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white">M</div>
            <span class="font-bold text-lg text-blue-400">Math<span class="text-white">Mate</span></span>
        </div>
        <div id="auth-ui">
            <button onclick="Auth.modal()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="flex-1 flex flex-col max-w-md border-r border-slate-800 bg-slate-900 relative z-10">
            
            <div class="calc-screen h-40 p-4 flex flex-col justify-end text-right">
                <div id="history-preview" class="text-slate-500 text-sm mb-1 h-5 overflow-hidden"></div>
                <input id="input-math" type="text" class="bg-transparent border-none outline-none text-3xl w-full text-right text-white placeholder-slate-600" placeholder="0" readonly>
                <div id="result-preview" class="text-green-400 text-xl font-bold h-8 mt-1">= </div>
            </div>

            <div class="p-3 flex gap-2 overflow-x-auto bg-slate-900 border-b border-slate-800">
                <button class="tab-btn active" onclick="Keypad.switch('basic')">‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</button>
                <button class="tab-btn" onclick="Keypad.switch('trig')">‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏Ø</button>
                <button class="tab-btn" onclick="Keypad.switch('adv')">‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</button>
                <button class="tab-btn" onclick="Keypad.switch('graph')">‡∏Å‡∏£‡∏≤‡∏ü</button>
            </div>

            <div id="keypad-container" class="flex-1 bg-slate-900 p-2 overflow-y-auto">
                </div>
        </div>

        <div class="hidden md:flex flex-1 flex-col bg-slate-950 relative">
            
            <div class="flex border-b border-slate-800">
                <button onclick="SidePanel.show('history')" class="flex-1 p-3 text-sm font-bold text-slate-400 hover:bg-slate-900 hover:text-white border-r border-slate-800">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                <button onclick="SidePanel.show('chat')" class="flex-1 p-3 text-sm font-bold text-slate-400 hover:bg-slate-900 hover:text-white">üí¨ ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏£‡∏π (Chat)</button>
            </div>

            <div id="panel-history" class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-center text-slate-500 mt-10">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
            </div>

            <div id="panel-chat" class="hidden flex-1 flex flex-col h-full">
                <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                <form onsubmit="Chat.send(event)" class="p-3 bg-slate-900 border-t border-slate-800 flex gap-2">
                    <input id="chat-in" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500" placeholder="‡∏ñ‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏¢‡∏≤‡∏Å‡πÜ...">
                    <button class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center hover:bg-blue-500"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>

            <div id="graph-panel" class="absolute inset-0 bg-slate-900 z-50 hidden flex-col">
                <div class="p-2 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                    <span class="font-bold ml-2">üìä Graph Plotter</span>
                    <button onclick="document.getElementById('graph-panel').classList.add('hidden')" class="text-red-400 px-3"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="plot-area" class="flex-1 w-full h-full"></div>
            </div>

        </div>
    </div>

    <button onclick="document.querySelector('.md\\:flex').classList.toggle('hidden'); this.classList.toggle('bg-blue-600');" class="md:hidden fixed bottom-4 right-4 w-14 h-14 bg-slate-700 rounded-full shadow-xl flex items-center justify-center text-white z-50 border border-slate-600">
        <i class="fa-solid fa-layer-group"></i>
    </button>

    <div id="modal-auth" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö MathMate</h3>
            <input id="u-email" type="email" placeholder="Email" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 mb-3 text-white">
            <input id="u-pass" type="password" placeholder="Password" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 mb-6 text-white">
            <div class="flex gap-3">
                <button onclick="Auth.login()" class="flex-1 bg-blue-600 py-3 rounded-lg font-bold hover:bg-blue-500">Login</button>
                <button onclick="Auth.reg()" class="flex-1 bg-slate-700 py-3 rounded-lg font-bold hover:bg-slate-600">Register</button>
            </div>
            <button onclick="document.getElementById('modal-auth').classList.add('hidden')" class="w-full mt-4 text-xs text-slate-500">Close</button>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // STATE
        const App = {
            user: null,
            expression: '',
            mode: 'basic'
        };

        // --- 1. CALCULATOR LOGIC ---
        const Keypad = {
            layouts: {
                basic: [
                    ['C', 'DEL', '%', '/'],
                    ['7', '8', '9', '*'],
                    ['4', '5', '6', '-'],
                    ['1', '2', '3', '+'],
                    ['0', '.', '(', ')'],
                    ['ANS', 'EQ'] // EQ spans 2 cols
                ],
                trig: [
                    ['sin', 'cos', 'tan', 'deg'],
                    ['asin', 'acos', 'atan', 'rad'],
                    ['sinh', 'cosh', 'tanh', 'œÄ'],
                    ['7', '8', '9', '/'],
                    ['4', '5', '6', '*'],
                    ['1', '2', '3', '-'],
                    ['0', '.', 'EQ', '+']
                ],
                adv: [
                    ['log', 'ln', 'e', '^'],
                    ['sqrt', 'cbrt', 'abs', '!'],
                    ['7', '8', '9', '('],
                    ['4', '5', '6', ')'],
                    ['1', '2', '3', ','],
                    ['0', '.', 'EQ', 'mod']
                ]
            },
            
            switch: (mode) => {
                if(mode === 'graph') { Graph.plot(); return; }
                
                App.mode = mode;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active'); // Dirty fix for highlighting
                Keypad.render();
            },

            render: () => {
                const container = document.getElementById('keypad-container');
                container.innerHTML = '';
                
                // Flatten layout for grid
                const keys = Keypad.layouts[App.mode].flat();
                
                // Create Grid
                const grid = document.createElement('div');
                grid.className = 'key-grid';
                // Adjust columns based on mode
                grid.style.gridTemplateColumns = App.mode === 'basic' ? 'repeat(4, 1fr)' : 'repeat(4, 1fr)';

                keys.forEach(key => {
                    const btn = document.createElement('div');
                    btn.innerText = key;
                    btn.className = 'btn-key';
                    
                    // Style by type
                    if(['C','DEL'].includes(key)) btn.classList.add('btn-del');
                    else if(['EQ'].includes(key)) { btn.classList.add('btn-eq'); btn.style.gridColumn = 'span 2'; } // Make EQ wider in basic
                    else if(['+','-','*','/','^'].includes(key)) btn.classList.add('btn-op');
                    else if(!isNaN(key) || key === '.') btn.classList.add('btn-num');
                    else btn.classList.add('btn-fn');

                    btn.onclick = () => Calc.press(key);
                    grid.appendChild(btn);
                });
                container.appendChild(grid);
            }
        };

        const Calc = {
            press: (key) => {
                const inp = document.getElementById('input-math');
                const prev = document.getElementById('result-preview');

                if(key === 'C') { App.expression = ''; inp.value = ''; prev.innerText = '= '; return; }
                if(key === 'DEL') { App.expression = App.expression.slice(0, -1); }
                else if(key === 'EQ') { Calc.solve(); return; }
                else if(key === 'ANS') { App.expression += 'ans'; }
                else {
                    // Smart append
                    if(['sin','cos','tan','log','ln','sqrt'].includes(key)) App.expression += key + '(';
                    else App.expression += key;
                }

                inp.value = App.expression;
                // Live preview (Try solve silently)
                try {
                    const res = math.evaluate(App.expression);
                    prev.innerText = `= ${res}`;
                } catch(e) { prev.innerText = '= ...'; }
            },

            solve: () => {
                try {
                    const result = math.evaluate(App.expression);
                    document.getElementById('input-math').value = result;
                    document.getElementById('history-preview').innerText = App.expression + ' =';
                    
                    // Save to DB
                    if(App.user) {
                        db.collection('math_history').add({
                            uid: App.user.uid,
                            expr: App.expression,
                            res: result.toString(),
                            ts: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    App.expression = result.toString(); // Chain calculation
                } catch(e) {
                    Swal.fire({toast:true, icon:'error', title:'‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', position:'top'});
                }
            }
        };

        // --- 2. GRAPH SYSTEM ---
        const Graph = {
            plot: () => {
                const expr = document.getElementById('input-math').value;
                if(!expr || !expr.includes('x')) return Swal.fire('Info', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ x (‡πÄ‡∏ä‡πà‡∏ô sin(x), x^2)', 'info');
                
                document.getElementById('graph-panel').classList.remove('hidden');
                document.getElementById('graph-panel').classList.add('flex');

                try {
                    const compiled = math.compile(expr);
                    const xValues = math.range(-10, 10, 0.1).toArray();
                    const yValues = xValues.map(x => compiled.evaluate({x: x}));

                    const trace = { x: xValues, y: yValues, type: 'scatter', line: {color: '#3b82f6'} };
                    const layout = {
                        title: `y = ${expr}`,
                        paper_bgcolor: '#0f172a',
                        plot_bgcolor: '#1e293b',
                        font: { color: '#cbd5e1' },
                        xaxis: { gridcolor: '#334155' },
                        yaxis: { gridcolor: '#334155' }
                    };
                    
                    Plotly.newPlot('plot-area', [trace], layout, {responsive: true});
                } catch(e) {
                    Swal.fire('Graph Error', '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü', 'error');
                }
            }
        };

        // --- 3. SIDE PANEL (History & Chat) ---
        const SidePanel = {
            show: (tab) => {
                document.getElementById('panel-history').classList.add('hidden');
                document.getElementById('panel-chat').classList.add('hidden');
                document.getElementById(`panel-${tab}`).classList.remove('hidden');
                document.getElementById(`panel-${tab}`).classList.add('flex');
            }
        };

        // --- 4. AUTH & DB ---
        auth.onAuthStateChanged(u => {
            App.user = u;
            const ui = document.getElementById('auth-ui');
            if(u) {
                ui.innerHTML = `<div class="flex items-center gap-2"><span class="text-xs text-blue-300">${u.email.split('@')[0]}</span><button onclick="auth.signOut()" class="text-red-400"><i class="fa-solid fa-power-off"></i></button></div>`;
                document.getElementById('modal-auth').classList.add('hidden');
                LoadData.history();
                Chat.init(u.uid);
            } else {
                ui.innerHTML = `<button onclick="Auth.modal()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg text-xs font-bold transition">Login</button>`;
                document.getElementById('panel-history').innerHTML = '<div class="text-center text-slate-500 mt-10">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
            }
        });

        const Auth = {
            modal: () => document.getElementById('modal-auth').classList.remove('hidden'),
            login: () => {
                const e = document.getElementById('u-email').value;
                const p = document.getElementById('u-pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(err => Swal.fire('Error', err.message, 'error'));
            },
            reg: () => {
                const e = document.getElementById('u-email').value;
                const p = document.getElementById('u-pass').value;
                auth.createUserWithEmailAndPassword(e, p).catch(err => Swal.fire('Error', err.message, 'error'));
            }
        };

        const LoadData = {
            history: () => {
                db.collection('math_history').where('uid','==',App.user.uid).orderBy('ts','desc').limit(20).onSnapshot(snap => {
                    const div = document.getElementById('panel-history');
                    if(snap.empty) { div.innerHTML = '<div class="text-center text-slate-500 mt-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>'; return; }
                    div.innerHTML = snap.docs.map(d => `
                        <div class="bg-slate-900 p-3 rounded border border-slate-800 flex justify-between items-center hover:border-blue-500 cursor-pointer" onclick="document.getElementById('input-math').value='${d.data().expr}'; App.expression='${d.data().expr}';">
                            <div class="font-mono text-sm text-slate-300">${d.data().expr}</div>
                            <div class="font-bold text-green-400">= ${d.data().res}</div>
                        </div>
                    `).join('');
                });
            }
        };

        const Chat = {
            init: (uid) => {
                rtdb.ref('chats/'+uid).limitToLast(20).on('child_added', s => {
                    const m = s.val();
                    const me = m.sender === 'user';
                    const box = document.getElementById('chat-msgs');
                    box.innerHTML += `
                        <div class="flex ${me?'justify-end':'justify-start'}">
                            <div class="px-3 py-2 rounded-lg text-sm max-w-[80%] ${me?'bg-blue-600 text-white':'bg-slate-800 border border-slate-700'}">${m.text}</div>
                        </div>
                    `;
                    box.scrollTop = box.scrollHeight;
                });
            },
            send: (e) => {
                e.preventDefault();
                const inp = document.getElementById('chat-in');
                if(inp.value && App.user) {
                    rtdb.ref('chats/'+App.user.uid).push({text:inp.value, sender:'user', ts:Date.now()});
                    inp.value = '';
                }
            }
        };

        // Init
        Keypad.render();
        // Load intro plot
        // setTimeout(() => { document.getElementById('input-math').value = 'sin(x)'; Graph.plot(); }, 1000); // Demo
    </script>
</body>
</html>
