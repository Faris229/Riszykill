<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Stock (Private System)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-bg: #f8fafc; --primary-color: #4f46e5; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--primary-bg); color: #334155; padding-bottom: 60px; }
        
        .glass-card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); border: 1px solid #e2e8f0; }
        .btn-modern { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; color: white; padding: 10px 24px; border-radius: 50px; font-weight: 500; transition: 0.3s; }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); color: white; }
        
        .nav-profile-img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #e2e8f0; }
        .table-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; cursor: zoom-in; }
        .blur-text { filter: blur(4px); background: #f1f5f9; padding: 2px 8px; border-radius: 4px; transition: 0.2s; cursor: pointer; user-select: none; }
        .blur-text:hover { filter: blur(0); background: transparent; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top glass-card m-3 mt-2 px-3 py-2 hidden" id="mainNavbar">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-primary" href="#" onclick="window.scrollTo(0,0)"><i class="bi bi-controller me-2"></i><span id="navStoreName">MY SHOP</span></a>
    <div class="dropdown ms-auto">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
            <div class="text-end me-2 d-none d-sm-block">
                <div class="fw-bold small text-dark" id="navUserName">User</div>
                <div class="text-muted" style="font-size: 0.7rem;">Owner</div>
            </div>
            <img src="https://via.placeholder.com/40" id="navProfileImg" class="nav-profile-img">
        </a>
        <ul class="dropdown-menu dropdown-menu-end mt-3 border-0 shadow-lg rounded-4 overflow-hidden">
            <li><button class="dropdown-item py-2" onclick="openEditProfile()"><i class="bi bi-person-gear me-2"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button></li>
            <li><hr class="dropdown-divider my-0"></li>
            <li><button class="dropdown-item py-2 text-danger" onclick="confirmLogout()"><i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
        </ul>
    </div>
  </div>
</nav>

<div class="container" id="auth-section" style="padding-top: 15vh;">
    <div class="row justify-content-center">
        <div class="col-md-5 col-lg-4">
            <div class="glass-card p-4 p-md-5 text-center">
                <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex p-3 mb-3"><i class="bi bi-shop fs-1"></i></div>
                <h3 class="fw-bold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</h3>
                <ul class="nav nav-pills nav-fill mb-4 bg-light p-1 rounded-pill">
                    <li class="nav-item"><button class="nav-link active rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#login-tab">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></li>
                    <li class="nav-item"><button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#signup-tab">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button></li>
                </ul>
                <div class="tab-content text-start">
                    <div class="tab-pane fade show active" id="login-tab">
                        <input type="email" class="form-control rounded-pill mb-3" id="loginEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                        <input type="password" class="form-control rounded-pill mb-4" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                        <button class="btn btn-modern w-100" onclick="login()">Login</button>
                    </div>
                    <div class="tab-pane fade" id="signup-tab">
                        <input type="text" class="form-control rounded-pill mb-3" id="signupStore" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
                        <input type="email" class="form-control rounded-pill mb-3" id="signupEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                        <input type="password" class="form-control rounded-pill mb-4" id="signupPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                        <button class="btn btn-success w-100 rounded-pill fw-bold" onclick="signup()">Register</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container hidden" id="dashboard-section" style="padding-top: 100px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0"><i class="bi bi-grid-fill text-primary me-2"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h3>
        <button class="btn btn-modern shadow-sm" data-bs-toggle="modal" data-bs-target="#addItemModal"><i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>

    <div class="glass-card p-3 mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-3">
            <ul class="nav nav-pills bg-light p-1 rounded-pill">
                <li class="nav-item"><button class="nav-link active rounded-pill px-4 fw-bold" data-bs-toggle="tab" data-bs-target="#stock-pane">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å</button></li>
                <li class="nav-item"><button class="nav-link rounded-pill px-4 fw-bold text-secondary" data-bs-toggle="tab" data-bs-target="#history-pane">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></li>
            </ul>
            <input type="text" id="searchInput" class="form-control rounded-pill bg-light border-0" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="max-width: 250px;" onkeyup="searchTable('stockTable')">
        </div>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="stock-pane">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="stockTable">
                        <thead class="bg-light text-secondary small text-uppercase"><tr><th class="ps-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th><th class="text-end pe-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody class="bg-white"></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="history-pane">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="historyTable">
                        <thead class="bg-light text-secondary small text-uppercase"><tr><th class="ps-3">‡∏£‡∏´‡∏±‡∏™</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th><th>‡∏Å‡∏≥‡πÑ‡∏£</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead>
                        <tbody class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addItemModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <div class="text-center mb-3">
                    <label for="inpFile" class="d-block bg-light rounded-3 p-4 border-2 border-dashed cursor-pointer position-relative overflow-hidden" style="cursor: pointer;">
                         <img id="previewImg" class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover" style="display:none;">
                         <div id="uploadTxt" class="text-muted"><i class="bi bi-image fs-1"></i><br>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
                    </label>
                    <input type="file" id="inpFile" accept="image/*" class="d-none" onchange="handleImage(this)">
                </div>
                <div class="row g-2">
                    <div class="col-6"><input type="number" id="inpBuy" class="form-control" placeholder="‡∏ó‡∏∏‡∏ô"></div>
                    <div class="col-6"><input type="number" id="inpSell" class="form-control border-success" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢"></div>
                    <div class="col-12"><input type="text" id="inpGameEmail" class="form-control" placeholder="Email / ID"></div>
                    <div class="col-12"><input type="text" id="inpGamePass" class="form-control text-danger" placeholder="Password"></div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0"><button class="btn btn-modern w-100 rounded-pill" onclick="saveItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4 text-center">
                 <div class="position-relative d-inline-block mb-3" style="width:100px; height:100px;">
                    <img id="editProfilePreview" src="https://via.placeholder.com/100" class="w-100 h-100 rounded-circle object-fit-cover border shadow-sm">
                    <label for="profileUpload" class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-2 shadow-sm" style="cursor:pointer; width:32px; height:32px; display:flex; align-items:center; justify-content:center;"><i class="bi bi-camera-fill small"></i></label>
                    <input type="file" id="profileUpload" class="d-none" accept="image/*" onchange="handleProfileImage(this)">
                </div>
                <input type="text" id="editStoreName" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">
                <hr>
                <input type="password" id="editNewPass" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)">
            </div>
            <div class="modal-footer border-0 pt-0"><button class="btn btn-primary w-100 rounded-pill" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-rPvq9fFvhnYQCWxKtLf4Y3UK1uMnP0c",
    authDomain: "rssave-6169a.firebaseapp.com",
    projectId: "rssave-6169a",
    storageBucket: "rssave-6169a.firebasestorage.app",
    messagingSenderId: "619695253658",
    appId: "1:619695253658:web:2d1e3ccb1d5a3c08491723",
    measurementId: "G-1KHNKSTELW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let tempImg = "", tempProfileImg = "";

  // Auth Functions
  window.login = async () => {
    try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); }
    catch(e) { Swal.fire('Error', 'Email ‡∏´‡∏£‡∏∑‡∏≠ Password ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
  }
  window.signup = async () => {
    const name = document.getElementById('signupStore').value;
    if(!name) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô', 'warning');
    try {
        const cred = await createUserWithEmailAndPassword(auth, document.getElementById('signupEmail').value, document.getElementById('signupPassword').value);
        await updateProfile(cred.user, { displayName: name, photoURL: `https://ui-avatars.com/api/?name=${name}&background=random` });
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    } catch(e) { Swal.fire('Error', e.message, 'error'); }
  }
  window.confirmLogout = () => Swal.fire({ title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', showCancelButton: true, confirmButtonText: 'Yes' }).then((r) => { if(r.isConfirmed) signOut(auth); });

  // Profile Edit
  window.openEditProfile = () => {
      const u = auth.currentUser;
      document.getElementById('editStoreName').value = u.displayName;
      document.getElementById('editProfilePreview').src = u.photoURL;
      new bootstrap.Modal(document.getElementById('editProfileModal')).show();
  }
  window.saveProfile = async () => {
      const u = auth.currentUser;
      try {
          let updates = { displayName: document.getElementById('editStoreName').value };
          if(tempProfileImg) updates.photoURL = tempProfileImg; // Use Base64
          await updateProfile(u, updates);
          
          const newPass = document.getElementById('editNewPass').value;
          if(newPass) await updatePassword(u, newPass);
          
          Swal.fire('Updated!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success').then(()=>location.reload());
      } catch(e) { Swal.fire('Error', e.message, 'error'); }
  }

  // State Listener
  onAuthStateChanged(auth, (user) => {
      if(user) {
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('dashboard-section').classList.remove('hidden');
          document.getElementById('mainNavbar').classList.remove('hidden');
          
          document.getElementById('navStoreName').innerText = user.displayName || 'My Shop';
          document.getElementById('navUserName').innerText = user.displayName;
          document.getElementById('navProfileImg').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`;
          
          loadData(); // Load private data
      } else {
          document.getElementById('auth-section').classList.remove('hidden');
          document.getElementById('dashboard-section').classList.add('hidden');
          document.getElementById('mainNavbar').classList.add('hidden');
      }
  });

  // --- CRUD Logic (Private Data) ---
  
  // 1. Generate Auto ID (Scoped to User)
  async function generateAutoID(prefix) {
      // ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const q = query(collection(db, "products"), where("ownerId", "==", auth.currentUser.uid)); 
      const snap = await getDocs(q);
      let maxNum = 0;
      snap.forEach(d => {
          const code = d.data().code; // ex: RD005
          if(code.startsWith(prefix)) {
              const num = parseInt(code.replace(prefix, ""));
              if(!isNaN(num) && num > maxNum) maxNum = num;
          }
      });
      return prefix + String(maxNum + 1).padStart(3, '0');
  }

  // 2. Add Item
  window.saveItem = async () => {
      const buy = document.getElementById('inpBuy').value;
      const sell = document.getElementById('inpSell').value;
      const user = auth.currentUser;
      
      if(!buy || !sell) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤', 'warning');
      
      const prefix = user.displayName ? user.displayName.substring(0,2).toUpperCase() : "RS";
      const newCode = await generateAutoID(prefix);

      try {
          await addDoc(collection(db, "products"), {
              ownerId: user.uid, // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
              code: newCode,
              buyPrice: Number(buy),
              sellPrice: Number(sell),
              gameEmail: document.getElementById('inpGameEmail').value || "-",
              gamePass: document.getElementById('inpGamePass').value || "-",
              imageUrl: tempImg || "https://via.placeholder.com/150",
              status: "available",
              createdAt: Timestamp.now(),
              soldAt: null
          });
          
          bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
          Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™ ${newCode} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
          loadData();
          
          // Clear form
          document.getElementById('inpBuy').value = '';
          document.getElementById('inpSell').value = '';
          document.getElementById('inpGameEmail').value = '';
          document.getElementById('inpGamePass').value = '';
          document.getElementById('previewImg').style.display = 'none';
          document.getElementById('uploadTxt').style.display = 'block';
          tempImg = "";

      } catch(e) { Swal.fire('Error', e.message, 'error'); }
  }

  // 3. Load Data (Private)
  async function loadData() {
      const user = auth.currentUser;
      if(!user) return;

      // Load Stock
      const qStock = query(collection(db, "products"), where("ownerId", "==", user.uid), where("status", "==", "available"));
      const snapStock = await getDocs(qStock);
      renderTable('stockTable', snapStock.docs, true);

      // Load History
      const qHist = query(collection(db, "products"), where("ownerId", "==", user.uid), where("status", "==", "sold"));
      const snapHist = await getDocs(qHist);
      renderTable('historyTable', snapHist.docs, false);
  }

  function renderTable(id, docs, isStock) {
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = "";
      
      // Sort in JS
      let data = docs.map(d => ({id: d.id, ...d.data()}));
      data.sort((a,b) => isStock ? b.createdAt - a.createdAt : b.soldAt - a.soldAt);

      if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

      data.forEach(d => {
          let row = "";
          if(isStock) {
              row = `<tr>
                  <td class="ps-3 py-3"><div class="d-flex align-items-center"><img src="${d.imageUrl}" class="table-img me-3" onclick="window.open('${d.imageUrl}')"><div><div class="fw-bold">${d.code}</div><small class="text-muted">${d.gameEmail}</small></div></div></td>
                  <td class="fw-bold text-success">${d.sellPrice.toLocaleString()}</td>
                  <td><span class="blur-text">${d.gamePass}</span></td>
                  <td class="text-end pe-3"><button class="btn btn-warning btn-sm rounded-pill px-3 shadow-sm" onclick="markSold('${d.id}')">‡∏Ç‡∏≤‡∏¢</button></td>
              </tr>`;
          } else {
              const profit = d.sellPrice - d.buyPrice;
              const date = d.soldAt ? d.soldAt.toDate().toLocaleDateString('th-TH') : '-';
              row = `<tr>
                  <td class="ps-3 py-3 fw-bold text-secondary">${d.code}</td>
                  <td>${d.sellPrice.toLocaleString()}</td>
                  <td class="${profit >= 0 ? 'text-success':'text-danger'} fw-bold">${profit >= 0 ? '+':''}${profit.toLocaleString()}</td>
                  <td class="text-muted small">${date}</td>
              </tr>`;
          }
          tbody.innerHTML += row;
      });
  }

  window.markSold = async (id) => {
      Swal.fire({ title: '‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?', showCancelButton: true, confirmButtonText: '‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ', confirmButtonColor: '#198754' }).then(async(r) => {
          if(r.isConfirmed) {
              await updateDoc(doc(db, "products", id), { status: "sold", soldAt: Timestamp.now() });
              loadData();
              Swal.fire('‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', '', 'success');
          }
      });
  }

  // --- Image Handling Helpers ---
  window.handleImage = (input) => processImage(input, (res) => { 
      tempImg = res; 
      document.getElementById('previewImg').src = res; 
      document.getElementById('previewImg').style.display = 'block'; 
      document.getElementById('uploadTxt').style.display = 'none'; 
  });
  
  window.handleProfileImage = (input) => processImage(input, (res) => {
      tempProfileImg = res;
      document.getElementById('editProfilePreview').src = res;
  });

  function processImage(input, callback) {
      if(input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => {
              const img = new Image();
              img.src = e.target.result;
              img.onload = () => {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  const scale = 500 / img.width;
                  canvas.width = 500; canvas.height = img.height * scale;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  callback(canvas.toDataURL('image/jpeg', 0.8));
              }
          };
          reader.readAsDataURL(input.files[0]);
      }
  }
  
  window.searchTable = (id) => {
      const val = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll(`#${id} tbody tr`).forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
  }

  document.querySelector('.hidden').style.display = 'none';
</script>
</body>
</html>
