<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer App</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root { --primary: #ff4757; --bg: #f8f9fa; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        .card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0; border-top: 1px solid #eee; }
        .nav-item { flex: 1; text-align: center; color: #aaa; font-size: 0.8rem; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .wallet-card { background: linear-gradient(45deg, #ff6b6b, #ff4757); color: white; padding: 20px; border-radius: 20px; margin: 20px; text-align: center; }
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="color:var(--primary); text-align:center;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ FoodRunner</h1>
    <input id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
    <input id="pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
    <button class="btn" onclick="authFunc('login')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <button class="btn" style="background:none; color:#555; margin-top:10px;" onclick="regPopup()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
</div>

<div id="app" style="display:none;">
    <div class="wallet-card">
        <div>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
        <div style="font-size:2.5rem; font-weight:800;">‡∏ø <span id="bal">0.00</span></div>
        <button onclick="deposit()" style="background:rgba(255,255,255,0.2); border:none; padding:5px 15px; color:white; border-radius:15px; margin-top:10px;">+ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
    </div>

    <div style="padding:0 20px;">
        <h3>‡πÄ‡∏°‡∏ô‡∏π</h3>
        <div class="card" onclick="orderPopup()" style="display:flex; align-items:center; gap:15px; cursor:pointer;">
            <div style="width:50px; height:50px; background:#ffeaa7; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:1.5rem;">üçú</div>
            <div><b>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡∏ù‡∏≤‡∏Å‡∏ã‡∏∑‡πâ‡∏≠</b><br><small style="color:#888">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</small></div>
        </div>

        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        <div id="order-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <div class="nav">
        <div class="nav-item active"><i class="fa-solid fa-house" style="font-size:1.5rem"></i><br>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
        <div class="nav-item" onclick="firebase.auth().signOut()"><i class="fa-solid fa-right-from-bracket" style="font-size:1.5rem"></i><br>‡∏≠‡∏≠‡∏Å</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // ‚úÖ Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const config = {
        apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
        authDomain: "chat-27f96.firebaseapp.com",
        databaseURL: "https://chat-27f96-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chat-27f96",
        storageBucket: "chat-27f96.firebasestorage.app",
        messagingSenderId: "336686938010",
        appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth(), db = firebase.firestore();
    let uid = null;

    auth.onAuthStateChanged(u => {
        if(u) { uid=u.uid; document.getElementById('auth-screen').style.display='none'; document.getElementById('app').style.display='block'; init(); }
        else { document.getElementById('auth-screen').style.display='flex'; }
    });

    async function authFunc(type) {
        try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value); }
        catch(err){ Swal.fire('Error',err.message,'error'); }
    }

    async function regPopup() {
        const {value:f} = await Swal.fire({title:'‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', html:'<input id="r-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"><input id="r-tel" class="swal2-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">', focusConfirm:false, preConfirm:()=>[document.getElementById('r-name').value, document.getElementById('r-tel').value]});
        if(f) {
            try {
                const c = await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value);
                await db.collection('users').doc(c.user.uid).set({username:f[0], phone:f[1], role:'customer', balance:0});
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢','success');
            } catch(er){ Swal.fire('Error',er.message,'error'); }
        }
    }

    function init() {
        db.collection('users').doc(uid).onSnapshot(d => { if(d.exists) document.getElementById('bal').innerText = d.data().balance.toFixed(2); });
        
        db.collection('orders').where('buyerId','==',uid).onSnapshot(snap => {
            const list = [];
            snap.forEach(d => list.push({id:d.id, ...d.data()}));
            list.sort((a,b) => b.timestamp - a.timestamp);

            let h = '';
            list.forEach(o => {
                let btn = '';
                if(o.status === 'delivering') btn = `<button onclick="finish('${o.id}')" style="width:100%; margin-top:10px; background:#2ed573; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</button>`;
                h += `<div class="card" style="border-left:5px solid ${o.status==='completed'?'grey':'#ff4757'}">
                    <div style="display:flex; justify-content:space-between;"><b>${o.menu}</b> <span>${o.status}</span></div>
                    <small>${o.address}</small><br>
                    ‡∏£‡∏ß‡∏°: <b>${o.price+o.tip} ‡∏ø</b> (${o.payment})
                    ${btn}
                </div>`;
            });
            document.getElementById('order-list').innerHTML = h || '<p style="text-align:center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
        });
    }

    async function orderPopup() {
        const {value:f} = await Swal.fire({title:'‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', html:
            '<input id="o-menu" class="swal2-input" placeholder="‡πÄ‡∏°‡∏ô‡∏π">' +
            '<input id="o-price" type="number" class="swal2-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£">' +
            '<input id="o-tip" type="number" class="swal2-input" placeholder="‡∏Ñ‡πà‡∏≤‡∏´‡∏¥‡πâ‡∏ß">' +
            '<input id="o-addr" class="swal2-input" placeholder="‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á">' +
            '<select id="o-pay" class="swal2-input"><option value="wallet">Wallet</option><option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option></select>',
            focusConfirm:false, preConfirm:()=>[
                document.getElementById('o-menu').value, document.getElementById('o-price').value,
                document.getElementById('o-tip').value, document.getElementById('o-addr').value, document.getElementById('o-pay').value
            ]
        });
        if(f) {
            const total = parseFloat(f[1])+parseFloat(f[2]);
            if(f[4]==='wallet') {
                const u = await db.collection('users').doc(uid).get();
                if(u.data().balance < total) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','','error');
            }
            await db.collection('orders').add({buyerId:uid, menu:f[0], price:parseFloat(f[1]), tip:parseFloat(f[2]), address:f[3], payment:f[4], status:'pending', timestamp: Date.now()});
            Swal.fire('‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß','','success');
        }
    }

    async function finish(oid) {
        const o = (await db.collection('orders').doc(oid).get()).data();
        if(o.payment === 'wallet') {
            await db.runTransaction(async t => {
                const bRef = db.collection('users').doc(uid);
                const rRef = db.collection('users').doc(o.riderId);
                const total = o.price + o.tip;
                t.update(bRef, {balance: (await t.get(bRef)).data().balance - total});
                t.update(rRef, {balance: (await t.get(rRef)).data().balance + total});
                t.update(db.collection('orders').doc(oid), {status:'completed'});
            });
        } else {
            await db.collection('orders').doc(oid).update({status:'completed'});
        }
        Swal.fire('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô','','success');
    }

    async function deposit() {
        const {value:n} = await Swal.fire({title:'‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô', input:'number'});
        if(n) { await db.collection('transactions').add({uid, type:'deposit', amount:parseFloat(n), status:'pending'}); Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß','‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','success'); }
    }
</script>
</body>
</html>
